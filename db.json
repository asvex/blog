{"meta":{"version":1,"warehouse":"4.0.1"},"models":{"Asset":[{"_id":"node_modules/hexo-theme-stellar/source/css/main.styl","path":"css/main.styl","modified":1,"renderable":1},{"_id":"node_modules/hexo-theme-stellar/source/js/main.js","path":"js/main.js","modified":1,"renderable":1},{"_id":"node_modules/hexo-theme-stellar/source/js/plugins/friends.js","path":"js/plugins/friends.js","modified":1,"renderable":1},{"_id":"node_modules/hexo-theme-stellar/source/js/plugins/sites.js","path":"js/plugins/sites.js","modified":1,"renderable":1}],"Cache":[{"_id":"source/_posts/k8s-containerd.md","hash":"1f4a802ae3a04e79ff0d5c00149189f5dd9ce900","modified":1650083108281},{"_id":"source/about/index.md","hash":"ab67de4e917388dc65045fb04ddfa3286fb46e2e","modified":1650079893604},{"_id":"source/notes/index.md","hash":"abc1a7bb21e84a299cbba2ec620ded2946d2f463","modified":1650079897924},{"_id":"node_modules/hexo-theme-stellar/LICENSE","hash":"7fdfdb5dbc7d672fa28a2a3c9efa03ff8df5917d","modified":499162500000},{"_id":"node_modules/hexo-theme-stellar/README.md","hash":"c763b5974044065a898684c0657fdbc58c18bcf1","modified":499162500000},{"_id":"node_modules/hexo-theme-stellar/_config.yml","hash":"c5ed9ca30dd8eafa11708484a914dfc537bb5732","modified":1650080690167},{"_id":"node_modules/hexo-theme-stellar/package.json","hash":"f6f7b3f2a033dcd5ca9026f4fd7292ee55e189f5","modified":1650078620187},{"_id":"node_modules/hexo-theme-stellar/languages/en.yml","hash":"03ba9715f7aff6cd20d22d35d99880092f79043d","modified":499162500000},{"_id":"node_modules/hexo-theme-stellar/languages/zh-CN.yml","hash":"c8f22d5045bb98e457c74d45d6affa65ab97d774","modified":499162500000},{"_id":"node_modules/hexo-theme-stellar/languages/zh-TW.yml","hash":"f45f224d30eeaf30b0a78d2b6e6e6c9e2005d3f5","modified":499162500000},{"_id":"node_modules/hexo-theme-stellar/layout/404.ejs","hash":"502f767873cd62b36f857ddccec9004e05867bc4","modified":499162500000},{"_id":"node_modules/hexo-theme-stellar/layout/archive.ejs","hash":"ef91a073521dab22fcd191b1970982e7a836d698","modified":499162500000},{"_id":"node_modules/hexo-theme-stellar/layout/categories.ejs","hash":"ce50c1d35dd2f5dfe190b5d70755cdb43e26c522","modified":499162500000},{"_id":"node_modules/hexo-theme-stellar/layout/index.ejs","hash":"d59bc25174ea15db99e2763bcb938ecf20808d93","modified":499162500000},{"_id":"node_modules/hexo-theme-stellar/layout/layout.ejs","hash":"6ea432c18cdc9d19433bd9bc70380cc58f42f20a","modified":499162500000},{"_id":"node_modules/hexo-theme-stellar/layout/page.ejs","hash":"90170dbc9ed8ffdaa9e02d2c246cdb8cc3f093ec","modified":499162500000},{"_id":"node_modules/hexo-theme-stellar/layout/post.ejs","hash":"cb3e01686c49e1bf9e98f1aeafd4b043b8b9913a","modified":499162500000},{"_id":"node_modules/hexo-theme-stellar/layout/tags.ejs","hash":"0307bf728c1f64e83808fcccd20336f83fb9dc28","modified":499162500000},{"_id":"node_modules/hexo-theme-stellar/layout/wiki.ejs","hash":"e8735f5b96cc08d0eb950553d16ee092ac538607","modified":499162500000},{"_id":"node_modules/hexo-theme-stellar/layout/_partial/head.ejs","hash":"981849b7b705725c82940e2c90602e244eb9b4e4","modified":499162500000},{"_id":"node_modules/hexo-theme-stellar/layout/_partial/menubtn.ejs","hash":"1ebd3fa9b1586078e8726e58b8ed1b096b8f0524","modified":499162500000},{"_id":"node_modules/hexo-theme-stellar/scripts/events/index.js","hash":"a3d83e2577ff159c3d70ff345b690faae6c3147d","modified":499162500000},{"_id":"node_modules/hexo-theme-stellar/scripts/filters/index.js","hash":"5667f028990dd556133080090a5fcb00c64f05ac","modified":499162500000},{"_id":"node_modules/hexo-theme-stellar/scripts/generators/404.js","hash":"294c2e12ebc858cb47363626e5c6edcf4a5d67fa","modified":499162500000},{"_id":"node_modules/hexo-theme-stellar/scripts/generators/categories.js","hash":"37a443389795bf9047ab530e6111a5dde8567db5","modified":499162500000},{"_id":"node_modules/hexo-theme-stellar/scripts/generators/tags.js","hash":"9f9421ec4dc85e2bb8c3a376d4eb1c7c59d3b211","modified":499162500000},{"_id":"node_modules/hexo-theme-stellar/scripts/generators/wiki.js","hash":"7ced88545f9a857098e3ac28de3ff82f141228d1","modified":499162500000},{"_id":"node_modules/hexo-theme-stellar/scripts/helpers/category_color.js","hash":"35f459e5dcd845eef3d9b7a6205f015b92399d24","modified":499162500000},{"_id":"node_modules/hexo-theme-stellar/scripts/helpers/parse_config.js","hash":"c9712de293586ca529b9df8789b79e561acf85a9","modified":499162500000},{"_id":"node_modules/hexo-theme-stellar/scripts/helpers/scrollreveal.js","hash":"aecbaf28dfafe100bca014381e3f6e8f799da4d1","modified":499162500000},{"_id":"node_modules/hexo-theme-stellar/scripts/helpers/related_posts.js","hash":"634586f26c980f73ee0918f2eed6b2e185541dcd","modified":499162500000},{"_id":"node_modules/hexo-theme-stellar/scripts/helpers/stellar_info.js","hash":"5b7a10c8b09237a467767f5467749c7d9378c2c1","modified":499162500000},{"_id":"node_modules/hexo-theme-stellar/scripts/tags/about.js","hash":"acd4cfea4ca8d3203c76afbb8752b50b0b9f5904","modified":499162500000},{"_id":"node_modules/hexo-theme-stellar/scripts/tags/checkbox.js","hash":"85a0f422a338cb5fa5c70ef30c93da95ef5ebbcf","modified":499162500000},{"_id":"node_modules/hexo-theme-stellar/scripts/tags/copy.js","hash":"4c57d903d724ccea72cf17293de08f297f0d6a86","modified":499162500000},{"_id":"node_modules/hexo-theme-stellar/scripts/tags/emoji.js","hash":"7bd4b538fe1aa622a9dc03047942cc024f9e0d69","modified":499162500000},{"_id":"node_modules/hexo-theme-stellar/scripts/tags/folding.js","hash":"c3ea8c7271ade7522ef6c3f9b538a92972f51fde","modified":499162500000},{"_id":"node_modules/hexo-theme-stellar/scripts/tags/frame.js","hash":"6eba9dab0fde8908234df632b85efa6a312e7bf3","modified":499162500000},{"_id":"node_modules/hexo-theme-stellar/scripts/tags/friends.js","hash":"ccf65b699d1c1767703809a3db652fe47953de6b","modified":499162500000},{"_id":"node_modules/hexo-theme-stellar/scripts/tags/ghcard.js","hash":"33d6d41ba4e01232eb72915b5b17fb0ed44f899c","modified":499162500000},{"_id":"node_modules/hexo-theme-stellar/scripts/tags/image.js","hash":"22aafb984b796c3e3d120990529ebd5c9859de78","modified":499162500000},{"_id":"node_modules/hexo-theme-stellar/scripts/tags/index.js","hash":"eef64269ad7d7519fb3563f0118faff135760a2f","modified":499162500000},{"_id":"node_modules/hexo-theme-stellar/scripts/tags/inline-labels.js","hash":"a9805af165a1ee44fd7f9dbb89c9d0744a4a9543","modified":499162500000},{"_id":"node_modules/hexo-theme-stellar/scripts/tags/issues.js","hash":"2028247a41e8427755b0007a6cf629f9f094f233","modified":499162500000},{"_id":"node_modules/hexo-theme-stellar/scripts/tags/link.js","hash":"667f31427c267424188252701619ad6005f684c6","modified":499162500000},{"_id":"node_modules/hexo-theme-stellar/scripts/tags/mark.js","hash":"bf4c9d7af4ec1e72af0aa6c7214777af4366d6c2","modified":499162500000},{"_id":"node_modules/hexo-theme-stellar/scripts/tags/navbar.js","hash":"b467cc597b4ceeaecbbd67e73da38bbf782bb4a4","modified":499162500000},{"_id":"node_modules/hexo-theme-stellar/scripts/tags/note.js","hash":"11de602c2101bd1acf7e08fc7f6c95eb96159d38","modified":499162500000},{"_id":"node_modules/hexo-theme-stellar/scripts/tags/poetry.js","hash":"21c44b888c8c110a3c879d904918f33e613ca33c","modified":499162500000},{"_id":"node_modules/hexo-theme-stellar/scripts/tags/quot.js","hash":"bc8349dbd2c6027c3abc38082e58a17872557522","modified":499162500000},{"_id":"node_modules/hexo-theme-stellar/scripts/tags/site.js","hash":"5d32da930d4b10338386c20ca7e3414803954a1c","modified":499162500000},{"_id":"node_modules/hexo-theme-stellar/scripts/tags/swiper.js","hash":"dcecff446269b9553d280778640ff434391bfe9b","modified":499162500000},{"_id":"node_modules/hexo-theme-stellar/scripts/tags/timeline.js","hash":"601d8480fc9b74de338810a156ff804995baef01","modified":499162500000},{"_id":"node_modules/hexo-theme-stellar/scripts/tags/toc.js","hash":"3da29a1a2cfc2894a16d4081b771071afe1b44d7","modified":499162500000},{"_id":"node_modules/hexo-theme-stellar/source/css/_custom.styl","hash":"6f8897910b05ec645fa2ee9c9094f58c45dfc44a","modified":499162500000},{"_id":"node_modules/hexo-theme-stellar/source/css/main.styl","hash":"28f7f6f69ed6aa3083784c0f4c1b17955dc5924e","modified":499162500000},{"_id":"node_modules/hexo-theme-stellar/source/js/main.js","hash":"34adcfadc95c9b6599cc617b2902dae369ed4d64","modified":499162500000},{"_id":"node_modules/hexo-theme-stellar/layout/_partial/cover/index.ejs","hash":"e9fbadca8e27b334f691d5fe79a377041609073a","modified":499162500000},{"_id":"node_modules/hexo-theme-stellar/layout/_partial/cover/wiki_cover.ejs","hash":"936457597273e216b93bc60851d75fbbd1b0357f","modified":499162500000},{"_id":"node_modules/hexo-theme-stellar/layout/_partial/cover/post_cover.ejs","hash":"9cd16a4cf004dfc0f06011ddb3426f6d3c3b9637","modified":499162500000},{"_id":"node_modules/hexo-theme-stellar/layout/_partial/main/footer.ejs","hash":"1a961030aa0d0f4482262d4e9294746b3b853f8d","modified":499162500000},{"_id":"node_modules/hexo-theme-stellar/layout/_partial/scripts/index.ejs","hash":"9d50f9ce7fb116a88fef061249c30504bee09eb4","modified":499162500000},{"_id":"node_modules/hexo-theme-stellar/layout/_partial/sidebar/index.ejs","hash":"cc11d49ef5129235503c43cab0dc2d578a5a742a","modified":499162500000},{"_id":"node_modules/hexo-theme-stellar/layout/_partial/sidebar/logo.ejs","hash":"58e2860ef80d1dce8626b4d946276694074d7f6c","modified":499162500000},{"_id":"node_modules/hexo-theme-stellar/layout/_partial/sidebar/header.ejs","hash":"5501c958e7c21ec7d4f84c8b2bf0a7cab2410261","modified":499162500000},{"_id":"node_modules/hexo-theme-stellar/scripts/events/lib/config.js","hash":"bd1c141abf95e8e71da787f98eca1612c4430b12","modified":499162500000},{"_id":"node_modules/hexo-theme-stellar/scripts/events/lib/doc_tree.js","hash":"0e3ec084f289b9a24d752cad65549ec2f7971580","modified":499162500000},{"_id":"node_modules/hexo-theme-stellar/scripts/events/lib/utils.js","hash":"2c342ae9ada7275beb6eaf51d010ee1cccf1033d","modified":499162500000},{"_id":"node_modules/hexo-theme-stellar/scripts/filters/lib/img_lazyload.js","hash":"b3dedcc1fc4189589e63d4fa6f169a70e9d63cd1","modified":499162500000},{"_id":"node_modules/hexo-theme-stellar/scripts/filters/lib/img_onerror.js","hash":"d44a8e20d4d537c0cf85b980e1fc3bc84865a2d3","modified":499162500000},{"_id":"node_modules/hexo-theme-stellar/scripts/tags/lib/tabs.js","hash":"9931f1f6a4ecc70fbbbc9f0aa74b07fbeeaf2779","modified":499162500000},{"_id":"node_modules/hexo-theme-stellar/source/css/_common/base.styl","hash":"5a0aa29da6cb2bdaa9821add153c10f33498e4c8","modified":499162500000},{"_id":"node_modules/hexo-theme-stellar/source/css/_common/blur.styl","hash":"61d3ac4c5bebe9aa9255e6714687f82b3fe54ab9","modified":499162500000},{"_id":"node_modules/hexo-theme-stellar/source/css/_common/button.styl","hash":"77c7f52e169f859da711295e2c065f75f1b68670","modified":499162500000},{"_id":"node_modules/hexo-theme-stellar/source/css/_common/cap.styl","hash":"41d81510d3781bf938987265ebd6b6fdaeac027c","modified":499162500000},{"_id":"node_modules/hexo-theme-stellar/source/css/_common/control.styl","hash":"75081ca9d522a76ec4acffb8111c918b2297650a","modified":499162500000},{"_id":"node_modules/hexo-theme-stellar/source/css/_common/device.styl","hash":"1a717eae77b3a6000bd9c1a92c4ba063d9cf597b","modified":499162500000},{"_id":"node_modules/hexo-theme-stellar/source/css/_common/highlight.styl","hash":"4533ea4f9f1621ba96fb6da78e230dd951d3dac2","modified":499162500000},{"_id":"node_modules/hexo-theme-stellar/source/css/_common/html.styl","hash":"ee269663e78c1409169f7fb1b11865cd3bab0c78","modified":499162500000},{"_id":"node_modules/hexo-theme-stellar/source/css/_common/image.styl","hash":"cca1103a9185202b13be49e16d77d259e9ffb482","modified":499162500000},{"_id":"node_modules/hexo-theme-stellar/source/css/_common/input.styl","hash":"2a765355617dd96c5974e7872c34eabc0052ed6f","modified":499162500000},{"_id":"node_modules/hexo-theme-stellar/source/css/_common/loading.styl","hash":"e05f621d367cd2b19c5f4c629f5213fbf3f39343","modified":499162500000},{"_id":"node_modules/hexo-theme-stellar/source/css/_common/span.styl","hash":"78cf1b0b82fd60234e1f352501c3a27d1fe3be6b","modified":499162500000},{"_id":"node_modules/hexo-theme-stellar/source/css/_common/svg.styl","hash":"dd2fbe25de3e3cf475279d375e0d5e925f9058ea","modified":499162500000},{"_id":"node_modules/hexo-theme-stellar/source/css/_common/title.styl","hash":"013b4c29a462e0068ecfafd742dead48c6d02719","modified":499162500000},{"_id":"node_modules/hexo-theme-stellar/source/css/_common/toast.styl","hash":"61ca6b42ded511bcc99fd684800bf84c5ab9454a","modified":499162500000},{"_id":"node_modules/hexo-theme-stellar/source/css/_defines/const.styl","hash":"1fc5588e6eeff7af7fcf4be3ba9be43cca7c1b6a","modified":499162500000},{"_id":"node_modules/hexo-theme-stellar/source/css/_defines/func.styl","hash":"2f4a239ec8c57957d766c0eb06e23de690f9fd78","modified":499162500000},{"_id":"node_modules/hexo-theme-stellar/source/css/_defines/theme.styl","hash":"a3cc2ba90732a1a5f891939dbd9a6a3c6435bff1","modified":499162500000},{"_id":"node_modules/hexo-theme-stellar/source/css/_layout/index.styl","hash":"388efb67ba82dc257f142281759519c69aba86ce","modified":499162500000},{"_id":"node_modules/hexo-theme-stellar/source/css/_layout/layout.styl","hash":"d5308f5446dbbec10b53365b7091181a1755f022","modified":499162500000},{"_id":"node_modules/hexo-theme-stellar/source/css/_layout/list.styl","hash":"fa4b3ba7c1c9e2f70993c3667031e1ae9695b7e2","modified":499162500000},{"_id":"node_modules/hexo-theme-stellar/source/css/_layout/main.styl","hash":"0d6387d09fe508e1c4c2647a0259f15e4bdb2d29","modified":499162500000},{"_id":"node_modules/hexo-theme-stellar/source/css/_layout/md.styl","hash":"56c79b1fafd1e9f9bd5d02ccad9715bd8c755db8","modified":499162500000},{"_id":"node_modules/hexo-theme-stellar/source/css/_plugins/fancybox.styl","hash":"21fabc8af9fe193d8376ecc8bd9125207f51e927","modified":499162500000},{"_id":"node_modules/hexo-theme-stellar/source/css/_plugins/index.styl","hash":"5d1587f9ea0f0fcd7cc40388983dfe6a34fc2114","modified":499162500000},{"_id":"node_modules/hexo-theme-stellar/source/css/_plugins/lazyload.styl","hash":"44f231219c10397af1aa353c4d7b7e0e34323b40","modified":499162500000},{"_id":"node_modules/hexo-theme-stellar/source/css/_plugins/scrollreveal.styl","hash":"bfeabad9cdaaa77ea0fa1fc0f20dc91520356a6f","modified":499162500000},{"_id":"node_modules/hexo-theme-stellar/source/css/_plugins/swiper.styl","hash":"4cda902a8a3855d5aa0e644aa674e053db824023","modified":499162500000},{"_id":"node_modules/hexo-theme-stellar/source/js/plugins/friends.js","hash":"9815baf1e18d7cc2c8cb0623ce032a584cb2d40a","modified":499162500000},{"_id":"node_modules/hexo-theme-stellar/source/js/plugins/sites.js","hash":"dff454cd2bc34b718692dc4e941976311c73f670","modified":499162500000},{"_id":"node_modules/hexo-theme-stellar/layout/_partial/main/article/article_footer.ejs","hash":"77e80d3873754c4d9bfd8e428eb0f396563e7fe6","modified":499162500000},{"_id":"node_modules/hexo-theme-stellar/layout/_partial/main/article/read_next.ejs","hash":"5ee4950726054240725338983911a32539536fab","modified":499162500000},{"_id":"node_modules/hexo-theme-stellar/layout/_partial/main/article/related_posts.ejs","hash":"3dc3edaaa099ffaf8d2f099f76441d6a7a0931de","modified":499162500000},{"_id":"node_modules/hexo-theme-stellar/layout/_partial/main/header/index.ejs","hash":"bf1d8a6979daf4339e5452be1a2d23a152b44729","modified":499162500000},{"_id":"node_modules/hexo-theme-stellar/layout/_partial/main/navbar/breadcrumb.ejs","hash":"6c2436c0e862987438e8774ed7125ea9c36f724f","modified":499162500000},{"_id":"node_modules/hexo-theme-stellar/layout/_partial/main/navbar/list_post.ejs","hash":"7061ddc45c81a3c2fbc2f0376f2b1203d3835248","modified":499162500000},{"_id":"node_modules/hexo-theme-stellar/layout/_partial/main/navbar/list_wiki.ejs","hash":"a6e53d22caa72809e34b664a32293a4ca289825f","modified":499162500000},{"_id":"node_modules/hexo-theme-stellar/layout/_partial/main/post_list/paginator.ejs","hash":"285c00bd0a97b9ff2c0daf30eee20739eb64d2c8","modified":499162500000},{"_id":"node_modules/hexo-theme-stellar/layout/_partial/main/post_list/post_card.ejs","hash":"f87e8a70f03cba5bcee0c72594463eb2e7107fe5","modified":499162500000},{"_id":"node_modules/hexo-theme-stellar/layout/_partial/main/post_list/wiki_card.ejs","hash":"da55fe3e3df31d03c261f7c476ca90113c12366c","modified":499162500000},{"_id":"node_modules/hexo-theme-stellar/layout/_partial/plugins/comments/layout.ejs","hash":"45a68578a0d9c8edb02e4c4933cb271c4846d6b0","modified":499162500000},{"_id":"node_modules/hexo-theme-stellar/layout/_partial/plugins/comments/script.ejs","hash":"a9dce8066723ada71d91960d5dd07ab194cc3b05","modified":499162500000},{"_id":"node_modules/hexo-theme-stellar/layout/_partial/sidebar/widgets/markdown.ejs","hash":"520e2d08821f1086faa0099af68a18190f5562ea","modified":499162500000},{"_id":"node_modules/hexo-theme-stellar/layout/_partial/sidebar/widgets/recent.ejs","hash":"845bc74d6bdcac98f43080bbae9c252dd83506fa","modified":499162500000},{"_id":"node_modules/hexo-theme-stellar/layout/_partial/sidebar/widgets/repo_info.ejs","hash":"961ef0e0c0e216b80ee03a686ad69a7307edbfd7","modified":499162500000},{"_id":"node_modules/hexo-theme-stellar/layout/_partial/sidebar/widgets/toc.ejs","hash":"13687af7f50cf0a2e7e89e398a079a7041e5344f","modified":499162500000},{"_id":"node_modules/hexo-theme-stellar/layout/_partial/sidebar/widgets/wiki_more.ejs","hash":"ea693c1dda41767cbf761d0f5b35d95a88d599d3","modified":499162500000},{"_id":"node_modules/hexo-theme-stellar/source/css/_layout/pages/archives.styl","hash":"6a2ed5fd75e41499ca539269361b8bd8a2c541be","modified":499162500000},{"_id":"node_modules/hexo-theme-stellar/source/css/_layout/pages/error.styl","hash":"4c93c760b22d0e21800c45d7dc6f9e50c50da590","modified":499162500000},{"_id":"node_modules/hexo-theme-stellar/source/css/_layout/partial/article-footer.styl","hash":"118c4145bd8d8e56d03d742c3292dbd27dd0b213","modified":499162500000},{"_id":"node_modules/hexo-theme-stellar/source/css/_layout/partial/bread-nav.styl","hash":"478d2f568f42a4fdf3cc7b43157070d1d2897d4b","modified":499162500000},{"_id":"node_modules/hexo-theme-stellar/source/css/_layout/partial/cover.styl","hash":"0c1376d953d9b43b8beb67e8f0ebd884ebf50f9d","modified":499162500000},{"_id":"node_modules/hexo-theme-stellar/source/css/_layout/partial/footer.styl","hash":"f9129e39025fac3c9656752a3179b0ffc22142b5","modified":499162500000},{"_id":"node_modules/hexo-theme-stellar/source/css/_layout/partial/navbar.styl","hash":"411a4d0037f744fb4a1b1ae580fc06ee28430725","modified":499162500000},{"_id":"node_modules/hexo-theme-stellar/source/css/_layout/partial/paginator.styl","hash":"20e7fd59a34ec3869ae70768ddf1338d013f4e86","modified":499162500000},{"_id":"node_modules/hexo-theme-stellar/source/css/_layout/partial/related.styl","hash":"690cb53e2dfe660c39e21a86f3d8e2860ec0289f","modified":499162500000},{"_id":"node_modules/hexo-theme-stellar/source/css/_layout/sidebar/footer.styl","hash":"8719f466c16158482a86ca3d3533e157322283f7","modified":499162500000},{"_id":"node_modules/hexo-theme-stellar/source/css/_layout/sidebar/repo_info.styl","hash":"2c5f0b2ff3da8cc8cbc83345ec8ad706bf9d92c0","modified":499162500000},{"_id":"node_modules/hexo-theme-stellar/source/css/_layout/sidebar/sidebar.styl","hash":"6306da826c062f00a9682d07029d01099e462e76","modified":499162500000},{"_id":"node_modules/hexo-theme-stellar/source/css/_layout/sidebar/toc_blog.styl","hash":"0a2f1ada9130329fdc793603a9dfbc167303483f","modified":499162500000},{"_id":"node_modules/hexo-theme-stellar/source/css/_layout/sidebar/toc_common.styl","hash":"ef0e690740f2c4a965ae21a9434cb412893beca3","modified":499162500000},{"_id":"node_modules/hexo-theme-stellar/source/css/_layout/sidebar/toc_wiki.styl","hash":"861d75f3df735eb2dacdc376536394b8dffd40a7","modified":499162500000},{"_id":"node_modules/hexo-theme-stellar/source/css/_layout/tag-plugins/about.styl","hash":"5fea3f817cfeab382826c33df83e78f81c78ce0b","modified":499162500000},{"_id":"node_modules/hexo-theme-stellar/source/css/_layout/tag-plugins/checkbox.styl","hash":"c96080ea7d6149a2324d413b155ff9e984ffdad4","modified":499162500000},{"_id":"node_modules/hexo-theme-stellar/source/css/_layout/tag-plugins/common.styl","hash":"34fb7a853d9e98041abc585da9a30945fc346d20","modified":499162500000},{"_id":"node_modules/hexo-theme-stellar/source/css/_layout/tag-plugins/copy.styl","hash":"55dbbb171f3c4dd1a039c98914a8ed8820b5bf00","modified":499162500000},{"_id":"node_modules/hexo-theme-stellar/source/css/_layout/tag-plugins/emoji.styl","hash":"e51673f777d08ec3860f603de49a5d5aa51c06c0","modified":499162500000},{"_id":"node_modules/hexo-theme-stellar/source/css/_layout/tag-plugins/folding.styl","hash":"e8dc7b3b8c34c5eabf39b057353ee501087efbd6","modified":499162500000},{"_id":"node_modules/hexo-theme-stellar/source/css/_layout/tag-plugins/frame.styl","hash":"e15f5390951653b6ad62420afaed3ea2fe3f673c","modified":499162500000},{"_id":"node_modules/hexo-theme-stellar/source/css/_layout/tag-plugins/friends.styl","hash":"178eebdf3825fff66da76e96f3312ded38953deb","modified":499162500000},{"_id":"node_modules/hexo-theme-stellar/source/css/_layout/tag-plugins/ghcard.styl","hash":"98a50d3fab79ce03dd7f161fe3442d803712c284","modified":499162500000},{"_id":"node_modules/hexo-theme-stellar/source/css/_layout/tag-plugins/image.styl","hash":"f6edd2c71ac736332166a8240b6952629bf67ce5","modified":499162500000},{"_id":"node_modules/hexo-theme-stellar/source/css/_layout/tag-plugins/inline-labels.styl","hash":"c4244a12b20376cecf0e1b5d31c77c690c143968","modified":499162500000},{"_id":"node_modules/hexo-theme-stellar/source/css/_layout/tag-plugins/link.styl","hash":"2f0211bc84055a183a3e0e93a13d923a580c35f4","modified":499162500000},{"_id":"node_modules/hexo-theme-stellar/source/css/_layout/tag-plugins/mark.styl","hash":"9600c2d78b7044da545d1f9912587c2ad899c3fc","modified":499162500000},{"_id":"node_modules/hexo-theme-stellar/source/css/_layout/tag-plugins/navbar.styl","hash":"32508f439a8509179d7e7b9bb76d1d1fa9c6edc8","modified":499162500000},{"_id":"node_modules/hexo-theme-stellar/source/css/_layout/tag-plugins/note.styl","hash":"2430b2982cf01cb889f320b7680dfa4633b94035","modified":499162500000},{"_id":"node_modules/hexo-theme-stellar/source/css/_layout/tag-plugins/poetry.styl","hash":"cbb5ac429b27af677482538dda3573836b5b2ca4","modified":499162500000},{"_id":"node_modules/hexo-theme-stellar/source/css/_layout/tag-plugins/quot.styl","hash":"806eac9ed335acc4d99f644512219cbe532567c6","modified":499162500000},{"_id":"node_modules/hexo-theme-stellar/source/css/_layout/tag-plugins/sites.styl","hash":"54e18082989694865b28a328cfc7539d70bc1bd2","modified":499162500000},{"_id":"node_modules/hexo-theme-stellar/source/css/_layout/tag-plugins/tabs.styl","hash":"f0c76e93a518da510745e5475ee373d8ab0b8636","modified":499162500000},{"_id":"node_modules/hexo-theme-stellar/source/css/_layout/tag-plugins/timeline.styl","hash":"e8c8b577d80960165fed56899f04e014579dc04f","modified":499162500000},{"_id":"node_modules/hexo-theme-stellar/source/css/_layout/tag-plugins/toc.styl","hash":"da28c2256d2bf7740d20d79ac912806813ea45e0","modified":499162500000},{"_id":"node_modules/hexo-theme-stellar/source/css/_plugins/comments/beaudar.styl","hash":"e9800f67a650f1c022aee494768e05da76e6a6b7","modified":499162500000},{"_id":"node_modules/hexo-theme-stellar/source/css/_plugins/comments/twikoo.styl","hash":"ee1c40232318252ce9d1564e90b361d6901b0ea0","modified":499162500000},{"_id":"node_modules/hexo-theme-stellar/source/css/_plugins/comments/utterances.styl","hash":"1c2d231ee311b064293b50529ce9cdc411c22054","modified":499162500000},{"_id":"node_modules/hexo-theme-stellar/source/css/_plugins/comments/valine.styl","hash":"246e66527c3eef915e4d7713ebf0fc8b7eb07d2a","modified":499162500000},{"_id":"node_modules/hexo-theme-stellar/layout/_partial/plugins/comments/beaudar/layout.ejs","hash":"1a9b6f3e189d9f282e01fb758e6f39bf34ccc53c","modified":499162500000},{"_id":"node_modules/hexo-theme-stellar/layout/_partial/plugins/comments/beaudar/script.ejs","hash":"94b21ec4854d5321693228fbe6edf6688d3e333b","modified":499162500000},{"_id":"node_modules/hexo-theme-stellar/layout/_partial/plugins/comments/twikoo/layout.ejs","hash":"e662b87a983ed2347b642bf2ef9f0250f7273b60","modified":499162500000},{"_id":"node_modules/hexo-theme-stellar/layout/_partial/plugins/comments/twikoo/script.ejs","hash":"3c6315837d18f9de20143afc45166a6a3fbb07b9","modified":499162500000},{"_id":"node_modules/hexo-theme-stellar/layout/_partial/plugins/comments/utterances/layout.ejs","hash":"2310bdef7c57cbaede9f91c810e1db829bef6fb2","modified":499162500000},{"_id":"node_modules/hexo-theme-stellar/layout/_partial/plugins/comments/utterances/script.ejs","hash":"5a01541e2bbad0538849fbbf13c74d2dafc19a67","modified":499162500000},{"_id":"node_modules/hexo-theme-stellar/layout/_partial/plugins/comments/valine/layout.ejs","hash":"e0b3ed8b13bb4b995b4bd8c8c7ec75e43b074d8e","modified":499162500000},{"_id":"node_modules/hexo-theme-stellar/layout/_partial/plugins/comments/valine/script.ejs","hash":"38d19501c576e444e349e7cab3d9f958d889a42b","modified":499162500000},{"_id":"public/404.html","hash":"1e977d51dac2736f6e7d50b369e9ce2cac393974","modified":1650083354302},{"_id":"public/about/index.html","hash":"f798fa6b6d684fc462ce38f854e46bd769f16b42","modified":1650083354302},{"_id":"public/notes/index.html","hash":"dd91840926e0f1fba4be7aaef62d056bc3321a7e","modified":1650083354302},{"_id":"public/archives/index.html","hash":"6f05f405c9d56e06745cc4c07a4fa03da3d75a82","modified":1650083354302},{"_id":"public/archives/2022/index.html","hash":"f4e42e08463470fa162aebb6ae31868713ba69aa","modified":1650083354302},{"_id":"public/archives/2022/04/index.html","hash":"025a737659c401d1717e91a973acc4c3e92bce48","modified":1650083354302},{"_id":"public/index.html","hash":"6c9dd538e92b5b0ef7eca649f4dc8cfb7000b46e","modified":1650083354302},{"_id":"public/tags/kubernetes/index.html","hash":"242100b19ebd15c35e494b4191d0db606499744b","modified":1650083354302},{"_id":"public/tags/index.html","hash":"da6da98524d56fee1a9eea2e9d78c874ab91a84c","modified":1650083354302},{"_id":"public/2022/04/16/k8s-containerd/index.html","hash":"ad33a47cf0d1db9f022319d240c5e0fb83c7b017","modified":1650083354302},{"_id":"public/js/main.js","hash":"34adcfadc95c9b6599cc617b2902dae369ed4d64","modified":1650083354302},{"_id":"public/js/plugins/friends.js","hash":"9815baf1e18d7cc2c8cb0623ce032a584cb2d40a","modified":1650083354302},{"_id":"public/js/plugins/sites.js","hash":"dff454cd2bc34b718692dc4e941976311c73f670","modified":1650083354302},{"_id":"public/css/main.css","hash":"83e60df3c96982a9c3d64393b63ecc9096fe71c7","modified":1650083354302}],"Category":[],"Data":[],"Page":[{"title":"about","date":"2022-04-16T03:31:33.000Z","_content":"","source":"about/index.md","raw":"---\ntitle: about\ndate: 2022-04-16 11:31:33\n---\n","updated":"2022-04-16T03:31:33.604Z","path":"about/index.html","comments":1,"layout":"page","_id":"cl21d0wwt0000vqjx97w0ha0n","content":"","site":{"data":{}},"excerpt":"","more":""},{"title":"notes","date":"2022-04-16T03:31:37.000Z","_content":"","source":"notes/index.md","raw":"---\ntitle: notes\ndate: 2022-04-16 11:31:37\n---\n","updated":"2022-04-16T03:31:37.924Z","path":"notes/index.html","comments":1,"layout":"page","_id":"cl21d0wx00002vqjx6juxhi43","content":"","site":{"data":{}},"excerpt":"","more":""}],"Post":[{"title":"二进制高可用安装","cover":"https://acg.toubiec.cn/random.php","_content":"\nubuntu install kubernetes(containerd)\n\n<!-- more -->\n\n## 一、Prepare\n\n### 1、system\n\n```sh\n# 1、sources.list\nmv /etc/apt/sources.list /etc/apt/sources.list.bak\ncat  /etc/apt/sources.list.bak |grep -v \"#\" |grep -v \"^$\" > sources.list\nsed -i s/archive.ubuntu.com/mirrors.ustc.edu.cn/g /etc/apt/sources.list\nsed -i s/security.ubuntu.com/mirrors.ustc.edu.cn/g /etc/apt/sources.list\napt -y update && apt -y upgrade\n\n# 2、timedatectl\nsed -i s/en_US/C/g /etc/default/locale\ntimedatectl set-timezone Asia/Shanghai\n\n# 3、bash-completion\nsed -i 97,99s/#//g /root/.bashrc\n\n# 4、ssh\necho \"PermitRootLogin yes\" >> /etc/ssh/sshd_config\npasswd root << \"EOF\"\npassword\npassword\nEOF\nsystemctl reload ssh\n\n# 5、hosts\nvim /etc/hosts\n10.0.0.20 k8s-master00\n10.0.0.21 k8s-master01\n10.0.0.22 k8s-master02\n10.0.0.23 k8s-node01\n10.0.0.24 k8s-node02\n10.0.0.25 k8s-bl-master\n\n# 6、ssh-keygen\nssh-keygen -t rsa\nfor i in `cat /root/*.txt`;do echo $i;ssh-copy-id -i .ssh/id_rsa.pub $i;done\n\n# 7、swap\nswapoff -a\nsed -i '/swap/s/^\\(.*\\)$/#\\1/g' /etc/fstab\n\n# 8、network\nnet=`cat /etc/netplan/00-installer-config.yaml |awk 'NR==4{print $1}'`\nsed -i \"s/${net}/eth0:/g\" /etc/netplan/00-installer-config.yaml\nsed -i '11s/\"\"/\"net.ifnames=0 biosdevname=0\"/g' /etc/default/grub\nupdate-grub\nreboot\n```\n### 2、ipvs\n\n```sh\napt -y install ipvsadm ipset sysstat conntrack libseccomp2 libseccomp-dev\ncat > /etc/modules-load.d/ipvs.conf << EOF\nip_vs\nip_vs_lc\nip_vs_wlc\nip_vs_rr\nip_vs_wrr\nip_vs_lblc\nip_vs_lblcr\nip_vs_dh\nip_vs_sh\nip_vs_fo\nip_vs_nq\nip_vs_sed\nip_vs_ftp\nnf_conntrack\nip_tables\nip_set\nxt_set\nipt_set\nipt_rpfilter\nipt_REJECT\nipip\nEOF\nsystemctl restart systemd-modules-load.service\nlsmod |grep -e ip_vs -e nf_conntrack_ipv4\n```\n\n### 3、containerd\n\n#### 3.1、download containerd\n\n```sh\nwget https://github.com/containerd/containerd/releases/download/v1.6.1/cri-containerd-cni-1.6.1-linux-amd64.tar.gz\ntar --no-overwrite-dir -C / -xzf cri-containerd-cni-1.6.1-linux-amd64.tar.gz\nsystemctl daemon-reload\nsystemctl enable --now containerd\n```\n\n#### 3.2、config.toml\n\n```sh\ncontainerd config default > /etc/containerd/config.toml\n---\nsed -i \"s#k8s.gcr.io#registry.aliyuncs.com/google_containers#g\" /etc/containerd/config.toml\nsed -i \"s#SystemdCgroup = false#SystemdCgroup = true#g\" /etc/containerd/config.toml\nsed -i '153a\\        [plugins.\"io.containerd.grpc.v1.cri\".registry.mirrors.\"docker.io\"]' /etc/containerd/config.toml  # 8个空格 # endpoint 10个空格\nsed -i '154a\\          endpoint = [\"https://registry.aliyuncs.com\"]' /etc/containerd/config.toml\n```\n\n#### 3.3、crictl.yaml\n\n```sh\nmv /etc/crictl.yaml /etc/crictl.yaml.bak\ncat > /etc/crictl.yaml << \"EOF\"\nruntime-endpoint: unix:///run/containerd/containerd.sock\nimage-endpoint: unix:///run/containerd/containerd.sock\ntimeout: 0\ndebug: false\npull-image-on-create: false\ndisable-pull-on-run: false\nEOF\n```\n\n## 二、High availability\n\n### 1、nginx.conf\n\n```sh\napt -y install nginx\ncp /etc/nginx/nginx.conf /etc/nginx/nginx.conf.bak\nvim /etc/nginx/nginx.conf\n---\n...\n...\nstream {\n          \n        log_format main '$remote_addr $upstream_addr - [$time_local] $status $upstream_bytes_sent';\n          \n        access_log /var/log/nginx/k8s-access.log main;\n        \n        upstream k8s-apiserver {\n                server 10.0.0.20:6443;\n                server 10.0.0.21:6443;\n                server 10.0.0.22:6443;\n        }\n    \n        server {\n                listen 6444; \n                proxy_pass k8s-apiserver;\n        }\n}\n\nhttp {\n\t\tlog_format main '$remote_addr - $remote_user [$time_local] \"$request\" '\n                        '$status $body_bytes_sent \"$http_referer\" '\n                        '\"$http_user_agent\" \"$http_x_forwarded_for\"';\n        ...\n        ...\n}\n---\nsystemctl enable --now nginx.service\nsystemctl status nginx.service\n```\n\n### 2、keepalived.conf\n\n```sh\napt -y install keepalived\n#keepalived config\ncat > /etc/keepalived/keepalived.conf << \"EOF\"\nglobal_defs {\n    notification_email {\n      acassen@firewall.loc\n      failover@firewall.loc\n      sysadmin@firewall.loc\n    }\n    notification_email_from Alexandre.Cassen@firewall.loc\n    smtp_server 127.0.0.1\n    smtp_connect_timeout 30 \n    router_id NGINX_MASTER\n}\n\nvrrp_script check_nginx {\n  script \"/etc/keepalived/check_nginx.sh\"\n  interval 5\n  weight -1\n  fall 2\n  rise 1\n}\n\nvrrp_instance VI_1 {\n    state MASTER\n    interface eth0 # 修改为实际网卡名\n    virtual_router_id 51 # VRRP 路由 ID 实例，每个实例是唯一的\n    priority 100 # 优先级，备服务器设置 90\n    advert_int 1 # 指定 VRRP 心跳包通告间隔时间，默认 1 秒\n    authentication {\n        auth_type PASS\n        auth_pass K8SHA_KA_AUTH\n    }\n    # 虚拟 IP\n    virtual_ipaddress {\n        10.0.0.25/24\n    }\n    track_script {\n        check_nginx\n    }\n}\nEOF\n#health config\ncat > /etc/keepalived/check_nginx.sh << \"EOF\"\n#!/bin/bash \ncount=$(ps -ef |grep nginx | grep sbin | egrep -cv \"grep|$$\") \nif [ \"$count\" -eq 0 ];then \n  systemctl stop keepalived \nfi\nEOF\n---\nsystemctl enable --now keepalived.service\nsystemctl status keepalived.service\n```\n\n## 三、Master\n\n### 1、cfssl\n\n```sh\nwget https://github.com/cloudflare/cfssl/releases/download/v1.6.1/cfssl_1.6.1_linux_amd64 -O /usr/local/bin/cfssl\nwget https://github.com/cloudflare/cfssl/releases/download/v1.6.1/cfssljson_1.6.1_linux_amd64 -O /usr/local/bin/cfssljson\nwget https://github.com/cloudflare/cfssl/releases/download/v1.6.1/cfssl-certinfo_1.6.1_linux_amd64 -O /usr/local/bin/cfssl-certinfo\nchmod +x /usr/local/bin/cfssl*\nchown -Rf root:root /usr/local/bin/cfssl*\n```\n\n### 2、etcd\n\n#### 2.1、mkdir directory\n\n```sh\n# all Master\n# 1、etcd-ssl\nmkdir -p /etc/etcd/ssl/\n# 2、etcd-WorkingDirectory\nmkdir -p /var/lib/etcd/default.etcd\n# 3、kubernetes-ssl\nmkdir -p /etc/kubernetes/ssl\n# 4、kubernetes-log\nmkdir -p /var/log/kubernetes\n```\n\n#### 2.2、ca certificate\n\n```sh\n# master00\nmkdir -p ~/work\ncd ~/work/\n---\ncat > ca-csr.json << \"EOF\"\n{\n  \"CN\": \"kubernetes\",\n  \"key\": {\n    \"algo\": \"rsa\",\n    \"size\": 2048\n  },\n  \"names\": [\n    {\n      \"C\": \"CN\",\n      \"ST\": \"Shanghai\",\n      \"L\": \"Shanghai\",\n      \"O\": \"k8s\",\n      \"OU\": \"system\"\n    }\n  ]\n}\nEOF\n---\ncat > ca-config.json << \"EOF\"\n{\n  \"signing\": {\n    \"default\": {\n      \"expiry\": \"87600h\"\n    },\n    \"profiles\": {\n      \"kubernetes\": {\n        \"usages\": [\n            \"signing\",\n            \"key encipherment\",\n            \"server auth\",\n            \"client auth\"\n        ],\n        \"expiry\": \"87600h\"\n      }\n    }\n  }\n}\nEOF\n---\ncfssl gencert -initca ca-csr.json | cfssljson -bare ca\ncp ca*.pem /etc/etcd/ssl/\n---\n# send to other master\nfor i in `cat ~/MasterNodes.txt`;do echo $i;scp /etc/etcd/ssl/ca*.pem $i:/etc/etcd/ssl;done\n```\n\n#### 2.3、etcd certificate\n\n```sh\ncat > etcd-csr.json << \"EOF\"\n{\n  \"CN\": \"etcd\",\n  \"hosts\": [\n    \"127.0.0.1\",\n    \"10.0.0.20\",\n    \"10.0.0.21\",\n    \"10.0.0.22\",\n    \"10.0.0.25\"\n  ],\n  \"key\": {\n    \"algo\": \"rsa\",\n    \"size\": 2048\n  },\n  \"names\": [\n    {\n      \"C\": \"CN\",\n      \"ST\": \"Shanghai\",\n      \"L\": \"Shanghai\",\n      \"O\": \"k8s\",\n      \"OU\": \"system\"\n    }\n  ]\n}\nEOF\n---\ncfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes etcd-csr.json | cfssljson -bare etcd\ncp etcd*.pem /etc/etcd/ssl/\n---\n# send to other\nfor i in `cat ~/MasterNodes.txt`;do echo $i;scp /etc/etcd/ssl/etcd*.pem $i:/etc/etcd/ssl;done\n```\n\n#### 2.4、install etcd{,ctl}\n\n```sh\n# download etcd\nwget https://github.com/etcd-io/etcd/releases/download/v3.5.0/etcd-v3.5.0-linux-amd64.tar.gz\n# tar etcd-*.tar.gz\ntar -xf etcd-v3.5.0-linux-amd64.tar.gz --strip-components=1 -C ~/work/ etcd-v3.5.0-linux-amd64/etcd{,ctl}\nchown -Rf root:root etcd*\ncp -arp etcd* /usr/local/bin/\n# send to other\nfor i in `cat ~/MasterNodes.txt`;do echo $i;scp /usr/local/bin/etcd{,ctl} $i:/usr/local/bin/;done\n```\n\n#### 2.5、etcd.conf\n\n```sh\ncat > /etc/etcd/etcd.conf << \"EOF\"\nETCD_NAME='etcd1'\nETCD_DATA_DIR=\"/var/lib/etcd/default.etcd\"\nETCD_LISTEN_PEER_URLS=\"https://10.0.0.20:2380\" # change ip\nETCD_LISTEN_CLIENT_URLS=\"https://10.0.0.20:2379,http://127.0.0.1:2379\" # change ip\nETCD_INITIAL_ADVERTISE_PEER_URLS=\"https://10.0.0.20:2380\" # change ip\nETCD_ADVERTISE_CLIENT_URLS=\"https://10.0.0.20:2379\" # change ip\nETCD_INITIAL_CLUSTER=\"etcd1=https://10.0.0.20:2380,etcd2=https://10.0.0.21:2380,etcd3=https://10.0.0.22:2380\"\nETCD_INITIAL_CLUSTER_TOKEN=\"etcd-cluster\"\nETCD_INITIAL_CLUSTER_STATE=\"new\"\nEOF\n```\n\n#### 2.6、etcd.service\n\n```sh\ncat > /usr/lib/systemd/system/etcd.service << \"EOF\"\n[Unit]\nDescription=Etcd Service\nAfter=network.target\nAfter=network-online.target\nWants=network-online.target\n\n[Service]\nType=notify\nEnvironmentFile=-/etc/etcd/etcd.conf\nWorkingDirectory=/var/lib/etcd/\nExecStart=/usr/local/bin/etcd \\\n --cert-file=/etc/etcd/ssl/etcd.pem \\\n --key-file=/etc/etcd/ssl/etcd-key.pem \\\n --trusted-ca-file=/etc/etcd/ssl/ca.pem \\\n --peer-cert-file=/etc/etcd/ssl/etcd.pem \\\n --peer-key-file=/etc/etcd/ssl/etcd-key.pem \\\n --peer-trusted-ca-file=/etc/etcd/ssl/ca.pem \\\n --peer-client-cert-auth \\\n --client-cert-auth\nRestart=on-failure\nRestartSec=10\nLimitNOFILE=65536\n\n[Install]\nWantedBy=multi-user.target\nEOF\n---\n# send to other\nfor i in `cat ~/MasterNodes.txt`;do echo $i;scp /usr/lib/systemd/system/etcd.service $i:/usr/lib/systemd/system/;done\n```\n\n#### 2.7、start etcd.service\n\n```sh\n# 1、start etcd\nsystemctl daemon-reload\nsystemctl enable --now etcd.service\nsystemctl status etcd.service\n# 2、check etcd\nETCDCTL_API=3\netcdctl --endpoints=https://10.0.0.20:2379,https://10.0.0.21:2379,https://10.0.0.22:2379 --write-out=table --cacert=/etc/etcd/ssl/ca.pem --cert=/etc/etcd/ssl/etcd.pem --key=/etc/etcd/ssl/etcd-key.pem endpoint health\n+----------------------------+--------+-------------+-------+\n|          ENDPOINT          | HEALTH |    TOOK     | ERROR |\n+----------------------------+--------+-------------+-------+\n| https://10.0.0.20:2379     |   true | 16.188005ms |       |\n| https://10.0.0.21:2379     |   true | 16.693314ms |       |\n| https://10.0.0.22:2379     |   true | 16.089367ms |       |\n+----------------------------+--------+-------------+-------+\n```\n\n#### 2.8、kube{...}\n\n```sh\n# 1、download\nwget https://dl.k8s.io/v1.23.5/kubernetes-server-linux-amd64.tar.gz\n# 2、tar\ntar -xf kubernetes-server-linux-amd64.tar.gz --strip-components=3 -C ~/work kubernetes/server/bin/kube{let,ctl,-apiserver,-controller-manager,-scheduler,-proxy}\n\nscp kube{ctl,-apiserver,-controller-manager,-scheduler} /usr/local/bin/\n# 3、kube{let,ctl,-apiserver,-controller-manager,-scheduler,-proxy}\nfor i in `cat ~/MasterNodes.txt`;do echo $i;scp ~/work/kube{ctl,-apiserver,-controller-manager,-scheduler} $i:/usr/local/bin/;done\n# 4、kube{let,-proxy}\nfor i in `cat ~/WorkNodes.txt`;do echo $i;scp ~/work/kube{let,-proxy} $i:/usr/local/bin/;done\n# 5、send pem\ncp /etc/etcd/ssl/ca*.pem /etc/kubernetes/ssl/\nfor i in `cat ~/WorkNodes.txt`;do echo $i;scp /etc/etcd/ssl/ca*.pem $i:/etc/kubernetes/ssl/;done\n```\n\n### 3、kube-apiserver\n\n#### 3.1、token.csv\n\n```sh\ncat  > /etc/kubernetes/token.csv <<EOF\n$(head -c 16 /dev/urandom | od -An -t x | tr -d ' '),kubelet-bootstrap,10001,\"system:kubelet-bootstrap\"\nEOF\nfor i in `cat ~/MasterNodes.txt`;do echo $i;scp /etc/kubernetes/token.csv $i:/etc/kubernetes/;done\n```\n\n#### 3.2、kube-apiserver certificate\n\n```sh\ncat > kube-apiserver-csr.json << \"EOF\"\n{\n  \"CN\": \"kubernetes\",\n  \"hosts\": [\n    \"127.0.0.1\",\n    \"10.0.0.20\",\n    \"10.0.0.21\",\n    \"10.0.0.22\",\n    \"10.0.0.23\",\n    \"10.0.0.24\",\n    \"10.0.0.25\",\n    \"10.96.0.1\",\n    \"kubernetes\",\n    \"kubernetes.default\",\n    \"kubernetes.default.svc\",\n    \"kubernetes.default.svc.cluster\",\n    \"kubernetes.default.svc.cluster.local\"\n  ],\n  \"key\": {\n    \"algo\": \"rsa\",\n    \"size\": 2048\n  },\n  \"names\": [\n    {\n      \"C\": \"CN\",\n      \"ST\": \"Shanghai\",\n      \"L\": \"Shanghai\",\n      \"O\": \"k8s\",\n      \"OU\": \"system\"\n    }\n  ]\n}\nEOF\n---\ncfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes kube-apiserver-csr.json | cfssljson -bare kube-apiserver\ncp kube-apiserver*.pem /etc/kubernetes/ssl/\nfor i in `cat ~/MasterNodes.txt`;do echo $i;scp ~/work/kube-apiserver*.pem $i:/etc/kubernetes/ssl/;done\n```\n\n#### 3.3、kube-apiserver.conf\n\n```sh\n# change --bind-address= and --advertise-address=\n---\ncat > /etc/kubernetes/kube-apiserver.conf << \"EOF\"\nKUBE_APISERVER_OPTS=\"--enable-admission-plugins=NamespaceLifecycle,NodeRestriction,LimitRanger,ServiceAccount,DefaultStorageClass,ResourceQuota \\\n --anonymous-auth=false \\\n --bind-address=10.0.0.20 \\\n --secure-port=6443 \\\n --advertise-address=10.0.0.20 \\\n --insecure-port=0 \\\n --authorization-mode=Node,RBAC \\\n --runtime-config=api/all=true \\\n --enable-bootstrap-token-auth \\\n --service-cluster-ip-range=10.96.0.0/16 \\\n --token-auth-file=/etc/kubernetes/token.csv \\\n --service-node-port-range=30000-50000 \\\n --tls-cert-file=/etc/kubernetes/ssl/kube-apiserver.pem \\\n --tls-private-key-file=/etc/kubernetes/ssl/kube-apiserver-key.pem \\\n --client-ca-file=/etc/kubernetes/ssl/ca.pem \\\n --kubelet-client-certificate=/etc/kubernetes/ssl/kube-apiserver.pem \\\n --kubelet-client-key=/etc/kubernetes/ssl/kube-apiserver-key.pem \\\n --service-account-key-file=/etc/kubernetes/ssl/ca-key.pem \\\n --service-account-signing-key-file=/etc/kubernetes/ssl/ca-key.pem \\\n --service-account-issuer=https://kubernetes.default.svc.cluster.local \\\n --etcd-cafile=/etc/etcd/ssl/ca.pem \\\n --etcd-certfile=/etc/etcd/ssl/etcd.pem \\\n --etcd-keyfile=/etc/etcd/ssl/etcd-key.pem \\\n --etcd-servers=https://10.0.0.20:2379,https://10.0.0.21:2379,https://10.0.0.22:2379 \\\n --enable-swagger-ui=true \\\n --allow-privileged=true \\\n --apiserver-count=3 \\\n --audit-log-maxage=30 \\\n --audit-log-maxbackup=3 \\\n --audit-log-maxsize=100 \\\n --audit-log-path=/var/log/kube-apiserver-audit.log \\\n --event-ttl=1h \\\n --alsologtostderr=true \\\n --logtostderr=false \\\n --log-dir=/var/log/kubernetes \\\n --v=4\"\nEOF\n```\n\n#### 3.4、kube-apiserver.service\n\n```sh\ncat > /usr/lib/systemd/system/kube-apiserver.service << \"EOF\"\n[Unit]\nDescription=Kubernetes API Server\nDocumentation=https://github.com/kubernetes/kubernetes\nAfter=etcd.service\nWants=etcd.service\n\n[Service]\nEnvironmentFile=-/etc/kubernetes/kube-apiserver.conf\nExecStart=/usr/local/bin/kube-apiserver $KUBE_APISERVER_OPTS\nRestart=on-failure\nRestartSec=5\nType=notify\nLimitNOFILE=65536\n\n[Install]\nWantedBy=multi-user.target\nEOF\n---\nfor i in `cat ~/MasterNodes.txt`;do echo $i;scp /usr/lib/systemd/system/kube-apiserver.service $i:/usr/lib/systemd/system/;done\n```\n\n#### 3.5、start kube-apiserver.service\n\n```sh\nsystemctl daemon-reload\nsystemctl enable --now kube-apiserver.service\nsystemctl status kube-apiserver.service\n---\n# check\ncurl --insecure https://10.0.0.20:6443\n---\n{\n  \"kind\": \"Status\",\n  \"apiVersion\": \"v1\",\n  \"metadata\": {},\n  \"status\": \"Failure\",\n  \"message\": \"Unauthorized\",\n  \"reason\": \"Unauthorized\",\n  \"code\": 401\n```\n\n### 4、kubectl\n\n#### 4.1、admin certificate\n\n```sh\ncat > admin-csr.json << \"EOF\"\n{\n  \"CN\": \"admin\",\n  \"hosts\": [],\n  \"key\": {\n    \"algo\": \"rsa\",\n    \"size\": 2048\n  },\n  \"names\": [\n    {\n      \"C\": \"CN\",\n      \"ST\": \"Shanghai\",\n      \"L\": \"Shanghai\",\n      \"O\": \"system:masters\",\n      \"OU\": \"system\"\n    }\n  ]\n}\nEOF\n---\ncfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes admin-csr.json | cfssljson -bare admin\ncp admin*.pem /etc/kubernetes/ssl/\n---\nfor i in `cat ~/MasterNodes.txt`;do echo $i;scp /etc/kubernetes/ssl/admin*.pem $i:/etc/kubernetes/ssl/;done \n```\n\n#### 4.2、admin.config\n\n```sh\n# 1、设置集群参数\nkubectl config set-cluster kubernetes --certificate-authority=ca.pem --embed-certs=true --server=https://10.0.0.25:6444 --kubeconfig=admin.config\n\n# 2、设置客户端认证参数\nkubectl config set-credentials kubernetes-admin --client-certificate=admin.pem --client-key=admin-key.pem --embed-certs=true --kubeconfig=admin.config\n\n# 3、设置上下文参数\nkubectl config set-context kubernetes --cluster=kubernetes --user=kubernetes-admin --kubeconfig=admin.config\n\n# 4、设置当前上下文\nkubectl config use-context kubernetes --kubeconfig=admin.config\n```\n\n#### 4.3、kubernetes-kubelet api\n\n```sh\nkubectl create clusterrolebinding kube-apiserver:kubelet-apiserver --clusterrole=system.kubelet-api-admin --user kubernetes\nkubectl create clusterrolebinding kubernetes --clusterrole=cluster-admin --user=kubernetes\n```\n\n#### 4.4、send to other\n\n```sh\ncp ~/work/admin.config /etc/kubernetes\nmkdir -p $HOME/.kube\ncp -i /etc/kubernetes/admin.config $HOME/.kube/config\nchown $(id -u):$(id -g) $HOME/.kube/config\n\nfor i in `cat ~/MasterNodes.txt`;do echo $i;scp /etc/kubernetes/admin.config $i:/etc/kubernetes/;done\n\necho \"export KUBECONFIG=/etc/kubernetes/admin.config\" >> /etc/profile\nsource /etc/profile\n```\n\n#### 4.5、kubectl(bash-completion)\n\n```sh\nsource <(kubectl completion bash)\necho \"source <(kubectl completion bash)\" >> /etc/profile\nsource /etc/profile\n```\n\n#### 4.6、verify kubectl\n\n```sh\nkubectl cluster-info\n---\n{Kubernetes control plane is running at https://10.0.0.20:6443}\n---\nkubectl get componentstatuses\n---\nNAME                 STATUS      MESSAGE                                                                                        ERROR\nscheduler            Unhealthy   Get \"https://127.0.0.1:10259/healthz\": dial tcp 127.0.0.1:10259: connect: connection refused   \ncontroller-manager   Unhealthy   Get \"https://127.0.0.1:10257/healthz\": dial tcp 127.0.0.1:10257: connect: connection refused   \netcd-0               Healthy     {\"health\":\"true\",\"reason\":\"\"}                                           \netcd-1               Healthy     {\"health\":\"true\",\"reason\":\"\"}                                           \netcd-2               Healthy     {\"health\":\"true\",\"reason\":\"\"}                                           \n---\nkubectl get all --all-namespaces\n---\nNAMESPACE   NAME                 TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE\ndefault     service/kubernetes   ClusterIP   10.96.0.1   <none>        443/TCP   56m\n```\n\n### 5、kube-controller-manager\n\n#### 5.1、kube-controller-manager certificate\n\n```sh\ncat > kube-controller-manager-csr.json << \"EOF\"\n{\n  \"CN\": \"system:kube-controller-manager\",\n  \"hosts\": [\n    \"127.0.0.1\",\n    \"10.0.0.20\",\n    \"10.0.0.21\",\n    \"10.0.0.22\",\n    \"10.0.0.25\"\n  ],\n  \"key\": {\n    \"algo\": \"rsa\",\n    \"size\": 2048\n  },\n  \"names\": [\n    {\n      \"C\": \"CN\",\n      \"ST\": \"Shanghai\",\n      \"L\": \"Shanghai\",\n      \"O\": \"system:kube-controller-manager\",\n      \"OU\": \"Kubernetes\"\n    }\n  ]\n}\nEOF\n---\ncfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes kube-controller-manager-csr.json | cfssljson -bare kube-controller-manager\ncp kube-controller-manager*.pem /etc/kubernetes/ssl/\nfor i in `cat ~/MasterNodes.txt`;do echo $i;scp /etc/kubernetes/ssl/kube-controller-manager*.pem $i:/etc/kubernetes/ssl/;done\n```\n\n#### 5.2、kube-controller-manager.kubeconfig\n\n```sh\n# 1、设置集群参数\nkubectl config set-cluster kubernetes --certificate-authority=ca.pem --embed-certs=true --server=https://10.0.0.25:6444 --kubeconfig=/etc/kubernetes/kube-controller-manager.kubeconfig\n\n# 2、设置客户端认证参数\nkubectl config set-credentials system:kube-controller-manager --client-certificate=kube-controller-manager.pem --client-key=kube-controller-manager-key.pem --embed-certs=true --kubeconfig=/etc/kubernetes/kube-controller-manager.kubeconfig\n\n# 3、设置上下文参数\nkubectl config set-context system:kube-controller-manager --cluster=kubernetes --user=system:kube-controller-manager --kubeconfig=/etc/kubernetes/kube-controller-manager.kubeconfig\n\n# 4、设置当前上下文\nkubectl config use-context system:kube-controller-manager --kubeconfig=/etc/kubernetes/kube-controller-manager.kubeconfig\n```\n\n#### 5.3、kube-controller-manager.conf\n\n```sh\ncat > /etc/kubernetes/kube-controller-manager.conf << \"EOF\"\nKUBE_CONTROLLER_MANAGER_OPTS=\"--v=2 \\\n  --secure-port=10257 \\\n  --bind-address=127.0.0.1 \\\n  --kubeconfig=/etc/kubernetes/kube-controller-manager.kubeconfig \\\n  --service-cluster-ip-range=10.96.0.0/16 \\\n  --cluster-name=kubernetes \\\n  --cluster-signing-cert-file=/etc/kubernetes/ssl/ca.pem \\\n  --cluster-signing-key-file=/etc/kubernetes/ssl/ca-key.pem \\\n  --allocate-node-cidrs=true \\\n  --cluster-cidr=10.244.0.0/16 \\\n  --experimental-cluster-signing-duration=87600h \\\n  --root-ca-file=/etc/kubernetes/ssl/ca.pem \\\n  --service-account-private-key-file=/etc/kubernetes/ssl/ca-key.pem \\\n  --leader-elect=true \\\n  --feature-gates=RotateKubeletServerCertificate=true \\\n  --controllers=*,bootstrapsigner,tokencleaner \\\n  --horizontal-pod-autoscaler-sync-period=10s \\\n  --tls-cert-file=/etc/kubernetes/ssl/kube-controller-manager.pem \\\n  --tls-private-key-file=/etc/kubernetes/ssl/kube-controller-manager-key.pem \\\n  --use-service-account-credentials=true\"\nEOF\n  ---\nfor i in `cat ~/MasterNodes.txt`;do echo $i;scp /etc/kubernetes/kube-controller-manager* $i:/etc/kubernetes/;done\n```\n\n#### 5.4、kube-controller-manager.service\n\n```sh\ncat > /usr/lib/systemd/system/kube-controller-manager.service << \"EOF\"\n[Unit]\nDescription=Kubernetes Controller Manager\nDocumentation=https://github.com/kubernetes/kubernetes\n\n[Service]\nEnvironmentFile=-/etc/kubernetes/kube-controller-manager.conf\nExecStart=/usr/local/bin/kube-controller-manager $KUBE_CONTROLLER_MANAGER_OPTS\nRestart=on-failure\nRestartSec=5\n\n[Install]\nWantedBy=multi-user.target\nEOF\n---\nfor i in `cat ~/MasterNodes.txt`;do echo $i;scp /usr/lib/systemd/system/kube-controller-manager.service $i:/usr/lib/systemd/system/;done\n```\n\n#### 5.5、start kube-controller-manager.service\n\n```sh\nsystemctl daemon-reload\nsystemctl enable --now kube-controller-manager.service\nsystemctl status kube-controller-manager.service\n```\n\n### 6、kube-scheduler\n\n#### 6.1、kube-scheduler certificate\n\n```sh\ncat > kube-scheduler-csr.json << \"EOF\"\n{\n  \"CN\": \"system:kube-scheduler\",\n  \"hosts\": [\n    \"127.0.0.1\",\n    \"10.0.0.20\",\n    \"10.0.0.21\",\n    \"10.0.0.22\",\n    \"10.0.0.25\"\n  ],\n  \"key\": {\n    \"algo\": \"rsa\",\n    \"size\": 2048\n  },\n  \"names\": [\n    {\n      \"C\": \"CN\",\n      \"ST\": \"Shanghai\",\n      \"L\": \"Shanghai\",\n      \"O\": \"system:kube-scheduler\",\n      \"OU\": \"system\"\n    }\n  ]\n}\nEOF\n---\ncfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes kube-scheduler-csr.json | cfssljson -bare kube-scheduler\ncp kube-scheduler*.pem /etc/kubernetes/ssl/\nfor i in `cat ~/MasterNodes.txt`;do echo $i;scp /etc/kubernetes/ssl/kube-scheduler*.pem $i:/etc/kubernetes/ssl/;done\n```\n\n#### 6.2、kube-scheduler.kubeconfig\n\n```sh\n# 1、设置集群参数\nkubectl config set-cluster kubernetes --certificate-authority=ca.pem --embed-certs=true --server=https://10.0.0.25:6444 --kubeconfig=/etc/kubernetes/kube-scheduler.kubeconfig\n\n# 2、设置客户端认证参数\nkubectl config set-credentials system:kube-scheduler --client-certificate=kube-scheduler.pem --client-key=kube-scheduler-key.pem --embed-certs=true --kubeconfig=/etc/kubernetes/kube-scheduler.kubeconfig\n\n# 3、设置上下文参数\nkubectl config set-context system:kube-scheduler --cluster=kubernetes --user=system:kube-scheduler --kubeconfig=/etc/kubernetes/kube-scheduler.kubeconfig\n\n# 4、设置当前上下文\nkubectl config use-context system:kube-scheduler --kubeconfig=/etc/kubernetes/kube-scheduler.kubeconfig\n```\n\n#### 6.3、kube-scheduler.conf\n\n```sh\ncat > /etc/kubernetes/kube-scheduler.conf << \"EOF\"\nKUBE_SCHEDULER_OPTS=\"--address=127.0.0.1 \\\n  --kubeconfig=/etc/kubernetes/kube-scheduler.kubeconfig \\\n  --leader-elect=true \\\n  --alsologtostderr=true \\\n  --logtostderr=false \\\n  --log-dir=/var/log/kubernetes \\\n  --v=2\"\nEOF\n---\nfor i in `cat ~/MasterNodes.txt`;do echo $i;scp /etc/kubernetes/kube-scheduler* $i:/etc/kubernetes/;done\n```\n\n#### 6.4、kube-scheduler.service\n\n```sh\ncat > /usr/lib/systemd/system/kube-scheduler.service << \"EOF\"\n[Unit]\nDescription=Kubernetes Scheduler\nDocumentation=https://github.com/kubernetes/kubernetes\n\n[Service]\nEnvironmentFile=-/etc/kubernetes/kube-scheduler.conf\nExecStart=/usr/local/bin/kube-scheduler $KUBE_SCHEDULER_OPTS\nRestart=on-failure\nRestartSec=5\n\n[Install]\nWantedBy=multi-user.target\nEOF\n---\nfor i in `cat ~/MasterNodes.txt`;do echo $i;scp /usr/lib/systemd/system/kube-scheduler.service $i:/usr/lib/systemd/system/;done\n```\n\n#### 6.5、start kube-scheduler.service\n\n```sh\nsystemctl daemon-reload\nsystemctl enable --now kube-scheduler.service\nsystemctl status kube-scheduler.service\n```\n\n## 四、Node\n\n### 1、kubelet\n\n#### 1.1、BOOTSTRAP_TOKEN\n\n```sh\nBOOTSTRAP_TOKEN=$(awk -F \",\" '{print $1}' /etc/kubernetes/token.csv)\n```\n\n#### 1.2、kubelet-bootstrap.kubeconfig\n\n```sh\n# 1、设置集群参数\nkubectl config set-cluster kubernetes --certificate-authority=ca.pem --embed-certs=true --server=https://10.0.0.25:6444 --kubeconfig=/root/work/kubelet-bootstrap.kubeconfig\n\n# 2、设置客户端认证参数\nkubectl config set-credentials kubelet-bootstrap --token=${BOOTSTRAP_TOKEN} --kubeconfig=/root/work/kubelet-bootstrap.kubeconfig\n\n# 3、设置上下文参数\nkubectl config set-context default --cluster=kubernetes --user=kubelet-bootstrap --kubeconfig=/root/work/kubelet-bootstrap.kubeconfig\n\n# 4、设置当前上下文\nkubectl config use-context default --kubeconfig=/root/work/kubelet-bootstrap.kubeconfig\n\n# 5、创建clusterrolebinding\nkubectl delete clusterrolebinding kubelet-bootstrap\nkubectl create clusterrolebinding kubelet-bootstrap --clusterrole=system:node-bootstrapper --user=kubelet-bootstrap\nkubectl create clusterrolebinding cluster-system-anonymous --clusterrole=cluster-admin --user=kubelet-bootstrap\n```\n\n#### 1.3、kubelet.json\n\n```sh\ncat > ~/work/kubelet.json << \"EOF\"\n{\n \"kind\": \"KubeletConfiguration\",\n \"apiVersion\": \"kubelet.config.k8s.io/v1beta1\",\n \"authentication\": {\n   \"x509\": {\n     \"clientCAFile\": \"/etc/kubernetes/ssl/ca.pem\"\n   },\n   \"webhook\": {\n     \"enabled\": true,\n     \"cacheTTL\": \"2m0s\"\n   },\n   \"anonymous\": {\n     \"enabled\": false\n   }\n },\n \"authorization\": {\n   \"mode\": \"Webhook\",\n   \"webhook\": {\n     \"cacheAuthorizedTTL\": \"5m0s\",\n     \"cacheUnauthorizedTTL\": \"30s\"\n   }\n },\n \"address\": \"10.0.0.23\",\n \"port\": 10250,\n \"readOnlyPort\": 10255,\n \"cgroupDriver\": \"systemd\",\n \"hairpinMode\": \"promiscuous-bridge\",\n \"serializeImagePulls\": false,\n \"clusterDomain\": \"cluster.local.\",\n \"clusterDNS\": [\"10.96.0.2\"]\n}\nEOF\n```\n\n#### 1.4、kubelet.service\n\n```sh\ncat > ~/work/kubelet.service <<\"EOF\"\n[Unit]\nDescription=Kubernetes Kubelet\nDocumentation=https://github.com/kubernetes/kubernetes\nAfter=containerd.service\nRequires=containerd.service\n\n[Service]\nWorkingDirectory=/var/lib/kubelet\nExecStart=/usr/local/bin/kubelet \\\n --container-runtime=remote \\\n --container-runtime-endpoint=unix:///run/containerd/containerd.sock\n --bootstrap-kubeconfig=/etc/kubernetes/kubelet-bootstrap.kubeconfig \\\n --cert-dir=/etc/kubernetes/ssl \\\n --kubeconfig=/etc/kubernetes/kubelet.kubeconfig \\\n --config=/etc/kubernetes/kubelet.json \\\n --pod-infra-container-image=registry.aliyuncs.com/google_containers/pause:3.2 \\\n --v=2\nRestart=on-failure\nRestartSec=5\n\n[Install]\nWantedBy=multi-user.target\nEOF\n---\nfor i in `cat ~/WorkNodes.txt`;do echo $i;scp ~/work/kubelet.json ~/work/kubelet-bootstrap.kubeconfig $i:/etc/kubernetes;done\nfor i in `cat ~/WorkNodes.txt`;do echo $i;scp ~/work/kubelet.service $i:/usr/lib/systemd/system;done\nfor i in `cat ~/WorkNodes.txt`;do echo $i;scp /etc/kubernetes/ssl/ca.pem $i:/etc/kubernetes/ssl/;done\n```\n\n#### 1.5、start kubelet.services\n\n```sh\nmkdir -p /var/lib/kubelet\nsystemctl daemon-reload\nsystemctl enable --now kubelet.service\nsystemctl status kubelet.service\n```\n\n#### 1.6、Approve Nodes\n\n```sh\nkubectl get csr |grep node |awk '{print$1,$6}'\n\n\"+---                                                  |     ---+\"\n  node-csr-BV7RZ1Mc1RFkWhH9jzJH8h8on_dRMB3an_7FgBUwWhk   Pending\n  node-csr-wZOI__ACKylv7DlEPRK8iMg3_sYyBErjbGjxkMkRyPo   Pending\n\"+---                                                  |     ---+\"\n\nkubectl certificate approve node-csr-csr-BV7RZ1Mc1RFkWhH9jzJH8h8on_dRMB3an_7FgBUwWhk node-csr-wZOI__ACKylv7DlEPRK8iMg3_sYyBErjbGjxkMkRyPo\n\nkubectl get nodes\nNAME         STATUS   ROLES    AGE    VERSION\nk8s-node01   Ready    <none>   118m   v1.23.5\nk8s-node02   Ready    <none>   118m   v1.23.5\n```\n\n### 2、kube-pproxy\n\n#### 2.1、kube-proxy certificate\n\n```sh\ncat > kube-proxy-csr.json << \"EOF\"\n{\n  \"CN\": \"system:kube-proxy\",\n  \"key\": {\n    \"algo\": \"rsa\",\n    \"size\": 2048\n  },\n  \"names\": [\n    {\n      \"C\": \"CN\",\n      \"ST\": \"Shanghai\",\n      \"L\": \"Shanghai\",\n      \"O\": \"k8s\",\n      \"OU\": \"system\"\n    }\n  ]\n}\nEOF\n---\ncfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes kube-proxy-csr.json | cfssljson -bare kube-proxy\ncp kube-proxy*.pem /etc/kubernetes/ssl/\nfor i in `cat ~/WorkNodes.txt`;do echo $i;scp ~/work/kube-proxy*.pem $i:/etc/kubernetes/ssl/;done\n```\n\n#### 2.2、kube-proxy.kubeconfig\n\n```sh\n# 1、设置集群参数\nkubectl config set-cluster kubernetes --certificate-authority=ca.pem --embed-certs=true --server=https://10.0.0.25:6444 --kubeconfig=/root/work/kube-proxy.kubeconfig\n\n# 2、设置客户端认证参数\nkubectl config set-credentials kube-proxy --client-certificate=kube-proxy.pem --client-key=kube-proxy-key.pem --embed-certs=true --kubeconfig=/root/work/kube-proxy.kubeconfig\n\n# 3、设置上下文参数\nkubectl config set-context default --cluster=kubernetes --user=kube-proxy --kubeconfig=/root/work/kube-proxy.kubeconfig\n\n# 4、设置当前上下文\nkubectl config use-context default --kubeconfig=/root/work/kube-proxy.kubeconfig\n```\n\n#### 2.3、kube-proxy.yaml\n\n```sh\n# 以下bindAddress均为宿主机ip,clusterCIDR为宿主机网段\n---\ncat > ~/work/kube-proxy.yaml << \"EOF\"\napiVersion: kubeproxy.config.k8s.io/v1alpha1\nbindAddress: 10.0.0.23\nclientConnection:\n  kubeconfig: /etc/kubernetes/kube-proxy.kubeconfig\nclusterCIDR: 10.244.0.0/24\nhealthzBindAddress: 10.0.0.23:10256\nkind: KubeProxyConfiguration\nmetricsBindAddress: 10.0.0.23:10249\nmode: \"ipvs\"\nEOF\n---\nfor i in `cat ~/WorkNodes.txt`;do echo $i;scp ~/work/kube-proxy.yaml ~/work/kube-proxy.kubeconfig $i:/etc/kubernetes/;done\n```\n\n#### 2.4、kube-proxy.service\n\n```sh\ncat > ~/work/kube-proxy.service << \"EOF\"\n[Unit]\nDescription=Kubernetes Kube-Proxy Server\nDocumentation=https://github.com/kubernetes/kubernetes\nAfter=network.target\n\n[Service]\nWorkingDirectory=/var/lib/kube-proxy\nExecStart=/usr/local/bin/kube-proxy \\\n --config=/etc/kubernetes/kube-proxy.yaml \\\n --alsologtostderr=true \\\n --logtostderr=false \\\n --log-dir=/var/log/kubernetes \\\n --v=2\nRestart=on-failure\nRestartSec=5\nLimitNOFILE=65536\n\n[Install]\nWantedBy=multi-user.target\nEOF\n---\nfor i in `cat ~/WorkNodes.txt`;do echo $i;scp ~/work/kube-proxy.service $i:/usr/lib/systemd/system;done\n```\n\n#### 2.5、start kube-proxy.services\n\n```sh\nmkdir -p /var/lib/kube-proxy\nsystemctl daemon-reload\nsystemctl enable --now kube-proxy.service\nsystemctl status kube-proxy.service\n```\n\n## 五、network\n\n### 1、calico\n\n```sh\nwget https://docs.projectcalico.org/manifests/calico.yaml\nkubectl apply -f calico.yaml\n```\n\n### 2、coredns\n\n#### 2.1、resolv.conf\n\n```sh\nmv /etc/resolv.conf  /etc/resolv.conf.bak\nln -s /run/systemd/resolve/resolv.conf /etc/\nsystemctl restart systemd-resolved.service && systemctl enable systemd-resolved.service\n```\n\n#### 2.2、coredns.yaml\n\n```sh\napiVersion: v1\nkind: ServiceAccount\nmetadata:\n  name: coredns\n  namespace: kube-system\n---\napiVersion: rbac.authorization.k8s.io/v1\nkind: ClusterRole\nmetadata:\n  labels:\n    kubernetes.io/bootstrapping: rbac-defaults\n  name: system:coredns\nrules:\n  - apiGroups:\n    - \"\"\n    resources:\n    - endpoints\n    - services\n    - pods\n    - namespaces\n    verbs:\n    - list\n    - watch\n  - apiGroups:\n    - discovery.k8s.io\n    resources:\n    - endpointslices\n    verbs:\n    - list\n    - watch\n---\napiVersion: rbac.authorization.k8s.io/v1\nkind: ClusterRoleBinding\nmetadata:\n  annotations:\n    rbac.authorization.kubernetes.io/autoupdate: \"true\"\n  labels:\n    kubernetes.io/bootstrapping: rbac-defaults\n  name: system:coredns\nroleRef:\n  apiGroup: rbac.authorization.k8s.io\n  kind: ClusterRole\n  name: system:coredns\nsubjects:\n- kind: ServiceAccount\n  name: coredns\n  namespace: kube-system\n---\napiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: coredns\n  namespace: kube-system\ndata:\n  Corefile: |\n    .:53 {\n        errors\n        health {\n          lameduck 5s\n        }\n        ready\n        kubernetes cluster.local in-addr.arpa ip6.arpa {\n          fallthrough in-addr.arpa ip6.arpa\n        }\n        prometheus :9153\n        forward . /etc/resolv.conf {\n          max_concurrent 1000\n        }\n        cache 30\n        loop\n        reload\n        loadbalance\n    }\n---\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: coredns\n  namespace: kube-system\n  labels:\n    k8s-app: kube-dns\n    kubernetes.io/name: \"CoreDNS\"\nspec:\n  # replicas: not specified here:\n  # 1. Default is 1.\n  # 2. Will be tuned in real time if DNS horizontal auto-scaling is turned on.\n  strategy:\n    type: RollingUpdate\n    rollingUpdate:\n      maxUnavailable: 1\n  selector:\n    matchLabels:\n      k8s-app: kube-dns\n  template:\n    metadata:\n      labels:\n        k8s-app: kube-dns\n    spec:\n      priorityClassName: system-cluster-critical\n      serviceAccountName: coredns\n      tolerations:\n        - key: \"CriticalAddonsOnly\"\n          operator: \"Exists\"\n      nodeSelector:\n        kubernetes.io/os: linux\n      affinity:\n         podAntiAffinity:\n           preferredDuringSchedulingIgnoredDuringExecution:\n           - weight: 100\n             podAffinityTerm:\n               labelSelector:\n                 matchExpressions:\n                   - key: k8s-app\n                     operator: In\n                     values: [\"kube-dns\"]\n               topologyKey: kubernetes.io/hostname\n      containers:\n      - name: coredns\n        image: coredns/coredns:1.8.4\n        imagePullPolicy: IfNotPresent\n        resources:\n          limits:\n            memory: 170Mi\n          requests:\n            cpu: 100m\n            memory: 70Mi\n        args: [ \"-conf\", \"/etc/coredns/Corefile\" ]\n        volumeMounts:\n        - name: config-volume\n          mountPath: /etc/coredns\n          readOnly: true\n        ports:\n        - containerPort: 53\n          name: dns\n          protocol: UDP\n        - containerPort: 53\n          name: dns-tcp\n          protocol: TCP\n        - containerPort: 9153\n          name: metrics\n          protocol: TCP\n        securityContext:\n          allowPrivilegeEscalation: false\n          capabilities:\n            add:\n            - NET_BIND_SERVICE\n            drop:\n            - all\n          readOnlyRootFilesystem: true\n        livenessProbe:\n          httpGet:\n            path: /health\n            port: 8080\n            scheme: HTTP\n          initialDelaySeconds: 60\n          timeoutSeconds: 5\n          successThreshold: 1\n          failureThreshold: 5\n        readinessProbe:\n          httpGet:\n            path: /ready\n            port: 8181\n            scheme: HTTP\n      dnsPolicy: Default\n      volumes:\n        - name: config-volume\n          configMap:\n            name: coredns\n            items:\n            - key: Corefile\n              path: Corefile\n---\napiVersion: v1\nkind: Service\nmetadata:\n  name: kube-dns\n  namespace: kube-system\n  annotations:\n    prometheus.io/port: \"9153\"\n    prometheus.io/scrape: \"true\"\n  labels:\n    k8s-app: kube-dns\n    kubernetes.io/cluster-service: \"true\"\n    kubernetes.io/name: \"CoreDNS\"\nspec:\n  selector:\n    k8s-app: kube-dns\n  clusterIP: 10.96.0.2\n  ports:\n  - name: dns\n    port: 53\n    protocol: UDP\n  - name: dns-tcp\n    port: 53\n    protocol: TCP\n  - name: metrics\n    port: 9153\n    protocol: TCP\n```\n\n#### 2.3、install\n\n```sh\nkubectl apply -f coredns.yaml\n```\n\n","source":"_posts/k8s-containerd.md","raw":"---\ntitle: 二进制高可用安装\ncover: https://acg.toubiec.cn/random.php\ntags: kubernetes\n---\n\nubuntu install kubernetes(containerd)\n\n<!-- more -->\n\n## 一、Prepare\n\n### 1、system\n\n```sh\n# 1、sources.list\nmv /etc/apt/sources.list /etc/apt/sources.list.bak\ncat  /etc/apt/sources.list.bak |grep -v \"#\" |grep -v \"^$\" > sources.list\nsed -i s/archive.ubuntu.com/mirrors.ustc.edu.cn/g /etc/apt/sources.list\nsed -i s/security.ubuntu.com/mirrors.ustc.edu.cn/g /etc/apt/sources.list\napt -y update && apt -y upgrade\n\n# 2、timedatectl\nsed -i s/en_US/C/g /etc/default/locale\ntimedatectl set-timezone Asia/Shanghai\n\n# 3、bash-completion\nsed -i 97,99s/#//g /root/.bashrc\n\n# 4、ssh\necho \"PermitRootLogin yes\" >> /etc/ssh/sshd_config\npasswd root << \"EOF\"\npassword\npassword\nEOF\nsystemctl reload ssh\n\n# 5、hosts\nvim /etc/hosts\n10.0.0.20 k8s-master00\n10.0.0.21 k8s-master01\n10.0.0.22 k8s-master02\n10.0.0.23 k8s-node01\n10.0.0.24 k8s-node02\n10.0.0.25 k8s-bl-master\n\n# 6、ssh-keygen\nssh-keygen -t rsa\nfor i in `cat /root/*.txt`;do echo $i;ssh-copy-id -i .ssh/id_rsa.pub $i;done\n\n# 7、swap\nswapoff -a\nsed -i '/swap/s/^\\(.*\\)$/#\\1/g' /etc/fstab\n\n# 8、network\nnet=`cat /etc/netplan/00-installer-config.yaml |awk 'NR==4{print $1}'`\nsed -i \"s/${net}/eth0:/g\" /etc/netplan/00-installer-config.yaml\nsed -i '11s/\"\"/\"net.ifnames=0 biosdevname=0\"/g' /etc/default/grub\nupdate-grub\nreboot\n```\n### 2、ipvs\n\n```sh\napt -y install ipvsadm ipset sysstat conntrack libseccomp2 libseccomp-dev\ncat > /etc/modules-load.d/ipvs.conf << EOF\nip_vs\nip_vs_lc\nip_vs_wlc\nip_vs_rr\nip_vs_wrr\nip_vs_lblc\nip_vs_lblcr\nip_vs_dh\nip_vs_sh\nip_vs_fo\nip_vs_nq\nip_vs_sed\nip_vs_ftp\nnf_conntrack\nip_tables\nip_set\nxt_set\nipt_set\nipt_rpfilter\nipt_REJECT\nipip\nEOF\nsystemctl restart systemd-modules-load.service\nlsmod |grep -e ip_vs -e nf_conntrack_ipv4\n```\n\n### 3、containerd\n\n#### 3.1、download containerd\n\n```sh\nwget https://github.com/containerd/containerd/releases/download/v1.6.1/cri-containerd-cni-1.6.1-linux-amd64.tar.gz\ntar --no-overwrite-dir -C / -xzf cri-containerd-cni-1.6.1-linux-amd64.tar.gz\nsystemctl daemon-reload\nsystemctl enable --now containerd\n```\n\n#### 3.2、config.toml\n\n```sh\ncontainerd config default > /etc/containerd/config.toml\n---\nsed -i \"s#k8s.gcr.io#registry.aliyuncs.com/google_containers#g\" /etc/containerd/config.toml\nsed -i \"s#SystemdCgroup = false#SystemdCgroup = true#g\" /etc/containerd/config.toml\nsed -i '153a\\        [plugins.\"io.containerd.grpc.v1.cri\".registry.mirrors.\"docker.io\"]' /etc/containerd/config.toml  # 8个空格 # endpoint 10个空格\nsed -i '154a\\          endpoint = [\"https://registry.aliyuncs.com\"]' /etc/containerd/config.toml\n```\n\n#### 3.3、crictl.yaml\n\n```sh\nmv /etc/crictl.yaml /etc/crictl.yaml.bak\ncat > /etc/crictl.yaml << \"EOF\"\nruntime-endpoint: unix:///run/containerd/containerd.sock\nimage-endpoint: unix:///run/containerd/containerd.sock\ntimeout: 0\ndebug: false\npull-image-on-create: false\ndisable-pull-on-run: false\nEOF\n```\n\n## 二、High availability\n\n### 1、nginx.conf\n\n```sh\napt -y install nginx\ncp /etc/nginx/nginx.conf /etc/nginx/nginx.conf.bak\nvim /etc/nginx/nginx.conf\n---\n...\n...\nstream {\n          \n        log_format main '$remote_addr $upstream_addr - [$time_local] $status $upstream_bytes_sent';\n          \n        access_log /var/log/nginx/k8s-access.log main;\n        \n        upstream k8s-apiserver {\n                server 10.0.0.20:6443;\n                server 10.0.0.21:6443;\n                server 10.0.0.22:6443;\n        }\n    \n        server {\n                listen 6444; \n                proxy_pass k8s-apiserver;\n        }\n}\n\nhttp {\n\t\tlog_format main '$remote_addr - $remote_user [$time_local] \"$request\" '\n                        '$status $body_bytes_sent \"$http_referer\" '\n                        '\"$http_user_agent\" \"$http_x_forwarded_for\"';\n        ...\n        ...\n}\n---\nsystemctl enable --now nginx.service\nsystemctl status nginx.service\n```\n\n### 2、keepalived.conf\n\n```sh\napt -y install keepalived\n#keepalived config\ncat > /etc/keepalived/keepalived.conf << \"EOF\"\nglobal_defs {\n    notification_email {\n      acassen@firewall.loc\n      failover@firewall.loc\n      sysadmin@firewall.loc\n    }\n    notification_email_from Alexandre.Cassen@firewall.loc\n    smtp_server 127.0.0.1\n    smtp_connect_timeout 30 \n    router_id NGINX_MASTER\n}\n\nvrrp_script check_nginx {\n  script \"/etc/keepalived/check_nginx.sh\"\n  interval 5\n  weight -1\n  fall 2\n  rise 1\n}\n\nvrrp_instance VI_1 {\n    state MASTER\n    interface eth0 # 修改为实际网卡名\n    virtual_router_id 51 # VRRP 路由 ID 实例，每个实例是唯一的\n    priority 100 # 优先级，备服务器设置 90\n    advert_int 1 # 指定 VRRP 心跳包通告间隔时间，默认 1 秒\n    authentication {\n        auth_type PASS\n        auth_pass K8SHA_KA_AUTH\n    }\n    # 虚拟 IP\n    virtual_ipaddress {\n        10.0.0.25/24\n    }\n    track_script {\n        check_nginx\n    }\n}\nEOF\n#health config\ncat > /etc/keepalived/check_nginx.sh << \"EOF\"\n#!/bin/bash \ncount=$(ps -ef |grep nginx | grep sbin | egrep -cv \"grep|$$\") \nif [ \"$count\" -eq 0 ];then \n  systemctl stop keepalived \nfi\nEOF\n---\nsystemctl enable --now keepalived.service\nsystemctl status keepalived.service\n```\n\n## 三、Master\n\n### 1、cfssl\n\n```sh\nwget https://github.com/cloudflare/cfssl/releases/download/v1.6.1/cfssl_1.6.1_linux_amd64 -O /usr/local/bin/cfssl\nwget https://github.com/cloudflare/cfssl/releases/download/v1.6.1/cfssljson_1.6.1_linux_amd64 -O /usr/local/bin/cfssljson\nwget https://github.com/cloudflare/cfssl/releases/download/v1.6.1/cfssl-certinfo_1.6.1_linux_amd64 -O /usr/local/bin/cfssl-certinfo\nchmod +x /usr/local/bin/cfssl*\nchown -Rf root:root /usr/local/bin/cfssl*\n```\n\n### 2、etcd\n\n#### 2.1、mkdir directory\n\n```sh\n# all Master\n# 1、etcd-ssl\nmkdir -p /etc/etcd/ssl/\n# 2、etcd-WorkingDirectory\nmkdir -p /var/lib/etcd/default.etcd\n# 3、kubernetes-ssl\nmkdir -p /etc/kubernetes/ssl\n# 4、kubernetes-log\nmkdir -p /var/log/kubernetes\n```\n\n#### 2.2、ca certificate\n\n```sh\n# master00\nmkdir -p ~/work\ncd ~/work/\n---\ncat > ca-csr.json << \"EOF\"\n{\n  \"CN\": \"kubernetes\",\n  \"key\": {\n    \"algo\": \"rsa\",\n    \"size\": 2048\n  },\n  \"names\": [\n    {\n      \"C\": \"CN\",\n      \"ST\": \"Shanghai\",\n      \"L\": \"Shanghai\",\n      \"O\": \"k8s\",\n      \"OU\": \"system\"\n    }\n  ]\n}\nEOF\n---\ncat > ca-config.json << \"EOF\"\n{\n  \"signing\": {\n    \"default\": {\n      \"expiry\": \"87600h\"\n    },\n    \"profiles\": {\n      \"kubernetes\": {\n        \"usages\": [\n            \"signing\",\n            \"key encipherment\",\n            \"server auth\",\n            \"client auth\"\n        ],\n        \"expiry\": \"87600h\"\n      }\n    }\n  }\n}\nEOF\n---\ncfssl gencert -initca ca-csr.json | cfssljson -bare ca\ncp ca*.pem /etc/etcd/ssl/\n---\n# send to other master\nfor i in `cat ~/MasterNodes.txt`;do echo $i;scp /etc/etcd/ssl/ca*.pem $i:/etc/etcd/ssl;done\n```\n\n#### 2.3、etcd certificate\n\n```sh\ncat > etcd-csr.json << \"EOF\"\n{\n  \"CN\": \"etcd\",\n  \"hosts\": [\n    \"127.0.0.1\",\n    \"10.0.0.20\",\n    \"10.0.0.21\",\n    \"10.0.0.22\",\n    \"10.0.0.25\"\n  ],\n  \"key\": {\n    \"algo\": \"rsa\",\n    \"size\": 2048\n  },\n  \"names\": [\n    {\n      \"C\": \"CN\",\n      \"ST\": \"Shanghai\",\n      \"L\": \"Shanghai\",\n      \"O\": \"k8s\",\n      \"OU\": \"system\"\n    }\n  ]\n}\nEOF\n---\ncfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes etcd-csr.json | cfssljson -bare etcd\ncp etcd*.pem /etc/etcd/ssl/\n---\n# send to other\nfor i in `cat ~/MasterNodes.txt`;do echo $i;scp /etc/etcd/ssl/etcd*.pem $i:/etc/etcd/ssl;done\n```\n\n#### 2.4、install etcd{,ctl}\n\n```sh\n# download etcd\nwget https://github.com/etcd-io/etcd/releases/download/v3.5.0/etcd-v3.5.0-linux-amd64.tar.gz\n# tar etcd-*.tar.gz\ntar -xf etcd-v3.5.0-linux-amd64.tar.gz --strip-components=1 -C ~/work/ etcd-v3.5.0-linux-amd64/etcd{,ctl}\nchown -Rf root:root etcd*\ncp -arp etcd* /usr/local/bin/\n# send to other\nfor i in `cat ~/MasterNodes.txt`;do echo $i;scp /usr/local/bin/etcd{,ctl} $i:/usr/local/bin/;done\n```\n\n#### 2.5、etcd.conf\n\n```sh\ncat > /etc/etcd/etcd.conf << \"EOF\"\nETCD_NAME='etcd1'\nETCD_DATA_DIR=\"/var/lib/etcd/default.etcd\"\nETCD_LISTEN_PEER_URLS=\"https://10.0.0.20:2380\" # change ip\nETCD_LISTEN_CLIENT_URLS=\"https://10.0.0.20:2379,http://127.0.0.1:2379\" # change ip\nETCD_INITIAL_ADVERTISE_PEER_URLS=\"https://10.0.0.20:2380\" # change ip\nETCD_ADVERTISE_CLIENT_URLS=\"https://10.0.0.20:2379\" # change ip\nETCD_INITIAL_CLUSTER=\"etcd1=https://10.0.0.20:2380,etcd2=https://10.0.0.21:2380,etcd3=https://10.0.0.22:2380\"\nETCD_INITIAL_CLUSTER_TOKEN=\"etcd-cluster\"\nETCD_INITIAL_CLUSTER_STATE=\"new\"\nEOF\n```\n\n#### 2.6、etcd.service\n\n```sh\ncat > /usr/lib/systemd/system/etcd.service << \"EOF\"\n[Unit]\nDescription=Etcd Service\nAfter=network.target\nAfter=network-online.target\nWants=network-online.target\n\n[Service]\nType=notify\nEnvironmentFile=-/etc/etcd/etcd.conf\nWorkingDirectory=/var/lib/etcd/\nExecStart=/usr/local/bin/etcd \\\n --cert-file=/etc/etcd/ssl/etcd.pem \\\n --key-file=/etc/etcd/ssl/etcd-key.pem \\\n --trusted-ca-file=/etc/etcd/ssl/ca.pem \\\n --peer-cert-file=/etc/etcd/ssl/etcd.pem \\\n --peer-key-file=/etc/etcd/ssl/etcd-key.pem \\\n --peer-trusted-ca-file=/etc/etcd/ssl/ca.pem \\\n --peer-client-cert-auth \\\n --client-cert-auth\nRestart=on-failure\nRestartSec=10\nLimitNOFILE=65536\n\n[Install]\nWantedBy=multi-user.target\nEOF\n---\n# send to other\nfor i in `cat ~/MasterNodes.txt`;do echo $i;scp /usr/lib/systemd/system/etcd.service $i:/usr/lib/systemd/system/;done\n```\n\n#### 2.7、start etcd.service\n\n```sh\n# 1、start etcd\nsystemctl daemon-reload\nsystemctl enable --now etcd.service\nsystemctl status etcd.service\n# 2、check etcd\nETCDCTL_API=3\netcdctl --endpoints=https://10.0.0.20:2379,https://10.0.0.21:2379,https://10.0.0.22:2379 --write-out=table --cacert=/etc/etcd/ssl/ca.pem --cert=/etc/etcd/ssl/etcd.pem --key=/etc/etcd/ssl/etcd-key.pem endpoint health\n+----------------------------+--------+-------------+-------+\n|          ENDPOINT          | HEALTH |    TOOK     | ERROR |\n+----------------------------+--------+-------------+-------+\n| https://10.0.0.20:2379     |   true | 16.188005ms |       |\n| https://10.0.0.21:2379     |   true | 16.693314ms |       |\n| https://10.0.0.22:2379     |   true | 16.089367ms |       |\n+----------------------------+--------+-------------+-------+\n```\n\n#### 2.8、kube{...}\n\n```sh\n# 1、download\nwget https://dl.k8s.io/v1.23.5/kubernetes-server-linux-amd64.tar.gz\n# 2、tar\ntar -xf kubernetes-server-linux-amd64.tar.gz --strip-components=3 -C ~/work kubernetes/server/bin/kube{let,ctl,-apiserver,-controller-manager,-scheduler,-proxy}\n\nscp kube{ctl,-apiserver,-controller-manager,-scheduler} /usr/local/bin/\n# 3、kube{let,ctl,-apiserver,-controller-manager,-scheduler,-proxy}\nfor i in `cat ~/MasterNodes.txt`;do echo $i;scp ~/work/kube{ctl,-apiserver,-controller-manager,-scheduler} $i:/usr/local/bin/;done\n# 4、kube{let,-proxy}\nfor i in `cat ~/WorkNodes.txt`;do echo $i;scp ~/work/kube{let,-proxy} $i:/usr/local/bin/;done\n# 5、send pem\ncp /etc/etcd/ssl/ca*.pem /etc/kubernetes/ssl/\nfor i in `cat ~/WorkNodes.txt`;do echo $i;scp /etc/etcd/ssl/ca*.pem $i:/etc/kubernetes/ssl/;done\n```\n\n### 3、kube-apiserver\n\n#### 3.1、token.csv\n\n```sh\ncat  > /etc/kubernetes/token.csv <<EOF\n$(head -c 16 /dev/urandom | od -An -t x | tr -d ' '),kubelet-bootstrap,10001,\"system:kubelet-bootstrap\"\nEOF\nfor i in `cat ~/MasterNodes.txt`;do echo $i;scp /etc/kubernetes/token.csv $i:/etc/kubernetes/;done\n```\n\n#### 3.2、kube-apiserver certificate\n\n```sh\ncat > kube-apiserver-csr.json << \"EOF\"\n{\n  \"CN\": \"kubernetes\",\n  \"hosts\": [\n    \"127.0.0.1\",\n    \"10.0.0.20\",\n    \"10.0.0.21\",\n    \"10.0.0.22\",\n    \"10.0.0.23\",\n    \"10.0.0.24\",\n    \"10.0.0.25\",\n    \"10.96.0.1\",\n    \"kubernetes\",\n    \"kubernetes.default\",\n    \"kubernetes.default.svc\",\n    \"kubernetes.default.svc.cluster\",\n    \"kubernetes.default.svc.cluster.local\"\n  ],\n  \"key\": {\n    \"algo\": \"rsa\",\n    \"size\": 2048\n  },\n  \"names\": [\n    {\n      \"C\": \"CN\",\n      \"ST\": \"Shanghai\",\n      \"L\": \"Shanghai\",\n      \"O\": \"k8s\",\n      \"OU\": \"system\"\n    }\n  ]\n}\nEOF\n---\ncfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes kube-apiserver-csr.json | cfssljson -bare kube-apiserver\ncp kube-apiserver*.pem /etc/kubernetes/ssl/\nfor i in `cat ~/MasterNodes.txt`;do echo $i;scp ~/work/kube-apiserver*.pem $i:/etc/kubernetes/ssl/;done\n```\n\n#### 3.3、kube-apiserver.conf\n\n```sh\n# change --bind-address= and --advertise-address=\n---\ncat > /etc/kubernetes/kube-apiserver.conf << \"EOF\"\nKUBE_APISERVER_OPTS=\"--enable-admission-plugins=NamespaceLifecycle,NodeRestriction,LimitRanger,ServiceAccount,DefaultStorageClass,ResourceQuota \\\n --anonymous-auth=false \\\n --bind-address=10.0.0.20 \\\n --secure-port=6443 \\\n --advertise-address=10.0.0.20 \\\n --insecure-port=0 \\\n --authorization-mode=Node,RBAC \\\n --runtime-config=api/all=true \\\n --enable-bootstrap-token-auth \\\n --service-cluster-ip-range=10.96.0.0/16 \\\n --token-auth-file=/etc/kubernetes/token.csv \\\n --service-node-port-range=30000-50000 \\\n --tls-cert-file=/etc/kubernetes/ssl/kube-apiserver.pem \\\n --tls-private-key-file=/etc/kubernetes/ssl/kube-apiserver-key.pem \\\n --client-ca-file=/etc/kubernetes/ssl/ca.pem \\\n --kubelet-client-certificate=/etc/kubernetes/ssl/kube-apiserver.pem \\\n --kubelet-client-key=/etc/kubernetes/ssl/kube-apiserver-key.pem \\\n --service-account-key-file=/etc/kubernetes/ssl/ca-key.pem \\\n --service-account-signing-key-file=/etc/kubernetes/ssl/ca-key.pem \\\n --service-account-issuer=https://kubernetes.default.svc.cluster.local \\\n --etcd-cafile=/etc/etcd/ssl/ca.pem \\\n --etcd-certfile=/etc/etcd/ssl/etcd.pem \\\n --etcd-keyfile=/etc/etcd/ssl/etcd-key.pem \\\n --etcd-servers=https://10.0.0.20:2379,https://10.0.0.21:2379,https://10.0.0.22:2379 \\\n --enable-swagger-ui=true \\\n --allow-privileged=true \\\n --apiserver-count=3 \\\n --audit-log-maxage=30 \\\n --audit-log-maxbackup=3 \\\n --audit-log-maxsize=100 \\\n --audit-log-path=/var/log/kube-apiserver-audit.log \\\n --event-ttl=1h \\\n --alsologtostderr=true \\\n --logtostderr=false \\\n --log-dir=/var/log/kubernetes \\\n --v=4\"\nEOF\n```\n\n#### 3.4、kube-apiserver.service\n\n```sh\ncat > /usr/lib/systemd/system/kube-apiserver.service << \"EOF\"\n[Unit]\nDescription=Kubernetes API Server\nDocumentation=https://github.com/kubernetes/kubernetes\nAfter=etcd.service\nWants=etcd.service\n\n[Service]\nEnvironmentFile=-/etc/kubernetes/kube-apiserver.conf\nExecStart=/usr/local/bin/kube-apiserver $KUBE_APISERVER_OPTS\nRestart=on-failure\nRestartSec=5\nType=notify\nLimitNOFILE=65536\n\n[Install]\nWantedBy=multi-user.target\nEOF\n---\nfor i in `cat ~/MasterNodes.txt`;do echo $i;scp /usr/lib/systemd/system/kube-apiserver.service $i:/usr/lib/systemd/system/;done\n```\n\n#### 3.5、start kube-apiserver.service\n\n```sh\nsystemctl daemon-reload\nsystemctl enable --now kube-apiserver.service\nsystemctl status kube-apiserver.service\n---\n# check\ncurl --insecure https://10.0.0.20:6443\n---\n{\n  \"kind\": \"Status\",\n  \"apiVersion\": \"v1\",\n  \"metadata\": {},\n  \"status\": \"Failure\",\n  \"message\": \"Unauthorized\",\n  \"reason\": \"Unauthorized\",\n  \"code\": 401\n```\n\n### 4、kubectl\n\n#### 4.1、admin certificate\n\n```sh\ncat > admin-csr.json << \"EOF\"\n{\n  \"CN\": \"admin\",\n  \"hosts\": [],\n  \"key\": {\n    \"algo\": \"rsa\",\n    \"size\": 2048\n  },\n  \"names\": [\n    {\n      \"C\": \"CN\",\n      \"ST\": \"Shanghai\",\n      \"L\": \"Shanghai\",\n      \"O\": \"system:masters\",\n      \"OU\": \"system\"\n    }\n  ]\n}\nEOF\n---\ncfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes admin-csr.json | cfssljson -bare admin\ncp admin*.pem /etc/kubernetes/ssl/\n---\nfor i in `cat ~/MasterNodes.txt`;do echo $i;scp /etc/kubernetes/ssl/admin*.pem $i:/etc/kubernetes/ssl/;done \n```\n\n#### 4.2、admin.config\n\n```sh\n# 1、设置集群参数\nkubectl config set-cluster kubernetes --certificate-authority=ca.pem --embed-certs=true --server=https://10.0.0.25:6444 --kubeconfig=admin.config\n\n# 2、设置客户端认证参数\nkubectl config set-credentials kubernetes-admin --client-certificate=admin.pem --client-key=admin-key.pem --embed-certs=true --kubeconfig=admin.config\n\n# 3、设置上下文参数\nkubectl config set-context kubernetes --cluster=kubernetes --user=kubernetes-admin --kubeconfig=admin.config\n\n# 4、设置当前上下文\nkubectl config use-context kubernetes --kubeconfig=admin.config\n```\n\n#### 4.3、kubernetes-kubelet api\n\n```sh\nkubectl create clusterrolebinding kube-apiserver:kubelet-apiserver --clusterrole=system.kubelet-api-admin --user kubernetes\nkubectl create clusterrolebinding kubernetes --clusterrole=cluster-admin --user=kubernetes\n```\n\n#### 4.4、send to other\n\n```sh\ncp ~/work/admin.config /etc/kubernetes\nmkdir -p $HOME/.kube\ncp -i /etc/kubernetes/admin.config $HOME/.kube/config\nchown $(id -u):$(id -g) $HOME/.kube/config\n\nfor i in `cat ~/MasterNodes.txt`;do echo $i;scp /etc/kubernetes/admin.config $i:/etc/kubernetes/;done\n\necho \"export KUBECONFIG=/etc/kubernetes/admin.config\" >> /etc/profile\nsource /etc/profile\n```\n\n#### 4.5、kubectl(bash-completion)\n\n```sh\nsource <(kubectl completion bash)\necho \"source <(kubectl completion bash)\" >> /etc/profile\nsource /etc/profile\n```\n\n#### 4.6、verify kubectl\n\n```sh\nkubectl cluster-info\n---\n{Kubernetes control plane is running at https://10.0.0.20:6443}\n---\nkubectl get componentstatuses\n---\nNAME                 STATUS      MESSAGE                                                                                        ERROR\nscheduler            Unhealthy   Get \"https://127.0.0.1:10259/healthz\": dial tcp 127.0.0.1:10259: connect: connection refused   \ncontroller-manager   Unhealthy   Get \"https://127.0.0.1:10257/healthz\": dial tcp 127.0.0.1:10257: connect: connection refused   \netcd-0               Healthy     {\"health\":\"true\",\"reason\":\"\"}                                           \netcd-1               Healthy     {\"health\":\"true\",\"reason\":\"\"}                                           \netcd-2               Healthy     {\"health\":\"true\",\"reason\":\"\"}                                           \n---\nkubectl get all --all-namespaces\n---\nNAMESPACE   NAME                 TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE\ndefault     service/kubernetes   ClusterIP   10.96.0.1   <none>        443/TCP   56m\n```\n\n### 5、kube-controller-manager\n\n#### 5.1、kube-controller-manager certificate\n\n```sh\ncat > kube-controller-manager-csr.json << \"EOF\"\n{\n  \"CN\": \"system:kube-controller-manager\",\n  \"hosts\": [\n    \"127.0.0.1\",\n    \"10.0.0.20\",\n    \"10.0.0.21\",\n    \"10.0.0.22\",\n    \"10.0.0.25\"\n  ],\n  \"key\": {\n    \"algo\": \"rsa\",\n    \"size\": 2048\n  },\n  \"names\": [\n    {\n      \"C\": \"CN\",\n      \"ST\": \"Shanghai\",\n      \"L\": \"Shanghai\",\n      \"O\": \"system:kube-controller-manager\",\n      \"OU\": \"Kubernetes\"\n    }\n  ]\n}\nEOF\n---\ncfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes kube-controller-manager-csr.json | cfssljson -bare kube-controller-manager\ncp kube-controller-manager*.pem /etc/kubernetes/ssl/\nfor i in `cat ~/MasterNodes.txt`;do echo $i;scp /etc/kubernetes/ssl/kube-controller-manager*.pem $i:/etc/kubernetes/ssl/;done\n```\n\n#### 5.2、kube-controller-manager.kubeconfig\n\n```sh\n# 1、设置集群参数\nkubectl config set-cluster kubernetes --certificate-authority=ca.pem --embed-certs=true --server=https://10.0.0.25:6444 --kubeconfig=/etc/kubernetes/kube-controller-manager.kubeconfig\n\n# 2、设置客户端认证参数\nkubectl config set-credentials system:kube-controller-manager --client-certificate=kube-controller-manager.pem --client-key=kube-controller-manager-key.pem --embed-certs=true --kubeconfig=/etc/kubernetes/kube-controller-manager.kubeconfig\n\n# 3、设置上下文参数\nkubectl config set-context system:kube-controller-manager --cluster=kubernetes --user=system:kube-controller-manager --kubeconfig=/etc/kubernetes/kube-controller-manager.kubeconfig\n\n# 4、设置当前上下文\nkubectl config use-context system:kube-controller-manager --kubeconfig=/etc/kubernetes/kube-controller-manager.kubeconfig\n```\n\n#### 5.3、kube-controller-manager.conf\n\n```sh\ncat > /etc/kubernetes/kube-controller-manager.conf << \"EOF\"\nKUBE_CONTROLLER_MANAGER_OPTS=\"--v=2 \\\n  --secure-port=10257 \\\n  --bind-address=127.0.0.1 \\\n  --kubeconfig=/etc/kubernetes/kube-controller-manager.kubeconfig \\\n  --service-cluster-ip-range=10.96.0.0/16 \\\n  --cluster-name=kubernetes \\\n  --cluster-signing-cert-file=/etc/kubernetes/ssl/ca.pem \\\n  --cluster-signing-key-file=/etc/kubernetes/ssl/ca-key.pem \\\n  --allocate-node-cidrs=true \\\n  --cluster-cidr=10.244.0.0/16 \\\n  --experimental-cluster-signing-duration=87600h \\\n  --root-ca-file=/etc/kubernetes/ssl/ca.pem \\\n  --service-account-private-key-file=/etc/kubernetes/ssl/ca-key.pem \\\n  --leader-elect=true \\\n  --feature-gates=RotateKubeletServerCertificate=true \\\n  --controllers=*,bootstrapsigner,tokencleaner \\\n  --horizontal-pod-autoscaler-sync-period=10s \\\n  --tls-cert-file=/etc/kubernetes/ssl/kube-controller-manager.pem \\\n  --tls-private-key-file=/etc/kubernetes/ssl/kube-controller-manager-key.pem \\\n  --use-service-account-credentials=true\"\nEOF\n  ---\nfor i in `cat ~/MasterNodes.txt`;do echo $i;scp /etc/kubernetes/kube-controller-manager* $i:/etc/kubernetes/;done\n```\n\n#### 5.4、kube-controller-manager.service\n\n```sh\ncat > /usr/lib/systemd/system/kube-controller-manager.service << \"EOF\"\n[Unit]\nDescription=Kubernetes Controller Manager\nDocumentation=https://github.com/kubernetes/kubernetes\n\n[Service]\nEnvironmentFile=-/etc/kubernetes/kube-controller-manager.conf\nExecStart=/usr/local/bin/kube-controller-manager $KUBE_CONTROLLER_MANAGER_OPTS\nRestart=on-failure\nRestartSec=5\n\n[Install]\nWantedBy=multi-user.target\nEOF\n---\nfor i in `cat ~/MasterNodes.txt`;do echo $i;scp /usr/lib/systemd/system/kube-controller-manager.service $i:/usr/lib/systemd/system/;done\n```\n\n#### 5.5、start kube-controller-manager.service\n\n```sh\nsystemctl daemon-reload\nsystemctl enable --now kube-controller-manager.service\nsystemctl status kube-controller-manager.service\n```\n\n### 6、kube-scheduler\n\n#### 6.1、kube-scheduler certificate\n\n```sh\ncat > kube-scheduler-csr.json << \"EOF\"\n{\n  \"CN\": \"system:kube-scheduler\",\n  \"hosts\": [\n    \"127.0.0.1\",\n    \"10.0.0.20\",\n    \"10.0.0.21\",\n    \"10.0.0.22\",\n    \"10.0.0.25\"\n  ],\n  \"key\": {\n    \"algo\": \"rsa\",\n    \"size\": 2048\n  },\n  \"names\": [\n    {\n      \"C\": \"CN\",\n      \"ST\": \"Shanghai\",\n      \"L\": \"Shanghai\",\n      \"O\": \"system:kube-scheduler\",\n      \"OU\": \"system\"\n    }\n  ]\n}\nEOF\n---\ncfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes kube-scheduler-csr.json | cfssljson -bare kube-scheduler\ncp kube-scheduler*.pem /etc/kubernetes/ssl/\nfor i in `cat ~/MasterNodes.txt`;do echo $i;scp /etc/kubernetes/ssl/kube-scheduler*.pem $i:/etc/kubernetes/ssl/;done\n```\n\n#### 6.2、kube-scheduler.kubeconfig\n\n```sh\n# 1、设置集群参数\nkubectl config set-cluster kubernetes --certificate-authority=ca.pem --embed-certs=true --server=https://10.0.0.25:6444 --kubeconfig=/etc/kubernetes/kube-scheduler.kubeconfig\n\n# 2、设置客户端认证参数\nkubectl config set-credentials system:kube-scheduler --client-certificate=kube-scheduler.pem --client-key=kube-scheduler-key.pem --embed-certs=true --kubeconfig=/etc/kubernetes/kube-scheduler.kubeconfig\n\n# 3、设置上下文参数\nkubectl config set-context system:kube-scheduler --cluster=kubernetes --user=system:kube-scheduler --kubeconfig=/etc/kubernetes/kube-scheduler.kubeconfig\n\n# 4、设置当前上下文\nkubectl config use-context system:kube-scheduler --kubeconfig=/etc/kubernetes/kube-scheduler.kubeconfig\n```\n\n#### 6.3、kube-scheduler.conf\n\n```sh\ncat > /etc/kubernetes/kube-scheduler.conf << \"EOF\"\nKUBE_SCHEDULER_OPTS=\"--address=127.0.0.1 \\\n  --kubeconfig=/etc/kubernetes/kube-scheduler.kubeconfig \\\n  --leader-elect=true \\\n  --alsologtostderr=true \\\n  --logtostderr=false \\\n  --log-dir=/var/log/kubernetes \\\n  --v=2\"\nEOF\n---\nfor i in `cat ~/MasterNodes.txt`;do echo $i;scp /etc/kubernetes/kube-scheduler* $i:/etc/kubernetes/;done\n```\n\n#### 6.4、kube-scheduler.service\n\n```sh\ncat > /usr/lib/systemd/system/kube-scheduler.service << \"EOF\"\n[Unit]\nDescription=Kubernetes Scheduler\nDocumentation=https://github.com/kubernetes/kubernetes\n\n[Service]\nEnvironmentFile=-/etc/kubernetes/kube-scheduler.conf\nExecStart=/usr/local/bin/kube-scheduler $KUBE_SCHEDULER_OPTS\nRestart=on-failure\nRestartSec=5\n\n[Install]\nWantedBy=multi-user.target\nEOF\n---\nfor i in `cat ~/MasterNodes.txt`;do echo $i;scp /usr/lib/systemd/system/kube-scheduler.service $i:/usr/lib/systemd/system/;done\n```\n\n#### 6.5、start kube-scheduler.service\n\n```sh\nsystemctl daemon-reload\nsystemctl enable --now kube-scheduler.service\nsystemctl status kube-scheduler.service\n```\n\n## 四、Node\n\n### 1、kubelet\n\n#### 1.1、BOOTSTRAP_TOKEN\n\n```sh\nBOOTSTRAP_TOKEN=$(awk -F \",\" '{print $1}' /etc/kubernetes/token.csv)\n```\n\n#### 1.2、kubelet-bootstrap.kubeconfig\n\n```sh\n# 1、设置集群参数\nkubectl config set-cluster kubernetes --certificate-authority=ca.pem --embed-certs=true --server=https://10.0.0.25:6444 --kubeconfig=/root/work/kubelet-bootstrap.kubeconfig\n\n# 2、设置客户端认证参数\nkubectl config set-credentials kubelet-bootstrap --token=${BOOTSTRAP_TOKEN} --kubeconfig=/root/work/kubelet-bootstrap.kubeconfig\n\n# 3、设置上下文参数\nkubectl config set-context default --cluster=kubernetes --user=kubelet-bootstrap --kubeconfig=/root/work/kubelet-bootstrap.kubeconfig\n\n# 4、设置当前上下文\nkubectl config use-context default --kubeconfig=/root/work/kubelet-bootstrap.kubeconfig\n\n# 5、创建clusterrolebinding\nkubectl delete clusterrolebinding kubelet-bootstrap\nkubectl create clusterrolebinding kubelet-bootstrap --clusterrole=system:node-bootstrapper --user=kubelet-bootstrap\nkubectl create clusterrolebinding cluster-system-anonymous --clusterrole=cluster-admin --user=kubelet-bootstrap\n```\n\n#### 1.3、kubelet.json\n\n```sh\ncat > ~/work/kubelet.json << \"EOF\"\n{\n \"kind\": \"KubeletConfiguration\",\n \"apiVersion\": \"kubelet.config.k8s.io/v1beta1\",\n \"authentication\": {\n   \"x509\": {\n     \"clientCAFile\": \"/etc/kubernetes/ssl/ca.pem\"\n   },\n   \"webhook\": {\n     \"enabled\": true,\n     \"cacheTTL\": \"2m0s\"\n   },\n   \"anonymous\": {\n     \"enabled\": false\n   }\n },\n \"authorization\": {\n   \"mode\": \"Webhook\",\n   \"webhook\": {\n     \"cacheAuthorizedTTL\": \"5m0s\",\n     \"cacheUnauthorizedTTL\": \"30s\"\n   }\n },\n \"address\": \"10.0.0.23\",\n \"port\": 10250,\n \"readOnlyPort\": 10255,\n \"cgroupDriver\": \"systemd\",\n \"hairpinMode\": \"promiscuous-bridge\",\n \"serializeImagePulls\": false,\n \"clusterDomain\": \"cluster.local.\",\n \"clusterDNS\": [\"10.96.0.2\"]\n}\nEOF\n```\n\n#### 1.4、kubelet.service\n\n```sh\ncat > ~/work/kubelet.service <<\"EOF\"\n[Unit]\nDescription=Kubernetes Kubelet\nDocumentation=https://github.com/kubernetes/kubernetes\nAfter=containerd.service\nRequires=containerd.service\n\n[Service]\nWorkingDirectory=/var/lib/kubelet\nExecStart=/usr/local/bin/kubelet \\\n --container-runtime=remote \\\n --container-runtime-endpoint=unix:///run/containerd/containerd.sock\n --bootstrap-kubeconfig=/etc/kubernetes/kubelet-bootstrap.kubeconfig \\\n --cert-dir=/etc/kubernetes/ssl \\\n --kubeconfig=/etc/kubernetes/kubelet.kubeconfig \\\n --config=/etc/kubernetes/kubelet.json \\\n --pod-infra-container-image=registry.aliyuncs.com/google_containers/pause:3.2 \\\n --v=2\nRestart=on-failure\nRestartSec=5\n\n[Install]\nWantedBy=multi-user.target\nEOF\n---\nfor i in `cat ~/WorkNodes.txt`;do echo $i;scp ~/work/kubelet.json ~/work/kubelet-bootstrap.kubeconfig $i:/etc/kubernetes;done\nfor i in `cat ~/WorkNodes.txt`;do echo $i;scp ~/work/kubelet.service $i:/usr/lib/systemd/system;done\nfor i in `cat ~/WorkNodes.txt`;do echo $i;scp /etc/kubernetes/ssl/ca.pem $i:/etc/kubernetes/ssl/;done\n```\n\n#### 1.5、start kubelet.services\n\n```sh\nmkdir -p /var/lib/kubelet\nsystemctl daemon-reload\nsystemctl enable --now kubelet.service\nsystemctl status kubelet.service\n```\n\n#### 1.6、Approve Nodes\n\n```sh\nkubectl get csr |grep node |awk '{print$1,$6}'\n\n\"+---                                                  |     ---+\"\n  node-csr-BV7RZ1Mc1RFkWhH9jzJH8h8on_dRMB3an_7FgBUwWhk   Pending\n  node-csr-wZOI__ACKylv7DlEPRK8iMg3_sYyBErjbGjxkMkRyPo   Pending\n\"+---                                                  |     ---+\"\n\nkubectl certificate approve node-csr-csr-BV7RZ1Mc1RFkWhH9jzJH8h8on_dRMB3an_7FgBUwWhk node-csr-wZOI__ACKylv7DlEPRK8iMg3_sYyBErjbGjxkMkRyPo\n\nkubectl get nodes\nNAME         STATUS   ROLES    AGE    VERSION\nk8s-node01   Ready    <none>   118m   v1.23.5\nk8s-node02   Ready    <none>   118m   v1.23.5\n```\n\n### 2、kube-pproxy\n\n#### 2.1、kube-proxy certificate\n\n```sh\ncat > kube-proxy-csr.json << \"EOF\"\n{\n  \"CN\": \"system:kube-proxy\",\n  \"key\": {\n    \"algo\": \"rsa\",\n    \"size\": 2048\n  },\n  \"names\": [\n    {\n      \"C\": \"CN\",\n      \"ST\": \"Shanghai\",\n      \"L\": \"Shanghai\",\n      \"O\": \"k8s\",\n      \"OU\": \"system\"\n    }\n  ]\n}\nEOF\n---\ncfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes kube-proxy-csr.json | cfssljson -bare kube-proxy\ncp kube-proxy*.pem /etc/kubernetes/ssl/\nfor i in `cat ~/WorkNodes.txt`;do echo $i;scp ~/work/kube-proxy*.pem $i:/etc/kubernetes/ssl/;done\n```\n\n#### 2.2、kube-proxy.kubeconfig\n\n```sh\n# 1、设置集群参数\nkubectl config set-cluster kubernetes --certificate-authority=ca.pem --embed-certs=true --server=https://10.0.0.25:6444 --kubeconfig=/root/work/kube-proxy.kubeconfig\n\n# 2、设置客户端认证参数\nkubectl config set-credentials kube-proxy --client-certificate=kube-proxy.pem --client-key=kube-proxy-key.pem --embed-certs=true --kubeconfig=/root/work/kube-proxy.kubeconfig\n\n# 3、设置上下文参数\nkubectl config set-context default --cluster=kubernetes --user=kube-proxy --kubeconfig=/root/work/kube-proxy.kubeconfig\n\n# 4、设置当前上下文\nkubectl config use-context default --kubeconfig=/root/work/kube-proxy.kubeconfig\n```\n\n#### 2.3、kube-proxy.yaml\n\n```sh\n# 以下bindAddress均为宿主机ip,clusterCIDR为宿主机网段\n---\ncat > ~/work/kube-proxy.yaml << \"EOF\"\napiVersion: kubeproxy.config.k8s.io/v1alpha1\nbindAddress: 10.0.0.23\nclientConnection:\n  kubeconfig: /etc/kubernetes/kube-proxy.kubeconfig\nclusterCIDR: 10.244.0.0/24\nhealthzBindAddress: 10.0.0.23:10256\nkind: KubeProxyConfiguration\nmetricsBindAddress: 10.0.0.23:10249\nmode: \"ipvs\"\nEOF\n---\nfor i in `cat ~/WorkNodes.txt`;do echo $i;scp ~/work/kube-proxy.yaml ~/work/kube-proxy.kubeconfig $i:/etc/kubernetes/;done\n```\n\n#### 2.4、kube-proxy.service\n\n```sh\ncat > ~/work/kube-proxy.service << \"EOF\"\n[Unit]\nDescription=Kubernetes Kube-Proxy Server\nDocumentation=https://github.com/kubernetes/kubernetes\nAfter=network.target\n\n[Service]\nWorkingDirectory=/var/lib/kube-proxy\nExecStart=/usr/local/bin/kube-proxy \\\n --config=/etc/kubernetes/kube-proxy.yaml \\\n --alsologtostderr=true \\\n --logtostderr=false \\\n --log-dir=/var/log/kubernetes \\\n --v=2\nRestart=on-failure\nRestartSec=5\nLimitNOFILE=65536\n\n[Install]\nWantedBy=multi-user.target\nEOF\n---\nfor i in `cat ~/WorkNodes.txt`;do echo $i;scp ~/work/kube-proxy.service $i:/usr/lib/systemd/system;done\n```\n\n#### 2.5、start kube-proxy.services\n\n```sh\nmkdir -p /var/lib/kube-proxy\nsystemctl daemon-reload\nsystemctl enable --now kube-proxy.service\nsystemctl status kube-proxy.service\n```\n\n## 五、network\n\n### 1、calico\n\n```sh\nwget https://docs.projectcalico.org/manifests/calico.yaml\nkubectl apply -f calico.yaml\n```\n\n### 2、coredns\n\n#### 2.1、resolv.conf\n\n```sh\nmv /etc/resolv.conf  /etc/resolv.conf.bak\nln -s /run/systemd/resolve/resolv.conf /etc/\nsystemctl restart systemd-resolved.service && systemctl enable systemd-resolved.service\n```\n\n#### 2.2、coredns.yaml\n\n```sh\napiVersion: v1\nkind: ServiceAccount\nmetadata:\n  name: coredns\n  namespace: kube-system\n---\napiVersion: rbac.authorization.k8s.io/v1\nkind: ClusterRole\nmetadata:\n  labels:\n    kubernetes.io/bootstrapping: rbac-defaults\n  name: system:coredns\nrules:\n  - apiGroups:\n    - \"\"\n    resources:\n    - endpoints\n    - services\n    - pods\n    - namespaces\n    verbs:\n    - list\n    - watch\n  - apiGroups:\n    - discovery.k8s.io\n    resources:\n    - endpointslices\n    verbs:\n    - list\n    - watch\n---\napiVersion: rbac.authorization.k8s.io/v1\nkind: ClusterRoleBinding\nmetadata:\n  annotations:\n    rbac.authorization.kubernetes.io/autoupdate: \"true\"\n  labels:\n    kubernetes.io/bootstrapping: rbac-defaults\n  name: system:coredns\nroleRef:\n  apiGroup: rbac.authorization.k8s.io\n  kind: ClusterRole\n  name: system:coredns\nsubjects:\n- kind: ServiceAccount\n  name: coredns\n  namespace: kube-system\n---\napiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: coredns\n  namespace: kube-system\ndata:\n  Corefile: |\n    .:53 {\n        errors\n        health {\n          lameduck 5s\n        }\n        ready\n        kubernetes cluster.local in-addr.arpa ip6.arpa {\n          fallthrough in-addr.arpa ip6.arpa\n        }\n        prometheus :9153\n        forward . /etc/resolv.conf {\n          max_concurrent 1000\n        }\n        cache 30\n        loop\n        reload\n        loadbalance\n    }\n---\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: coredns\n  namespace: kube-system\n  labels:\n    k8s-app: kube-dns\n    kubernetes.io/name: \"CoreDNS\"\nspec:\n  # replicas: not specified here:\n  # 1. Default is 1.\n  # 2. Will be tuned in real time if DNS horizontal auto-scaling is turned on.\n  strategy:\n    type: RollingUpdate\n    rollingUpdate:\n      maxUnavailable: 1\n  selector:\n    matchLabels:\n      k8s-app: kube-dns\n  template:\n    metadata:\n      labels:\n        k8s-app: kube-dns\n    spec:\n      priorityClassName: system-cluster-critical\n      serviceAccountName: coredns\n      tolerations:\n        - key: \"CriticalAddonsOnly\"\n          operator: \"Exists\"\n      nodeSelector:\n        kubernetes.io/os: linux\n      affinity:\n         podAntiAffinity:\n           preferredDuringSchedulingIgnoredDuringExecution:\n           - weight: 100\n             podAffinityTerm:\n               labelSelector:\n                 matchExpressions:\n                   - key: k8s-app\n                     operator: In\n                     values: [\"kube-dns\"]\n               topologyKey: kubernetes.io/hostname\n      containers:\n      - name: coredns\n        image: coredns/coredns:1.8.4\n        imagePullPolicy: IfNotPresent\n        resources:\n          limits:\n            memory: 170Mi\n          requests:\n            cpu: 100m\n            memory: 70Mi\n        args: [ \"-conf\", \"/etc/coredns/Corefile\" ]\n        volumeMounts:\n        - name: config-volume\n          mountPath: /etc/coredns\n          readOnly: true\n        ports:\n        - containerPort: 53\n          name: dns\n          protocol: UDP\n        - containerPort: 53\n          name: dns-tcp\n          protocol: TCP\n        - containerPort: 9153\n          name: metrics\n          protocol: TCP\n        securityContext:\n          allowPrivilegeEscalation: false\n          capabilities:\n            add:\n            - NET_BIND_SERVICE\n            drop:\n            - all\n          readOnlyRootFilesystem: true\n        livenessProbe:\n          httpGet:\n            path: /health\n            port: 8080\n            scheme: HTTP\n          initialDelaySeconds: 60\n          timeoutSeconds: 5\n          successThreshold: 1\n          failureThreshold: 5\n        readinessProbe:\n          httpGet:\n            path: /ready\n            port: 8181\n            scheme: HTTP\n      dnsPolicy: Default\n      volumes:\n        - name: config-volume\n          configMap:\n            name: coredns\n            items:\n            - key: Corefile\n              path: Corefile\n---\napiVersion: v1\nkind: Service\nmetadata:\n  name: kube-dns\n  namespace: kube-system\n  annotations:\n    prometheus.io/port: \"9153\"\n    prometheus.io/scrape: \"true\"\n  labels:\n    k8s-app: kube-dns\n    kubernetes.io/cluster-service: \"true\"\n    kubernetes.io/name: \"CoreDNS\"\nspec:\n  selector:\n    k8s-app: kube-dns\n  clusterIP: 10.96.0.2\n  ports:\n  - name: dns\n    port: 53\n    protocol: UDP\n  - name: dns-tcp\n    port: 53\n    protocol: TCP\n  - name: metrics\n    port: 9153\n    protocol: TCP\n```\n\n#### 2.3、install\n\n```sh\nkubectl apply -f coredns.yaml\n```\n\n","slug":"k8s-containerd","published":1,"date":"2022-04-16T04:25:08.281Z","updated":"2022-04-16T04:25:08.281Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cl21d0www0001vqjx8tq9306q","content":"<p>ubuntu install kubernetes(containerd)</p>\n<span id=\"more\"></span>\n\n<h2 id=\"一、Prepare\"><a href=\"#一、Prepare\" class=\"headerlink\" title=\"一、Prepare\"></a>一、Prepare</h2><h3 id=\"1、system\"><a href=\"#1、system\" class=\"headerlink\" title=\"1、system\"></a>1、system</h3><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 1、sources.list</span></span><br><span class=\"line\"><span class=\"built_in\">mv</span> /etc/apt/sources.list /etc/apt/sources.list.bak</span><br><span class=\"line\"><span class=\"built_in\">cat</span>  /etc/apt/sources.list.bak |grep -v <span class=\"string\">&quot;#&quot;</span> |grep -v <span class=\"string\">&quot;^$&quot;</span> &gt; sources.list</span><br><span class=\"line\">sed -i s/archive.ubuntu.com/mirrors.ustc.edu.cn/g /etc/apt/sources.list</span><br><span class=\"line\">sed -i s/security.ubuntu.com/mirrors.ustc.edu.cn/g /etc/apt/sources.list</span><br><span class=\"line\">apt -y update &amp;&amp; apt -y upgrade</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 2、timedatectl</span></span><br><span class=\"line\">sed -i s/en_US/C/g /etc/default/locale</span><br><span class=\"line\">timedatectl set-timezone Asia/Shanghai</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 3、bash-completion</span></span><br><span class=\"line\">sed -i 97,99s/<span class=\"comment\">#//g /root/.bashrc</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 4、ssh</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;PermitRootLogin yes&quot;</span> &gt;&gt; /etc/ssh/sshd_config</span><br><span class=\"line\">passwd root &lt;&lt; <span class=\"string\">&quot;EOF&quot;</span></span><br><span class=\"line\">password</span><br><span class=\"line\">password</span><br><span class=\"line\">EOF</span><br><span class=\"line\">systemctl reload ssh</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 5、hosts</span></span><br><span class=\"line\">vim /etc/hosts</span><br><span class=\"line\">10.0.0.20 k8s-master00</span><br><span class=\"line\">10.0.0.21 k8s-master01</span><br><span class=\"line\">10.0.0.22 k8s-master02</span><br><span class=\"line\">10.0.0.23 k8s-node01</span><br><span class=\"line\">10.0.0.24 k8s-node02</span><br><span class=\"line\">10.0.0.25 k8s-bl-master</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 6、ssh-keygen</span></span><br><span class=\"line\">ssh-keygen -t rsa</span><br><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> `<span class=\"built_in\">cat</span> /root/*.txt`;<span class=\"keyword\">do</span> <span class=\"built_in\">echo</span> <span class=\"variable\">$i</span>;ssh-copy-id -i .ssh/id_rsa.pub <span class=\"variable\">$i</span>;<span class=\"keyword\">done</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 7、swap</span></span><br><span class=\"line\">swapoff -a</span><br><span class=\"line\">sed -i <span class=\"string\">&#x27;/swap/s/^\\(.*\\)$/#\\1/g&#x27;</span> /etc/fstab</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 8、network</span></span><br><span class=\"line\">net=`<span class=\"built_in\">cat</span> /etc/netplan/00-installer-config.yaml |awk <span class=\"string\">&#x27;NR==4&#123;print $1&#125;&#x27;</span>`</span><br><span class=\"line\">sed -i <span class=\"string\">&quot;s/<span class=\"variable\">$&#123;net&#125;</span>/eth0:/g&quot;</span> /etc/netplan/00-installer-config.yaml</span><br><span class=\"line\">sed -i <span class=\"string\">&#x27;11s/&quot;&quot;/&quot;net.ifnames=0 biosdevname=0&quot;/g&#x27;</span> /etc/default/grub</span><br><span class=\"line\">update-grub</span><br><span class=\"line\">reboot</span><br></pre></td></tr></table></figure>\n<h3 id=\"2、ipvs\"><a href=\"#2、ipvs\" class=\"headerlink\" title=\"2、ipvs\"></a>2、ipvs</h3><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">apt -y install ipvsadm ipset sysstat conntrack libseccomp2 libseccomp-dev</span><br><span class=\"line\"><span class=\"built_in\">cat</span> &gt; /etc/modules-load.d/ipvs.conf &lt;&lt; <span class=\"string\">EOF</span></span><br><span class=\"line\"><span class=\"string\">ip_vs</span></span><br><span class=\"line\"><span class=\"string\">ip_vs_lc</span></span><br><span class=\"line\"><span class=\"string\">ip_vs_wlc</span></span><br><span class=\"line\"><span class=\"string\">ip_vs_rr</span></span><br><span class=\"line\"><span class=\"string\">ip_vs_wrr</span></span><br><span class=\"line\"><span class=\"string\">ip_vs_lblc</span></span><br><span class=\"line\"><span class=\"string\">ip_vs_lblcr</span></span><br><span class=\"line\"><span class=\"string\">ip_vs_dh</span></span><br><span class=\"line\"><span class=\"string\">ip_vs_sh</span></span><br><span class=\"line\"><span class=\"string\">ip_vs_fo</span></span><br><span class=\"line\"><span class=\"string\">ip_vs_nq</span></span><br><span class=\"line\"><span class=\"string\">ip_vs_sed</span></span><br><span class=\"line\"><span class=\"string\">ip_vs_ftp</span></span><br><span class=\"line\"><span class=\"string\">nf_conntrack</span></span><br><span class=\"line\"><span class=\"string\">ip_tables</span></span><br><span class=\"line\"><span class=\"string\">ip_set</span></span><br><span class=\"line\"><span class=\"string\">xt_set</span></span><br><span class=\"line\"><span class=\"string\">ipt_set</span></span><br><span class=\"line\"><span class=\"string\">ipt_rpfilter</span></span><br><span class=\"line\"><span class=\"string\">ipt_REJECT</span></span><br><span class=\"line\"><span class=\"string\">ipip</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br><span class=\"line\">systemctl restart systemd-modules-load.service</span><br><span class=\"line\">lsmod |grep -e ip_vs -e nf_conntrack_ipv4</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"3、containerd\"><a href=\"#3、containerd\" class=\"headerlink\" title=\"3、containerd\"></a>3、containerd</h3><h4 id=\"3-1、download-containerd\"><a href=\"#3-1、download-containerd\" class=\"headerlink\" title=\"3.1、download containerd\"></a>3.1、download containerd</h4><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">wget https://github.com/containerd/containerd/releases/download/v1.6.1/cri-containerd-cni-1.6.1-linux-amd64.tar.gz</span><br><span class=\"line\">tar --no-overwrite-dir -C / -xzf cri-containerd-cni-1.6.1-linux-amd64.tar.gz</span><br><span class=\"line\">systemctl daemon-reload</span><br><span class=\"line\">systemctl <span class=\"built_in\">enable</span> --now containerd</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"3-2、config-toml\"><a href=\"#3-2、config-toml\" class=\"headerlink\" title=\"3.2、config.toml\"></a>3.2、config.toml</h4><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">containerd config default &gt; /etc/containerd/config.toml</span><br><span class=\"line\">---</span><br><span class=\"line\">sed -i <span class=\"string\">&quot;s#k8s.gcr.io#registry.aliyuncs.com/google_containers#g&quot;</span> /etc/containerd/config.toml</span><br><span class=\"line\">sed -i <span class=\"string\">&quot;s#SystemdCgroup = false#SystemdCgroup = true#g&quot;</span> /etc/containerd/config.toml</span><br><span class=\"line\">sed -i <span class=\"string\">&#x27;153a\\        [plugins.&quot;io.containerd.grpc.v1.cri&quot;.registry.mirrors.&quot;docker.io&quot;]&#x27;</span> /etc/containerd/config.toml  <span class=\"comment\"># 8个空格 # endpoint 10个空格</span></span><br><span class=\"line\">sed -i <span class=\"string\">&#x27;154a\\          endpoint = [&quot;https://registry.aliyuncs.com&quot;]&#x27;</span> /etc/containerd/config.toml</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"3-3、crictl-yaml\"><a href=\"#3-3、crictl-yaml\" class=\"headerlink\" title=\"3.3、crictl.yaml\"></a>3.3、crictl.yaml</h4><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">mv</span> /etc/crictl.yaml /etc/crictl.yaml.bak</span><br><span class=\"line\"><span class=\"built_in\">cat</span> &gt; /etc/crictl.yaml &lt;&lt; <span class=\"string\">&quot;EOF&quot;</span></span><br><span class=\"line\">runtime-endpoint: unix:///run/containerd/containerd.sock</span><br><span class=\"line\">image-endpoint: unix:///run/containerd/containerd.sock</span><br><span class=\"line\"><span class=\"built_in\">timeout</span>: 0</span><br><span class=\"line\">debug: <span class=\"literal\">false</span></span><br><span class=\"line\">pull-image-on-create: <span class=\"literal\">false</span></span><br><span class=\"line\">disable-pull-on-run: <span class=\"literal\">false</span></span><br><span class=\"line\">EOF</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"二、High-availability\"><a href=\"#二、High-availability\" class=\"headerlink\" title=\"二、High availability\"></a>二、High availability</h2><h3 id=\"1、nginx-conf\"><a href=\"#1、nginx-conf\" class=\"headerlink\" title=\"1、nginx.conf\"></a>1、nginx.conf</h3><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">apt -y install nginx</span><br><span class=\"line\"><span class=\"built_in\">cp</span> /etc/nginx/nginx.conf /etc/nginx/nginx.conf.bak</span><br><span class=\"line\">vim /etc/nginx/nginx.conf</span><br><span class=\"line\">---</span><br><span class=\"line\">...</span><br><span class=\"line\">...</span><br><span class=\"line\">stream &#123;</span><br><span class=\"line\">          </span><br><span class=\"line\">        log_format main <span class=\"string\">&#x27;$remote_addr $upstream_addr - [$time_local] $status $upstream_bytes_sent&#x27;</span>;</span><br><span class=\"line\">          </span><br><span class=\"line\">        access_log /var/log/nginx/k8s-access.log main;</span><br><span class=\"line\">        </span><br><span class=\"line\">        upstream k8s-apiserver &#123;</span><br><span class=\"line\">                server 10.0.0.20:6443;</span><br><span class=\"line\">                server 10.0.0.21:6443;</span><br><span class=\"line\">                server 10.0.0.22:6443;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">        server &#123;</span><br><span class=\"line\">                listen 6444; </span><br><span class=\"line\">                proxy_pass k8s-apiserver;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">http &#123;</span><br><span class=\"line\">\t\tlog_format main <span class=\"string\">&#x27;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#x27;</span></span><br><span class=\"line\">                        <span class=\"string\">&#x27;$status $body_bytes_sent &quot;$http_referer&quot; &#x27;</span></span><br><span class=\"line\">                        <span class=\"string\">&#x27;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#x27;</span>;</span><br><span class=\"line\">        ...</span><br><span class=\"line\">        ...</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">---</span><br><span class=\"line\">systemctl <span class=\"built_in\">enable</span> --now nginx.service</span><br><span class=\"line\">systemctl status nginx.service</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"2、keepalived-conf\"><a href=\"#2、keepalived-conf\" class=\"headerlink\" title=\"2、keepalived.conf\"></a>2、keepalived.conf</h3><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">apt -y install keepalived</span><br><span class=\"line\"><span class=\"comment\">#keepalived config</span></span><br><span class=\"line\"><span class=\"built_in\">cat</span> &gt; /etc/keepalived/keepalived.conf &lt;&lt; <span class=\"string\">&quot;EOF&quot;</span></span><br><span class=\"line\">global_defs &#123;</span><br><span class=\"line\">    notification_email &#123;</span><br><span class=\"line\">      acassen@firewall.loc</span><br><span class=\"line\">      failover@firewall.loc</span><br><span class=\"line\">      sysadmin@firewall.loc</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    notification_email_from Alexandre.Cassen@firewall.loc</span><br><span class=\"line\">    smtp_server 127.0.0.1</span><br><span class=\"line\">    smtp_connect_timeout 30 </span><br><span class=\"line\">    router_id NGINX_MASTER</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">vrrp_script check_nginx &#123;</span><br><span class=\"line\">  script <span class=\"string\">&quot;/etc/keepalived/check_nginx.sh&quot;</span></span><br><span class=\"line\">  interval 5</span><br><span class=\"line\">  weight -1</span><br><span class=\"line\">  fall 2</span><br><span class=\"line\">  rise 1</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">vrrp_instance VI_1 &#123;</span><br><span class=\"line\">    state MASTER</span><br><span class=\"line\">    interface eth0 <span class=\"comment\"># 修改为实际网卡名</span></span><br><span class=\"line\">    virtual_router_id 51 <span class=\"comment\"># VRRP 路由 ID 实例，每个实例是唯一的</span></span><br><span class=\"line\">    priority 100 <span class=\"comment\"># 优先级，备服务器设置 90</span></span><br><span class=\"line\">    advert_int 1 <span class=\"comment\"># 指定 VRRP 心跳包通告间隔时间，默认 1 秒</span></span><br><span class=\"line\">    authentication &#123;</span><br><span class=\"line\">        auth_type PASS</span><br><span class=\"line\">        auth_pass K8SHA_KA_AUTH</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"comment\"># 虚拟 IP</span></span><br><span class=\"line\">    virtual_ipaddress &#123;</span><br><span class=\"line\">        10.0.0.25/24</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    track_script &#123;</span><br><span class=\"line\">        check_nginx</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">EOF</span><br><span class=\"line\"><span class=\"comment\">#health config</span></span><br><span class=\"line\"><span class=\"built_in\">cat</span> &gt; /etc/keepalived/check_nginx.sh &lt;&lt; <span class=\"string\">&quot;EOF&quot;</span></span><br><span class=\"line\"><span class=\"comment\">#!/bin/bash </span></span><br><span class=\"line\">count=$(ps -ef |grep nginx | grep sbin | egrep -cv <span class=\"string\">&quot;grep|$$&quot;</span>) </span><br><span class=\"line\"><span class=\"keyword\">if</span> [ <span class=\"string\">&quot;<span class=\"variable\">$count</span>&quot;</span> -eq 0 ];<span class=\"keyword\">then</span> </span><br><span class=\"line\">  systemctl stop keepalived </span><br><span class=\"line\"><span class=\"keyword\">fi</span></span><br><span class=\"line\">EOF</span><br><span class=\"line\">---</span><br><span class=\"line\">systemctl <span class=\"built_in\">enable</span> --now keepalived.service</span><br><span class=\"line\">systemctl status keepalived.service</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"三、Master\"><a href=\"#三、Master\" class=\"headerlink\" title=\"三、Master\"></a>三、Master</h2><h3 id=\"1、cfssl\"><a href=\"#1、cfssl\" class=\"headerlink\" title=\"1、cfssl\"></a>1、cfssl</h3><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">wget https://github.com/cloudflare/cfssl/releases/download/v1.6.1/cfssl_1.6.1_linux_amd64 -O /usr/local/bin/cfssl</span><br><span class=\"line\">wget https://github.com/cloudflare/cfssl/releases/download/v1.6.1/cfssljson_1.6.1_linux_amd64 -O /usr/local/bin/cfssljson</span><br><span class=\"line\">wget https://github.com/cloudflare/cfssl/releases/download/v1.6.1/cfssl-certinfo_1.6.1_linux_amd64 -O /usr/local/bin/cfssl-certinfo</span><br><span class=\"line\"><span class=\"built_in\">chmod</span> +x /usr/local/bin/cfssl*</span><br><span class=\"line\"><span class=\"built_in\">chown</span> -Rf root:root /usr/local/bin/cfssl*</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"2、etcd\"><a href=\"#2、etcd\" class=\"headerlink\" title=\"2、etcd\"></a>2、etcd</h3><h4 id=\"2-1、mkdir-directory\"><a href=\"#2-1、mkdir-directory\" class=\"headerlink\" title=\"2.1、mkdir directory\"></a>2.1、mkdir directory</h4><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># all Master</span></span><br><span class=\"line\"><span class=\"comment\"># 1、etcd-ssl</span></span><br><span class=\"line\"><span class=\"built_in\">mkdir</span> -p /etc/etcd/ssl/</span><br><span class=\"line\"><span class=\"comment\"># 2、etcd-WorkingDirectory</span></span><br><span class=\"line\"><span class=\"built_in\">mkdir</span> -p /var/lib/etcd/default.etcd</span><br><span class=\"line\"><span class=\"comment\"># 3、kubernetes-ssl</span></span><br><span class=\"line\"><span class=\"built_in\">mkdir</span> -p /etc/kubernetes/ssl</span><br><span class=\"line\"><span class=\"comment\"># 4、kubernetes-log</span></span><br><span class=\"line\"><span class=\"built_in\">mkdir</span> -p /var/log/kubernetes</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"2-2、ca-certificate\"><a href=\"#2-2、ca-certificate\" class=\"headerlink\" title=\"2.2、ca certificate\"></a>2.2、ca certificate</h4><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># master00</span></span><br><span class=\"line\"><span class=\"built_in\">mkdir</span> -p ~/work</span><br><span class=\"line\"><span class=\"built_in\">cd</span> ~/work/</span><br><span class=\"line\">---</span><br><span class=\"line\"><span class=\"built_in\">cat</span> &gt; ca-csr.json &lt;&lt; <span class=\"string\">&quot;EOF&quot;</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;CN&quot;</span>: <span class=\"string\">&quot;kubernetes&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;key&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;algo&quot;</span>: <span class=\"string\">&quot;rsa&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;size&quot;</span>: 2048</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  <span class=\"string\">&quot;names&quot;</span>: [</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;C&quot;</span>: <span class=\"string\">&quot;CN&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;ST&quot;</span>: <span class=\"string\">&quot;Shanghai&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;L&quot;</span>: <span class=\"string\">&quot;Shanghai&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;O&quot;</span>: <span class=\"string\">&quot;k8s&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;OU&quot;</span>: <span class=\"string\">&quot;system&quot;</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  ]</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">EOF</span><br><span class=\"line\">---</span><br><span class=\"line\"><span class=\"built_in\">cat</span> &gt; ca-config.json &lt;&lt; <span class=\"string\">&quot;EOF&quot;</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;signing&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;default&quot;</span>: &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;expiry&quot;</span>: <span class=\"string\">&quot;87600h&quot;</span></span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    <span class=\"string\">&quot;profiles&quot;</span>: &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;kubernetes&quot;</span>: &#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;usages&quot;</span>: [</span><br><span class=\"line\">            <span class=\"string\">&quot;signing&quot;</span>,</span><br><span class=\"line\">            <span class=\"string\">&quot;key encipherment&quot;</span>,</span><br><span class=\"line\">            <span class=\"string\">&quot;server auth&quot;</span>,</span><br><span class=\"line\">            <span class=\"string\">&quot;client auth&quot;</span></span><br><span class=\"line\">        ],</span><br><span class=\"line\">        <span class=\"string\">&quot;expiry&quot;</span>: <span class=\"string\">&quot;87600h&quot;</span></span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">EOF</span><br><span class=\"line\">---</span><br><span class=\"line\">cfssl gencert -initca ca-csr.json | cfssljson -bare ca</span><br><span class=\"line\"><span class=\"built_in\">cp</span> ca*.pem /etc/etcd/ssl/</span><br><span class=\"line\">---</span><br><span class=\"line\"><span class=\"comment\"># send to other master</span></span><br><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> `<span class=\"built_in\">cat</span> ~/MasterNodes.txt`;<span class=\"keyword\">do</span> <span class=\"built_in\">echo</span> <span class=\"variable\">$i</span>;scp /etc/etcd/ssl/ca*.pem <span class=\"variable\">$i</span>:/etc/etcd/ssl;<span class=\"keyword\">done</span></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"2-3、etcd-certificate\"><a href=\"#2-3、etcd-certificate\" class=\"headerlink\" title=\"2.3、etcd certificate\"></a>2.3、etcd certificate</h4><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">cat</span> &gt; etcd-csr.json &lt;&lt; <span class=\"string\">&quot;EOF&quot;</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;CN&quot;</span>: <span class=\"string\">&quot;etcd&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;hosts&quot;</span>: [</span><br><span class=\"line\">    <span class=\"string\">&quot;127.0.0.1&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;10.0.0.20&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;10.0.0.21&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;10.0.0.22&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;10.0.0.25&quot;</span></span><br><span class=\"line\">  ],</span><br><span class=\"line\">  <span class=\"string\">&quot;key&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;algo&quot;</span>: <span class=\"string\">&quot;rsa&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;size&quot;</span>: 2048</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  <span class=\"string\">&quot;names&quot;</span>: [</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;C&quot;</span>: <span class=\"string\">&quot;CN&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;ST&quot;</span>: <span class=\"string\">&quot;Shanghai&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;L&quot;</span>: <span class=\"string\">&quot;Shanghai&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;O&quot;</span>: <span class=\"string\">&quot;k8s&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;OU&quot;</span>: <span class=\"string\">&quot;system&quot;</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  ]</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">EOF</span><br><span class=\"line\">---</span><br><span class=\"line\">cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes etcd-csr.json | cfssljson -bare etcd</span><br><span class=\"line\"><span class=\"built_in\">cp</span> etcd*.pem /etc/etcd/ssl/</span><br><span class=\"line\">---</span><br><span class=\"line\"><span class=\"comment\"># send to other</span></span><br><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> `<span class=\"built_in\">cat</span> ~/MasterNodes.txt`;<span class=\"keyword\">do</span> <span class=\"built_in\">echo</span> <span class=\"variable\">$i</span>;scp /etc/etcd/ssl/etcd*.pem <span class=\"variable\">$i</span>:/etc/etcd/ssl;<span class=\"keyword\">done</span></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"2-4、install-etcd-ctl\"><a href=\"#2-4、install-etcd-ctl\" class=\"headerlink\" title=\"2.4、install etcd{,ctl}\"></a>2.4、install etcd{,ctl}</h4><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># download etcd</span></span><br><span class=\"line\">wget https://github.com/etcd-io/etcd/releases/download/v3.5.0/etcd-v3.5.0-linux-amd64.tar.gz</span><br><span class=\"line\"><span class=\"comment\"># tar etcd-*.tar.gz</span></span><br><span class=\"line\">tar -xf etcd-v3.5.0-linux-amd64.tar.gz --strip-components=1 -C ~/work/ etcd-v3.5.0-linux-amd64/etcd&#123;,ctl&#125;</span><br><span class=\"line\"><span class=\"built_in\">chown</span> -Rf root:root etcd*</span><br><span class=\"line\"><span class=\"built_in\">cp</span> -arp etcd* /usr/local/bin/</span><br><span class=\"line\"><span class=\"comment\"># send to other</span></span><br><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> `<span class=\"built_in\">cat</span> ~/MasterNodes.txt`;<span class=\"keyword\">do</span> <span class=\"built_in\">echo</span> <span class=\"variable\">$i</span>;scp /usr/local/bin/etcd&#123;,ctl&#125; <span class=\"variable\">$i</span>:/usr/local/bin/;<span class=\"keyword\">done</span></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"2-5、etcd-conf\"><a href=\"#2-5、etcd-conf\" class=\"headerlink\" title=\"2.5、etcd.conf\"></a>2.5、etcd.conf</h4><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">cat</span> &gt; /etc/etcd/etcd.conf &lt;&lt; <span class=\"string\">&quot;EOF&quot;</span></span><br><span class=\"line\">ETCD_NAME=<span class=\"string\">&#x27;etcd1&#x27;</span></span><br><span class=\"line\">ETCD_DATA_DIR=<span class=\"string\">&quot;/var/lib/etcd/default.etcd&quot;</span></span><br><span class=\"line\">ETCD_LISTEN_PEER_URLS=<span class=\"string\">&quot;https://10.0.0.20:2380&quot;</span> <span class=\"comment\"># change ip</span></span><br><span class=\"line\">ETCD_LISTEN_CLIENT_URLS=<span class=\"string\">&quot;https://10.0.0.20:2379,http://127.0.0.1:2379&quot;</span> <span class=\"comment\"># change ip</span></span><br><span class=\"line\">ETCD_INITIAL_ADVERTISE_PEER_URLS=<span class=\"string\">&quot;https://10.0.0.20:2380&quot;</span> <span class=\"comment\"># change ip</span></span><br><span class=\"line\">ETCD_ADVERTISE_CLIENT_URLS=<span class=\"string\">&quot;https://10.0.0.20:2379&quot;</span> <span class=\"comment\"># change ip</span></span><br><span class=\"line\">ETCD_INITIAL_CLUSTER=<span class=\"string\">&quot;etcd1=https://10.0.0.20:2380,etcd2=https://10.0.0.21:2380,etcd3=https://10.0.0.22:2380&quot;</span></span><br><span class=\"line\">ETCD_INITIAL_CLUSTER_TOKEN=<span class=\"string\">&quot;etcd-cluster&quot;</span></span><br><span class=\"line\">ETCD_INITIAL_CLUSTER_STATE=<span class=\"string\">&quot;new&quot;</span></span><br><span class=\"line\">EOF</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"2-6、etcd-service\"><a href=\"#2-6、etcd-service\" class=\"headerlink\" title=\"2.6、etcd.service\"></a>2.6、etcd.service</h4><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">cat</span> &gt; /usr/lib/systemd/system/etcd.service &lt;&lt; <span class=\"string\">&quot;EOF&quot;</span></span><br><span class=\"line\">[Unit]</span><br><span class=\"line\">Description=Etcd Service</span><br><span class=\"line\">After=network.target</span><br><span class=\"line\">After=network-online.target</span><br><span class=\"line\">Wants=network-online.target</span><br><span class=\"line\"></span><br><span class=\"line\">[Service]</span><br><span class=\"line\">Type=notify</span><br><span class=\"line\">EnvironmentFile=-/etc/etcd/etcd.conf</span><br><span class=\"line\">WorkingDirectory=/var/lib/etcd/</span><br><span class=\"line\">ExecStart=/usr/local/bin/etcd \\</span><br><span class=\"line\"> --cert-file=/etc/etcd/ssl/etcd.pem \\</span><br><span class=\"line\"> --key-file=/etc/etcd/ssl/etcd-key.pem \\</span><br><span class=\"line\"> --trusted-ca-file=/etc/etcd/ssl/ca.pem \\</span><br><span class=\"line\"> --peer-cert-file=/etc/etcd/ssl/etcd.pem \\</span><br><span class=\"line\"> --peer-key-file=/etc/etcd/ssl/etcd-key.pem \\</span><br><span class=\"line\"> --peer-trusted-ca-file=/etc/etcd/ssl/ca.pem \\</span><br><span class=\"line\"> --peer-client-cert-auth \\</span><br><span class=\"line\"> --client-cert-auth</span><br><span class=\"line\">Restart=on-failure</span><br><span class=\"line\">RestartSec=10</span><br><span class=\"line\">LimitNOFILE=65536</span><br><span class=\"line\"></span><br><span class=\"line\">[Install]</span><br><span class=\"line\">WantedBy=multi-user.target</span><br><span class=\"line\">EOF</span><br><span class=\"line\">---</span><br><span class=\"line\"><span class=\"comment\"># send to other</span></span><br><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> `<span class=\"built_in\">cat</span> ~/MasterNodes.txt`;<span class=\"keyword\">do</span> <span class=\"built_in\">echo</span> <span class=\"variable\">$i</span>;scp /usr/lib/systemd/system/etcd.service <span class=\"variable\">$i</span>:/usr/lib/systemd/system/;<span class=\"keyword\">done</span></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"2-7、start-etcd-service\"><a href=\"#2-7、start-etcd-service\" class=\"headerlink\" title=\"2.7、start etcd.service\"></a>2.7、start etcd.service</h4><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 1、start etcd</span></span><br><span class=\"line\">systemctl daemon-reload</span><br><span class=\"line\">systemctl <span class=\"built_in\">enable</span> --now etcd.service</span><br><span class=\"line\">systemctl status etcd.service</span><br><span class=\"line\"><span class=\"comment\"># 2、check etcd</span></span><br><span class=\"line\">ETCDCTL_API=3</span><br><span class=\"line\">etcdctl --endpoints=https://10.0.0.20:2379,https://10.0.0.21:2379,https://10.0.0.22:2379 --write-out=table --cacert=/etc/etcd/ssl/ca.pem --cert=/etc/etcd/ssl/etcd.pem --key=/etc/etcd/ssl/etcd-key.pem endpoint health</span><br><span class=\"line\">+----------------------------+--------+-------------+-------+</span><br><span class=\"line\">|          ENDPOINT          | HEALTH |    TOOK     | ERROR |</span><br><span class=\"line\">+----------------------------+--------+-------------+-------+</span><br><span class=\"line\">| https://10.0.0.20:2379     |   <span class=\"literal\">true</span> | 16.188005ms |       |</span><br><span class=\"line\">| https://10.0.0.21:2379     |   <span class=\"literal\">true</span> | 16.693314ms |       |</span><br><span class=\"line\">| https://10.0.0.22:2379     |   <span class=\"literal\">true</span> | 16.089367ms |       |</span><br><span class=\"line\">+----------------------------+--------+-------------+-------+</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"2-8、kube-…\"><a href=\"#2-8、kube-…\" class=\"headerlink\" title=\"2.8、kube{…}\"></a>2.8、kube{…}</h4><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 1、download</span></span><br><span class=\"line\">wget https://dl.k8s.io/v1.23.5/kubernetes-server-linux-amd64.tar.gz</span><br><span class=\"line\"><span class=\"comment\"># 2、tar</span></span><br><span class=\"line\">tar -xf kubernetes-server-linux-amd64.tar.gz --strip-components=3 -C ~/work kubernetes/server/bin/kube&#123;<span class=\"built_in\">let</span>,ctl,-apiserver,-controller-manager,-scheduler,-proxy&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">scp kube&#123;ctl,-apiserver,-controller-manager,-scheduler&#125; /usr/local/bin/</span><br><span class=\"line\"><span class=\"comment\"># 3、kube&#123;let,ctl,-apiserver,-controller-manager,-scheduler,-proxy&#125;</span></span><br><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> `<span class=\"built_in\">cat</span> ~/MasterNodes.txt`;<span class=\"keyword\">do</span> <span class=\"built_in\">echo</span> <span class=\"variable\">$i</span>;scp ~/work/kube&#123;ctl,-apiserver,-controller-manager,-scheduler&#125; <span class=\"variable\">$i</span>:/usr/local/bin/;<span class=\"keyword\">done</span></span><br><span class=\"line\"><span class=\"comment\"># 4、kube&#123;let,-proxy&#125;</span></span><br><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> `<span class=\"built_in\">cat</span> ~/WorkNodes.txt`;<span class=\"keyword\">do</span> <span class=\"built_in\">echo</span> <span class=\"variable\">$i</span>;scp ~/work/kube&#123;<span class=\"built_in\">let</span>,-proxy&#125; <span class=\"variable\">$i</span>:/usr/local/bin/;<span class=\"keyword\">done</span></span><br><span class=\"line\"><span class=\"comment\"># 5、send pem</span></span><br><span class=\"line\"><span class=\"built_in\">cp</span> /etc/etcd/ssl/ca*.pem /etc/kubernetes/ssl/</span><br><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> `<span class=\"built_in\">cat</span> ~/WorkNodes.txt`;<span class=\"keyword\">do</span> <span class=\"built_in\">echo</span> <span class=\"variable\">$i</span>;scp /etc/etcd/ssl/ca*.pem <span class=\"variable\">$i</span>:/etc/kubernetes/ssl/;<span class=\"keyword\">done</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"3、kube-apiserver\"><a href=\"#3、kube-apiserver\" class=\"headerlink\" title=\"3、kube-apiserver\"></a>3、kube-apiserver</h3><h4 id=\"3-1、token-csv\"><a href=\"#3-1、token-csv\" class=\"headerlink\" title=\"3.1、token.csv\"></a>3.1、token.csv</h4><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">cat</span>  &gt; /etc/kubernetes/token.csv &lt;&lt;<span class=\"string\">EOF</span></span><br><span class=\"line\"><span class=\"string\">$(head -c 16 /dev/urandom | od -An -t x | tr -d &#x27; &#x27;),kubelet-bootstrap,10001,&quot;system:kubelet-bootstrap&quot;</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> `<span class=\"built_in\">cat</span> ~/MasterNodes.txt`;<span class=\"keyword\">do</span> <span class=\"built_in\">echo</span> <span class=\"variable\">$i</span>;scp /etc/kubernetes/token.csv <span class=\"variable\">$i</span>:/etc/kubernetes/;<span class=\"keyword\">done</span></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"3-2、kube-apiserver-certificate\"><a href=\"#3-2、kube-apiserver-certificate\" class=\"headerlink\" title=\"3.2、kube-apiserver certificate\"></a>3.2、kube-apiserver certificate</h4><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">cat</span> &gt; kube-apiserver-csr.json &lt;&lt; <span class=\"string\">&quot;EOF&quot;</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;CN&quot;</span>: <span class=\"string\">&quot;kubernetes&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;hosts&quot;</span>: [</span><br><span class=\"line\">    <span class=\"string\">&quot;127.0.0.1&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;10.0.0.20&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;10.0.0.21&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;10.0.0.22&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;10.0.0.23&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;10.0.0.24&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;10.0.0.25&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;10.96.0.1&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;kubernetes&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;kubernetes.default&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;kubernetes.default.svc&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;kubernetes.default.svc.cluster&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;kubernetes.default.svc.cluster.local&quot;</span></span><br><span class=\"line\">  ],</span><br><span class=\"line\">  <span class=\"string\">&quot;key&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;algo&quot;</span>: <span class=\"string\">&quot;rsa&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;size&quot;</span>: 2048</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  <span class=\"string\">&quot;names&quot;</span>: [</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;C&quot;</span>: <span class=\"string\">&quot;CN&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;ST&quot;</span>: <span class=\"string\">&quot;Shanghai&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;L&quot;</span>: <span class=\"string\">&quot;Shanghai&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;O&quot;</span>: <span class=\"string\">&quot;k8s&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;OU&quot;</span>: <span class=\"string\">&quot;system&quot;</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  ]</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">EOF</span><br><span class=\"line\">---</span><br><span class=\"line\">cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes kube-apiserver-csr.json | cfssljson -bare kube-apiserver</span><br><span class=\"line\"><span class=\"built_in\">cp</span> kube-apiserver*.pem /etc/kubernetes/ssl/</span><br><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> `<span class=\"built_in\">cat</span> ~/MasterNodes.txt`;<span class=\"keyword\">do</span> <span class=\"built_in\">echo</span> <span class=\"variable\">$i</span>;scp ~/work/kube-apiserver*.pem <span class=\"variable\">$i</span>:/etc/kubernetes/ssl/;<span class=\"keyword\">done</span></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"3-3、kube-apiserver-conf\"><a href=\"#3-3、kube-apiserver-conf\" class=\"headerlink\" title=\"3.3、kube-apiserver.conf\"></a>3.3、kube-apiserver.conf</h4><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># change --bind-address= and --advertise-address=</span></span><br><span class=\"line\">---</span><br><span class=\"line\"><span class=\"built_in\">cat</span> &gt; /etc/kubernetes/kube-apiserver.conf &lt;&lt; <span class=\"string\">&quot;EOF&quot;</span></span><br><span class=\"line\">KUBE_APISERVER_OPTS=<span class=\"string\">&quot;--enable-admission-plugins=NamespaceLifecycle,NodeRestriction,LimitRanger,ServiceAccount,DefaultStorageClass,ResourceQuota \\</span></span><br><span class=\"line\"><span class=\"string\"> --anonymous-auth=false \\</span></span><br><span class=\"line\"><span class=\"string\"> --bind-address=10.0.0.20 \\</span></span><br><span class=\"line\"><span class=\"string\"> --secure-port=6443 \\</span></span><br><span class=\"line\"><span class=\"string\"> --advertise-address=10.0.0.20 \\</span></span><br><span class=\"line\"><span class=\"string\"> --insecure-port=0 \\</span></span><br><span class=\"line\"><span class=\"string\"> --authorization-mode=Node,RBAC \\</span></span><br><span class=\"line\"><span class=\"string\"> --runtime-config=api/all=true \\</span></span><br><span class=\"line\"><span class=\"string\"> --enable-bootstrap-token-auth \\</span></span><br><span class=\"line\"><span class=\"string\"> --service-cluster-ip-range=10.96.0.0/16 \\</span></span><br><span class=\"line\"><span class=\"string\"> --token-auth-file=/etc/kubernetes/token.csv \\</span></span><br><span class=\"line\"><span class=\"string\"> --service-node-port-range=30000-50000 \\</span></span><br><span class=\"line\"><span class=\"string\"> --tls-cert-file=/etc/kubernetes/ssl/kube-apiserver.pem \\</span></span><br><span class=\"line\"><span class=\"string\"> --tls-private-key-file=/etc/kubernetes/ssl/kube-apiserver-key.pem \\</span></span><br><span class=\"line\"><span class=\"string\"> --client-ca-file=/etc/kubernetes/ssl/ca.pem \\</span></span><br><span class=\"line\"><span class=\"string\"> --kubelet-client-certificate=/etc/kubernetes/ssl/kube-apiserver.pem \\</span></span><br><span class=\"line\"><span class=\"string\"> --kubelet-client-key=/etc/kubernetes/ssl/kube-apiserver-key.pem \\</span></span><br><span class=\"line\"><span class=\"string\"> --service-account-key-file=/etc/kubernetes/ssl/ca-key.pem \\</span></span><br><span class=\"line\"><span class=\"string\"> --service-account-signing-key-file=/etc/kubernetes/ssl/ca-key.pem \\</span></span><br><span class=\"line\"><span class=\"string\"> --service-account-issuer=https://kubernetes.default.svc.cluster.local \\</span></span><br><span class=\"line\"><span class=\"string\"> --etcd-cafile=/etc/etcd/ssl/ca.pem \\</span></span><br><span class=\"line\"><span class=\"string\"> --etcd-certfile=/etc/etcd/ssl/etcd.pem \\</span></span><br><span class=\"line\"><span class=\"string\"> --etcd-keyfile=/etc/etcd/ssl/etcd-key.pem \\</span></span><br><span class=\"line\"><span class=\"string\"> --etcd-servers=https://10.0.0.20:2379,https://10.0.0.21:2379,https://10.0.0.22:2379 \\</span></span><br><span class=\"line\"><span class=\"string\"> --enable-swagger-ui=true \\</span></span><br><span class=\"line\"><span class=\"string\"> --allow-privileged=true \\</span></span><br><span class=\"line\"><span class=\"string\"> --apiserver-count=3 \\</span></span><br><span class=\"line\"><span class=\"string\"> --audit-log-maxage=30 \\</span></span><br><span class=\"line\"><span class=\"string\"> --audit-log-maxbackup=3 \\</span></span><br><span class=\"line\"><span class=\"string\"> --audit-log-maxsize=100 \\</span></span><br><span class=\"line\"><span class=\"string\"> --audit-log-path=/var/log/kube-apiserver-audit.log \\</span></span><br><span class=\"line\"><span class=\"string\"> --event-ttl=1h \\</span></span><br><span class=\"line\"><span class=\"string\"> --alsologtostderr=true \\</span></span><br><span class=\"line\"><span class=\"string\"> --logtostderr=false \\</span></span><br><span class=\"line\"><span class=\"string\"> --log-dir=/var/log/kubernetes \\</span></span><br><span class=\"line\"><span class=\"string\"> --v=4&quot;</span></span><br><span class=\"line\">EOF</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"3-4、kube-apiserver-service\"><a href=\"#3-4、kube-apiserver-service\" class=\"headerlink\" title=\"3.4、kube-apiserver.service\"></a>3.4、kube-apiserver.service</h4><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">cat</span> &gt; /usr/lib/systemd/system/kube-apiserver.service &lt;&lt; <span class=\"string\">&quot;EOF&quot;</span></span><br><span class=\"line\">[Unit]</span><br><span class=\"line\">Description=Kubernetes API Server</span><br><span class=\"line\">Documentation=https://github.com/kubernetes/kubernetes</span><br><span class=\"line\">After=etcd.service</span><br><span class=\"line\">Wants=etcd.service</span><br><span class=\"line\"></span><br><span class=\"line\">[Service]</span><br><span class=\"line\">EnvironmentFile=-/etc/kubernetes/kube-apiserver.conf</span><br><span class=\"line\">ExecStart=/usr/local/bin/kube-apiserver <span class=\"variable\">$KUBE_APISERVER_OPTS</span></span><br><span class=\"line\">Restart=on-failure</span><br><span class=\"line\">RestartSec=5</span><br><span class=\"line\">Type=notify</span><br><span class=\"line\">LimitNOFILE=65536</span><br><span class=\"line\"></span><br><span class=\"line\">[Install]</span><br><span class=\"line\">WantedBy=multi-user.target</span><br><span class=\"line\">EOF</span><br><span class=\"line\">---</span><br><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> `<span class=\"built_in\">cat</span> ~/MasterNodes.txt`;<span class=\"keyword\">do</span> <span class=\"built_in\">echo</span> <span class=\"variable\">$i</span>;scp /usr/lib/systemd/system/kube-apiserver.service <span class=\"variable\">$i</span>:/usr/lib/systemd/system/;<span class=\"keyword\">done</span></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"3-5、start-kube-apiserver-service\"><a href=\"#3-5、start-kube-apiserver-service\" class=\"headerlink\" title=\"3.5、start kube-apiserver.service\"></a>3.5、start kube-apiserver.service</h4><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">systemctl daemon-reload</span><br><span class=\"line\">systemctl <span class=\"built_in\">enable</span> --now kube-apiserver.service</span><br><span class=\"line\">systemctl status kube-apiserver.service</span><br><span class=\"line\">---</span><br><span class=\"line\"><span class=\"comment\"># check</span></span><br><span class=\"line\">curl --insecure https://10.0.0.20:6443</span><br><span class=\"line\">---</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;kind&quot;</span>: <span class=\"string\">&quot;Status&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;apiVersion&quot;</span>: <span class=\"string\">&quot;v1&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;metadata&quot;</span>: &#123;&#125;,</span><br><span class=\"line\">  <span class=\"string\">&quot;status&quot;</span>: <span class=\"string\">&quot;Failure&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;message&quot;</span>: <span class=\"string\">&quot;Unauthorized&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;reason&quot;</span>: <span class=\"string\">&quot;Unauthorized&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;code&quot;</span>: 401</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"4、kubectl\"><a href=\"#4、kubectl\" class=\"headerlink\" title=\"4、kubectl\"></a>4、kubectl</h3><h4 id=\"4-1、admin-certificate\"><a href=\"#4-1、admin-certificate\" class=\"headerlink\" title=\"4.1、admin certificate\"></a>4.1、admin certificate</h4><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">cat</span> &gt; admin-csr.json &lt;&lt; <span class=\"string\">&quot;EOF&quot;</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;CN&quot;</span>: <span class=\"string\">&quot;admin&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;hosts&quot;</span>: [],</span><br><span class=\"line\">  <span class=\"string\">&quot;key&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;algo&quot;</span>: <span class=\"string\">&quot;rsa&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;size&quot;</span>: 2048</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  <span class=\"string\">&quot;names&quot;</span>: [</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;C&quot;</span>: <span class=\"string\">&quot;CN&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;ST&quot;</span>: <span class=\"string\">&quot;Shanghai&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;L&quot;</span>: <span class=\"string\">&quot;Shanghai&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;O&quot;</span>: <span class=\"string\">&quot;system:masters&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;OU&quot;</span>: <span class=\"string\">&quot;system&quot;</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  ]</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">EOF</span><br><span class=\"line\">---</span><br><span class=\"line\">cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes admin-csr.json | cfssljson -bare admin</span><br><span class=\"line\"><span class=\"built_in\">cp</span> admin*.pem /etc/kubernetes/ssl/</span><br><span class=\"line\">---</span><br><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> `<span class=\"built_in\">cat</span> ~/MasterNodes.txt`;<span class=\"keyword\">do</span> <span class=\"built_in\">echo</span> <span class=\"variable\">$i</span>;scp /etc/kubernetes/ssl/admin*.pem <span class=\"variable\">$i</span>:/etc/kubernetes/ssl/;<span class=\"keyword\">done</span> </span><br></pre></td></tr></table></figure>\n\n<h4 id=\"4-2、admin-config\"><a href=\"#4-2、admin-config\" class=\"headerlink\" title=\"4.2、admin.config\"></a>4.2、admin.config</h4><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 1、设置集群参数</span></span><br><span class=\"line\">kubectl config set-cluster kubernetes --certificate-authority=ca.pem --embed-certs=<span class=\"literal\">true</span> --server=https://10.0.0.25:6444 --kubeconfig=admin.config</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 2、设置客户端认证参数</span></span><br><span class=\"line\">kubectl config set-credentials kubernetes-admin --client-certificate=admin.pem --client-key=admin-key.pem --embed-certs=<span class=\"literal\">true</span> --kubeconfig=admin.config</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 3、设置上下文参数</span></span><br><span class=\"line\">kubectl config set-context kubernetes --cluster=kubernetes --user=kubernetes-admin --kubeconfig=admin.config</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 4、设置当前上下文</span></span><br><span class=\"line\">kubectl config use-context kubernetes --kubeconfig=admin.config</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"4-3、kubernetes-kubelet-api\"><a href=\"#4-3、kubernetes-kubelet-api\" class=\"headerlink\" title=\"4.3、kubernetes-kubelet api\"></a>4.3、kubernetes-kubelet api</h4><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl create clusterrolebinding kube-apiserver:kubelet-apiserver --clusterrole=system.kubelet-api-admin --user kubernetes</span><br><span class=\"line\">kubectl create clusterrolebinding kubernetes --clusterrole=cluster-admin --user=kubernetes</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"4-4、send-to-other\"><a href=\"#4-4、send-to-other\" class=\"headerlink\" title=\"4.4、send to other\"></a>4.4、send to other</h4><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">cp</span> ~/work/admin.config /etc/kubernetes</span><br><span class=\"line\"><span class=\"built_in\">mkdir</span> -p <span class=\"variable\">$HOME</span>/.kube</span><br><span class=\"line\"><span class=\"built_in\">cp</span> -i /etc/kubernetes/admin.config <span class=\"variable\">$HOME</span>/.kube/config</span><br><span class=\"line\"><span class=\"built_in\">chown</span> $(<span class=\"built_in\">id</span> -u):$(<span class=\"built_in\">id</span> -g) <span class=\"variable\">$HOME</span>/.kube/config</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> `<span class=\"built_in\">cat</span> ~/MasterNodes.txt`;<span class=\"keyword\">do</span> <span class=\"built_in\">echo</span> <span class=\"variable\">$i</span>;scp /etc/kubernetes/admin.config <span class=\"variable\">$i</span>:/etc/kubernetes/;<span class=\"keyword\">done</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;export KUBECONFIG=/etc/kubernetes/admin.config&quot;</span> &gt;&gt; /etc/profile</span><br><span class=\"line\"><span class=\"built_in\">source</span> /etc/profile</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"4-5、kubectl-bash-completion\"><a href=\"#4-5、kubectl-bash-completion\" class=\"headerlink\" title=\"4.5、kubectl(bash-completion)\"></a>4.5、kubectl(bash-completion)</h4><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">source</span> &lt;(kubectl completion bash)</span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;source &lt;(kubectl completion bash)&quot;</span> &gt;&gt; /etc/profile</span><br><span class=\"line\"><span class=\"built_in\">source</span> /etc/profile</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"4-6、verify-kubectl\"><a href=\"#4-6、verify-kubectl\" class=\"headerlink\" title=\"4.6、verify kubectl\"></a>4.6、verify kubectl</h4><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl cluster-info</span><br><span class=\"line\">---</span><br><span class=\"line\">&#123;Kubernetes control plane is running at https://10.0.0.20:6443&#125;</span><br><span class=\"line\">---</span><br><span class=\"line\">kubectl get componentstatuses</span><br><span class=\"line\">---</span><br><span class=\"line\">NAME                 STATUS      MESSAGE                                                                                        ERROR</span><br><span class=\"line\">scheduler            Unhealthy   Get <span class=\"string\">&quot;https://127.0.0.1:10259/healthz&quot;</span>: dial tcp 127.0.0.1:10259: connect: connection refused   </span><br><span class=\"line\">controller-manager   Unhealthy   Get <span class=\"string\">&quot;https://127.0.0.1:10257/healthz&quot;</span>: dial tcp 127.0.0.1:10257: connect: connection refused   </span><br><span class=\"line\">etcd-0               Healthy     &#123;<span class=\"string\">&quot;health&quot;</span>:<span class=\"string\">&quot;true&quot;</span>,<span class=\"string\">&quot;reason&quot;</span>:<span class=\"string\">&quot;&quot;</span>&#125;                                           </span><br><span class=\"line\">etcd-1               Healthy     &#123;<span class=\"string\">&quot;health&quot;</span>:<span class=\"string\">&quot;true&quot;</span>,<span class=\"string\">&quot;reason&quot;</span>:<span class=\"string\">&quot;&quot;</span>&#125;                                           </span><br><span class=\"line\">etcd-2               Healthy     &#123;<span class=\"string\">&quot;health&quot;</span>:<span class=\"string\">&quot;true&quot;</span>,<span class=\"string\">&quot;reason&quot;</span>:<span class=\"string\">&quot;&quot;</span>&#125;                                           </span><br><span class=\"line\">---</span><br><span class=\"line\">kubectl get all --all-namespaces</span><br><span class=\"line\">---</span><br><span class=\"line\">NAMESPACE   NAME                 TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE</span><br><span class=\"line\">default     service/kubernetes   ClusterIP   10.96.0.1   &lt;none&gt;        443/TCP   56m</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"5、kube-controller-manager\"><a href=\"#5、kube-controller-manager\" class=\"headerlink\" title=\"5、kube-controller-manager\"></a>5、kube-controller-manager</h3><h4 id=\"5-1、kube-controller-manager-certificate\"><a href=\"#5-1、kube-controller-manager-certificate\" class=\"headerlink\" title=\"5.1、kube-controller-manager certificate\"></a>5.1、kube-controller-manager certificate</h4><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">cat</span> &gt; kube-controller-manager-csr.json &lt;&lt; <span class=\"string\">&quot;EOF&quot;</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;CN&quot;</span>: <span class=\"string\">&quot;system:kube-controller-manager&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;hosts&quot;</span>: [</span><br><span class=\"line\">    <span class=\"string\">&quot;127.0.0.1&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;10.0.0.20&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;10.0.0.21&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;10.0.0.22&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;10.0.0.25&quot;</span></span><br><span class=\"line\">  ],</span><br><span class=\"line\">  <span class=\"string\">&quot;key&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;algo&quot;</span>: <span class=\"string\">&quot;rsa&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;size&quot;</span>: 2048</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  <span class=\"string\">&quot;names&quot;</span>: [</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;C&quot;</span>: <span class=\"string\">&quot;CN&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;ST&quot;</span>: <span class=\"string\">&quot;Shanghai&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;L&quot;</span>: <span class=\"string\">&quot;Shanghai&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;O&quot;</span>: <span class=\"string\">&quot;system:kube-controller-manager&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;OU&quot;</span>: <span class=\"string\">&quot;Kubernetes&quot;</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  ]</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">EOF</span><br><span class=\"line\">---</span><br><span class=\"line\">cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes kube-controller-manager-csr.json | cfssljson -bare kube-controller-manager</span><br><span class=\"line\"><span class=\"built_in\">cp</span> kube-controller-manager*.pem /etc/kubernetes/ssl/</span><br><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> `<span class=\"built_in\">cat</span> ~/MasterNodes.txt`;<span class=\"keyword\">do</span> <span class=\"built_in\">echo</span> <span class=\"variable\">$i</span>;scp /etc/kubernetes/ssl/kube-controller-manager*.pem <span class=\"variable\">$i</span>:/etc/kubernetes/ssl/;<span class=\"keyword\">done</span></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"5-2、kube-controller-manager-kubeconfig\"><a href=\"#5-2、kube-controller-manager-kubeconfig\" class=\"headerlink\" title=\"5.2、kube-controller-manager.kubeconfig\"></a>5.2、kube-controller-manager.kubeconfig</h4><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 1、设置集群参数</span></span><br><span class=\"line\">kubectl config set-cluster kubernetes --certificate-authority=ca.pem --embed-certs=<span class=\"literal\">true</span> --server=https://10.0.0.25:6444 --kubeconfig=/etc/kubernetes/kube-controller-manager.kubeconfig</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 2、设置客户端认证参数</span></span><br><span class=\"line\">kubectl config set-credentials system:kube-controller-manager --client-certificate=kube-controller-manager.pem --client-key=kube-controller-manager-key.pem --embed-certs=<span class=\"literal\">true</span> --kubeconfig=/etc/kubernetes/kube-controller-manager.kubeconfig</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 3、设置上下文参数</span></span><br><span class=\"line\">kubectl config set-context system:kube-controller-manager --cluster=kubernetes --user=system:kube-controller-manager --kubeconfig=/etc/kubernetes/kube-controller-manager.kubeconfig</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 4、设置当前上下文</span></span><br><span class=\"line\">kubectl config use-context system:kube-controller-manager --kubeconfig=/etc/kubernetes/kube-controller-manager.kubeconfig</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"5-3、kube-controller-manager-conf\"><a href=\"#5-3、kube-controller-manager-conf\" class=\"headerlink\" title=\"5.3、kube-controller-manager.conf\"></a>5.3、kube-controller-manager.conf</h4><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">cat</span> &gt; /etc/kubernetes/kube-controller-manager.conf &lt;&lt; <span class=\"string\">&quot;EOF&quot;</span></span><br><span class=\"line\">KUBE_CONTROLLER_MANAGER_OPTS=<span class=\"string\">&quot;--v=2 \\</span></span><br><span class=\"line\"><span class=\"string\">  --secure-port=10257 \\</span></span><br><span class=\"line\"><span class=\"string\">  --bind-address=127.0.0.1 \\</span></span><br><span class=\"line\"><span class=\"string\">  --kubeconfig=/etc/kubernetes/kube-controller-manager.kubeconfig \\</span></span><br><span class=\"line\"><span class=\"string\">  --service-cluster-ip-range=10.96.0.0/16 \\</span></span><br><span class=\"line\"><span class=\"string\">  --cluster-name=kubernetes \\</span></span><br><span class=\"line\"><span class=\"string\">  --cluster-signing-cert-file=/etc/kubernetes/ssl/ca.pem \\</span></span><br><span class=\"line\"><span class=\"string\">  --cluster-signing-key-file=/etc/kubernetes/ssl/ca-key.pem \\</span></span><br><span class=\"line\"><span class=\"string\">  --allocate-node-cidrs=true \\</span></span><br><span class=\"line\"><span class=\"string\">  --cluster-cidr=10.244.0.0/16 \\</span></span><br><span class=\"line\"><span class=\"string\">  --experimental-cluster-signing-duration=87600h \\</span></span><br><span class=\"line\"><span class=\"string\">  --root-ca-file=/etc/kubernetes/ssl/ca.pem \\</span></span><br><span class=\"line\"><span class=\"string\">  --service-account-private-key-file=/etc/kubernetes/ssl/ca-key.pem \\</span></span><br><span class=\"line\"><span class=\"string\">  --leader-elect=true \\</span></span><br><span class=\"line\"><span class=\"string\">  --feature-gates=RotateKubeletServerCertificate=true \\</span></span><br><span class=\"line\"><span class=\"string\">  --controllers=*,bootstrapsigner,tokencleaner \\</span></span><br><span class=\"line\"><span class=\"string\">  --horizontal-pod-autoscaler-sync-period=10s \\</span></span><br><span class=\"line\"><span class=\"string\">  --tls-cert-file=/etc/kubernetes/ssl/kube-controller-manager.pem \\</span></span><br><span class=\"line\"><span class=\"string\">  --tls-private-key-file=/etc/kubernetes/ssl/kube-controller-manager-key.pem \\</span></span><br><span class=\"line\"><span class=\"string\">  --use-service-account-credentials=true&quot;</span></span><br><span class=\"line\">EOF</span><br><span class=\"line\">  ---</span><br><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> `<span class=\"built_in\">cat</span> ~/MasterNodes.txt`;<span class=\"keyword\">do</span> <span class=\"built_in\">echo</span> <span class=\"variable\">$i</span>;scp /etc/kubernetes/kube-controller-manager* <span class=\"variable\">$i</span>:/etc/kubernetes/;<span class=\"keyword\">done</span></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"5-4、kube-controller-manager-service\"><a href=\"#5-4、kube-controller-manager-service\" class=\"headerlink\" title=\"5.4、kube-controller-manager.service\"></a>5.4、kube-controller-manager.service</h4><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">cat</span> &gt; /usr/lib/systemd/system/kube-controller-manager.service &lt;&lt; <span class=\"string\">&quot;EOF&quot;</span></span><br><span class=\"line\">[Unit]</span><br><span class=\"line\">Description=Kubernetes Controller Manager</span><br><span class=\"line\">Documentation=https://github.com/kubernetes/kubernetes</span><br><span class=\"line\"></span><br><span class=\"line\">[Service]</span><br><span class=\"line\">EnvironmentFile=-/etc/kubernetes/kube-controller-manager.conf</span><br><span class=\"line\">ExecStart=/usr/local/bin/kube-controller-manager <span class=\"variable\">$KUBE_CONTROLLER_MANAGER_OPTS</span></span><br><span class=\"line\">Restart=on-failure</span><br><span class=\"line\">RestartSec=5</span><br><span class=\"line\"></span><br><span class=\"line\">[Install]</span><br><span class=\"line\">WantedBy=multi-user.target</span><br><span class=\"line\">EOF</span><br><span class=\"line\">---</span><br><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> `<span class=\"built_in\">cat</span> ~/MasterNodes.txt`;<span class=\"keyword\">do</span> <span class=\"built_in\">echo</span> <span class=\"variable\">$i</span>;scp /usr/lib/systemd/system/kube-controller-manager.service <span class=\"variable\">$i</span>:/usr/lib/systemd/system/;<span class=\"keyword\">done</span></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"5-5、start-kube-controller-manager-service\"><a href=\"#5-5、start-kube-controller-manager-service\" class=\"headerlink\" title=\"5.5、start kube-controller-manager.service\"></a>5.5、start kube-controller-manager.service</h4><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">systemctl daemon-reload</span><br><span class=\"line\">systemctl <span class=\"built_in\">enable</span> --now kube-controller-manager.service</span><br><span class=\"line\">systemctl status kube-controller-manager.service</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"6、kube-scheduler\"><a href=\"#6、kube-scheduler\" class=\"headerlink\" title=\"6、kube-scheduler\"></a>6、kube-scheduler</h3><h4 id=\"6-1、kube-scheduler-certificate\"><a href=\"#6-1、kube-scheduler-certificate\" class=\"headerlink\" title=\"6.1、kube-scheduler certificate\"></a>6.1、kube-scheduler certificate</h4><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">cat</span> &gt; kube-scheduler-csr.json &lt;&lt; <span class=\"string\">&quot;EOF&quot;</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;CN&quot;</span>: <span class=\"string\">&quot;system:kube-scheduler&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;hosts&quot;</span>: [</span><br><span class=\"line\">    <span class=\"string\">&quot;127.0.0.1&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;10.0.0.20&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;10.0.0.21&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;10.0.0.22&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;10.0.0.25&quot;</span></span><br><span class=\"line\">  ],</span><br><span class=\"line\">  <span class=\"string\">&quot;key&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;algo&quot;</span>: <span class=\"string\">&quot;rsa&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;size&quot;</span>: 2048</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  <span class=\"string\">&quot;names&quot;</span>: [</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;C&quot;</span>: <span class=\"string\">&quot;CN&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;ST&quot;</span>: <span class=\"string\">&quot;Shanghai&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;L&quot;</span>: <span class=\"string\">&quot;Shanghai&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;O&quot;</span>: <span class=\"string\">&quot;system:kube-scheduler&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;OU&quot;</span>: <span class=\"string\">&quot;system&quot;</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  ]</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">EOF</span><br><span class=\"line\">---</span><br><span class=\"line\">cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes kube-scheduler-csr.json | cfssljson -bare kube-scheduler</span><br><span class=\"line\"><span class=\"built_in\">cp</span> kube-scheduler*.pem /etc/kubernetes/ssl/</span><br><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> `<span class=\"built_in\">cat</span> ~/MasterNodes.txt`;<span class=\"keyword\">do</span> <span class=\"built_in\">echo</span> <span class=\"variable\">$i</span>;scp /etc/kubernetes/ssl/kube-scheduler*.pem <span class=\"variable\">$i</span>:/etc/kubernetes/ssl/;<span class=\"keyword\">done</span></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"6-2、kube-scheduler-kubeconfig\"><a href=\"#6-2、kube-scheduler-kubeconfig\" class=\"headerlink\" title=\"6.2、kube-scheduler.kubeconfig\"></a>6.2、kube-scheduler.kubeconfig</h4><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 1、设置集群参数</span></span><br><span class=\"line\">kubectl config set-cluster kubernetes --certificate-authority=ca.pem --embed-certs=<span class=\"literal\">true</span> --server=https://10.0.0.25:6444 --kubeconfig=/etc/kubernetes/kube-scheduler.kubeconfig</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 2、设置客户端认证参数</span></span><br><span class=\"line\">kubectl config set-credentials system:kube-scheduler --client-certificate=kube-scheduler.pem --client-key=kube-scheduler-key.pem --embed-certs=<span class=\"literal\">true</span> --kubeconfig=/etc/kubernetes/kube-scheduler.kubeconfig</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 3、设置上下文参数</span></span><br><span class=\"line\">kubectl config set-context system:kube-scheduler --cluster=kubernetes --user=system:kube-scheduler --kubeconfig=/etc/kubernetes/kube-scheduler.kubeconfig</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 4、设置当前上下文</span></span><br><span class=\"line\">kubectl config use-context system:kube-scheduler --kubeconfig=/etc/kubernetes/kube-scheduler.kubeconfig</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"6-3、kube-scheduler-conf\"><a href=\"#6-3、kube-scheduler-conf\" class=\"headerlink\" title=\"6.3、kube-scheduler.conf\"></a>6.3、kube-scheduler.conf</h4><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">cat</span> &gt; /etc/kubernetes/kube-scheduler.conf &lt;&lt; <span class=\"string\">&quot;EOF&quot;</span></span><br><span class=\"line\">KUBE_SCHEDULER_OPTS=<span class=\"string\">&quot;--address=127.0.0.1 \\</span></span><br><span class=\"line\"><span class=\"string\">  --kubeconfig=/etc/kubernetes/kube-scheduler.kubeconfig \\</span></span><br><span class=\"line\"><span class=\"string\">  --leader-elect=true \\</span></span><br><span class=\"line\"><span class=\"string\">  --alsologtostderr=true \\</span></span><br><span class=\"line\"><span class=\"string\">  --logtostderr=false \\</span></span><br><span class=\"line\"><span class=\"string\">  --log-dir=/var/log/kubernetes \\</span></span><br><span class=\"line\"><span class=\"string\">  --v=2&quot;</span></span><br><span class=\"line\">EOF</span><br><span class=\"line\">---</span><br><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> `<span class=\"built_in\">cat</span> ~/MasterNodes.txt`;<span class=\"keyword\">do</span> <span class=\"built_in\">echo</span> <span class=\"variable\">$i</span>;scp /etc/kubernetes/kube-scheduler* <span class=\"variable\">$i</span>:/etc/kubernetes/;<span class=\"keyword\">done</span></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"6-4、kube-scheduler-service\"><a href=\"#6-4、kube-scheduler-service\" class=\"headerlink\" title=\"6.4、kube-scheduler.service\"></a>6.4、kube-scheduler.service</h4><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">cat</span> &gt; /usr/lib/systemd/system/kube-scheduler.service &lt;&lt; <span class=\"string\">&quot;EOF&quot;</span></span><br><span class=\"line\">[Unit]</span><br><span class=\"line\">Description=Kubernetes Scheduler</span><br><span class=\"line\">Documentation=https://github.com/kubernetes/kubernetes</span><br><span class=\"line\"></span><br><span class=\"line\">[Service]</span><br><span class=\"line\">EnvironmentFile=-/etc/kubernetes/kube-scheduler.conf</span><br><span class=\"line\">ExecStart=/usr/local/bin/kube-scheduler <span class=\"variable\">$KUBE_SCHEDULER_OPTS</span></span><br><span class=\"line\">Restart=on-failure</span><br><span class=\"line\">RestartSec=5</span><br><span class=\"line\"></span><br><span class=\"line\">[Install]</span><br><span class=\"line\">WantedBy=multi-user.target</span><br><span class=\"line\">EOF</span><br><span class=\"line\">---</span><br><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> `<span class=\"built_in\">cat</span> ~/MasterNodes.txt`;<span class=\"keyword\">do</span> <span class=\"built_in\">echo</span> <span class=\"variable\">$i</span>;scp /usr/lib/systemd/system/kube-scheduler.service <span class=\"variable\">$i</span>:/usr/lib/systemd/system/;<span class=\"keyword\">done</span></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"6-5、start-kube-scheduler-service\"><a href=\"#6-5、start-kube-scheduler-service\" class=\"headerlink\" title=\"6.5、start kube-scheduler.service\"></a>6.5、start kube-scheduler.service</h4><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">systemctl daemon-reload</span><br><span class=\"line\">systemctl <span class=\"built_in\">enable</span> --now kube-scheduler.service</span><br><span class=\"line\">systemctl status kube-scheduler.service</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"四、Node\"><a href=\"#四、Node\" class=\"headerlink\" title=\"四、Node\"></a>四、Node</h2><h3 id=\"1、kubelet\"><a href=\"#1、kubelet\" class=\"headerlink\" title=\"1、kubelet\"></a>1、kubelet</h3><h4 id=\"1-1、BOOTSTRAP-TOKEN\"><a href=\"#1-1、BOOTSTRAP-TOKEN\" class=\"headerlink\" title=\"1.1、BOOTSTRAP_TOKEN\"></a>1.1、BOOTSTRAP_TOKEN</h4><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">BOOTSTRAP_TOKEN=$(awk -F <span class=\"string\">&quot;,&quot;</span> <span class=\"string\">&#x27;&#123;print $1&#125;&#x27;</span> /etc/kubernetes/token.csv)</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"1-2、kubelet-bootstrap-kubeconfig\"><a href=\"#1-2、kubelet-bootstrap-kubeconfig\" class=\"headerlink\" title=\"1.2、kubelet-bootstrap.kubeconfig\"></a>1.2、kubelet-bootstrap.kubeconfig</h4><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 1、设置集群参数</span></span><br><span class=\"line\">kubectl config set-cluster kubernetes --certificate-authority=ca.pem --embed-certs=<span class=\"literal\">true</span> --server=https://10.0.0.25:6444 --kubeconfig=/root/work/kubelet-bootstrap.kubeconfig</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 2、设置客户端认证参数</span></span><br><span class=\"line\">kubectl config set-credentials kubelet-bootstrap --token=<span class=\"variable\">$&#123;BOOTSTRAP_TOKEN&#125;</span> --kubeconfig=/root/work/kubelet-bootstrap.kubeconfig</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 3、设置上下文参数</span></span><br><span class=\"line\">kubectl config set-context default --cluster=kubernetes --user=kubelet-bootstrap --kubeconfig=/root/work/kubelet-bootstrap.kubeconfig</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 4、设置当前上下文</span></span><br><span class=\"line\">kubectl config use-context default --kubeconfig=/root/work/kubelet-bootstrap.kubeconfig</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 5、创建clusterrolebinding</span></span><br><span class=\"line\">kubectl delete clusterrolebinding kubelet-bootstrap</span><br><span class=\"line\">kubectl create clusterrolebinding kubelet-bootstrap --clusterrole=system:node-bootstrapper --user=kubelet-bootstrap</span><br><span class=\"line\">kubectl create clusterrolebinding cluster-system-anonymous --clusterrole=cluster-admin --user=kubelet-bootstrap</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"1-3、kubelet-json\"><a href=\"#1-3、kubelet-json\" class=\"headerlink\" title=\"1.3、kubelet.json\"></a>1.3、kubelet.json</h4><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">cat</span> &gt; ~/work/kubelet.json &lt;&lt; <span class=\"string\">&quot;EOF&quot;</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\"> <span class=\"string\">&quot;kind&quot;</span>: <span class=\"string\">&quot;KubeletConfiguration&quot;</span>,</span><br><span class=\"line\"> <span class=\"string\">&quot;apiVersion&quot;</span>: <span class=\"string\">&quot;kubelet.config.k8s.io/v1beta1&quot;</span>,</span><br><span class=\"line\"> <span class=\"string\">&quot;authentication&quot;</span>: &#123;</span><br><span class=\"line\">   <span class=\"string\">&quot;x509&quot;</span>: &#123;</span><br><span class=\"line\">     <span class=\"string\">&quot;clientCAFile&quot;</span>: <span class=\"string\">&quot;/etc/kubernetes/ssl/ca.pem&quot;</span></span><br><span class=\"line\">   &#125;,</span><br><span class=\"line\">   <span class=\"string\">&quot;webhook&quot;</span>: &#123;</span><br><span class=\"line\">     <span class=\"string\">&quot;enabled&quot;</span>: <span class=\"literal\">true</span>,</span><br><span class=\"line\">     <span class=\"string\">&quot;cacheTTL&quot;</span>: <span class=\"string\">&quot;2m0s&quot;</span></span><br><span class=\"line\">   &#125;,</span><br><span class=\"line\">   <span class=\"string\">&quot;anonymous&quot;</span>: &#123;</span><br><span class=\"line\">     <span class=\"string\">&quot;enabled&quot;</span>: <span class=\"literal\">false</span></span><br><span class=\"line\">   &#125;</span><br><span class=\"line\"> &#125;,</span><br><span class=\"line\"> <span class=\"string\">&quot;authorization&quot;</span>: &#123;</span><br><span class=\"line\">   <span class=\"string\">&quot;mode&quot;</span>: <span class=\"string\">&quot;Webhook&quot;</span>,</span><br><span class=\"line\">   <span class=\"string\">&quot;webhook&quot;</span>: &#123;</span><br><span class=\"line\">     <span class=\"string\">&quot;cacheAuthorizedTTL&quot;</span>: <span class=\"string\">&quot;5m0s&quot;</span>,</span><br><span class=\"line\">     <span class=\"string\">&quot;cacheUnauthorizedTTL&quot;</span>: <span class=\"string\">&quot;30s&quot;</span></span><br><span class=\"line\">   &#125;</span><br><span class=\"line\"> &#125;,</span><br><span class=\"line\"> <span class=\"string\">&quot;address&quot;</span>: <span class=\"string\">&quot;10.0.0.23&quot;</span>,</span><br><span class=\"line\"> <span class=\"string\">&quot;port&quot;</span>: 10250,</span><br><span class=\"line\"> <span class=\"string\">&quot;readOnlyPort&quot;</span>: 10255,</span><br><span class=\"line\"> <span class=\"string\">&quot;cgroupDriver&quot;</span>: <span class=\"string\">&quot;systemd&quot;</span>,</span><br><span class=\"line\"> <span class=\"string\">&quot;hairpinMode&quot;</span>: <span class=\"string\">&quot;promiscuous-bridge&quot;</span>,</span><br><span class=\"line\"> <span class=\"string\">&quot;serializeImagePulls&quot;</span>: <span class=\"literal\">false</span>,</span><br><span class=\"line\"> <span class=\"string\">&quot;clusterDomain&quot;</span>: <span class=\"string\">&quot;cluster.local.&quot;</span>,</span><br><span class=\"line\"> <span class=\"string\">&quot;clusterDNS&quot;</span>: [<span class=\"string\">&quot;10.96.0.2&quot;</span>]</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">EOF</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"1-4、kubelet-service\"><a href=\"#1-4、kubelet-service\" class=\"headerlink\" title=\"1.4、kubelet.service\"></a>1.4、kubelet.service</h4><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">cat</span> &gt; ~/work/kubelet.service &lt;&lt;<span class=\"string\">&quot;EOF&quot;</span></span><br><span class=\"line\">[Unit]</span><br><span class=\"line\">Description=Kubernetes Kubelet</span><br><span class=\"line\">Documentation=https://github.com/kubernetes/kubernetes</span><br><span class=\"line\">After=containerd.service</span><br><span class=\"line\">Requires=containerd.service</span><br><span class=\"line\"></span><br><span class=\"line\">[Service]</span><br><span class=\"line\">WorkingDirectory=/var/lib/kubelet</span><br><span class=\"line\">ExecStart=/usr/local/bin/kubelet \\</span><br><span class=\"line\"> --container-runtime=remote \\</span><br><span class=\"line\"> --container-runtime-endpoint=unix:///run/containerd/containerd.sock</span><br><span class=\"line\"> --bootstrap-kubeconfig=/etc/kubernetes/kubelet-bootstrap.kubeconfig \\</span><br><span class=\"line\"> --cert-dir=/etc/kubernetes/ssl \\</span><br><span class=\"line\"> --kubeconfig=/etc/kubernetes/kubelet.kubeconfig \\</span><br><span class=\"line\"> --config=/etc/kubernetes/kubelet.json \\</span><br><span class=\"line\"> --pod-infra-container-image=registry.aliyuncs.com/google_containers/pause:3.2 \\</span><br><span class=\"line\"> --v=2</span><br><span class=\"line\">Restart=on-failure</span><br><span class=\"line\">RestartSec=5</span><br><span class=\"line\"></span><br><span class=\"line\">[Install]</span><br><span class=\"line\">WantedBy=multi-user.target</span><br><span class=\"line\">EOF</span><br><span class=\"line\">---</span><br><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> `<span class=\"built_in\">cat</span> ~/WorkNodes.txt`;<span class=\"keyword\">do</span> <span class=\"built_in\">echo</span> <span class=\"variable\">$i</span>;scp ~/work/kubelet.json ~/work/kubelet-bootstrap.kubeconfig <span class=\"variable\">$i</span>:/etc/kubernetes;<span class=\"keyword\">done</span></span><br><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> `<span class=\"built_in\">cat</span> ~/WorkNodes.txt`;<span class=\"keyword\">do</span> <span class=\"built_in\">echo</span> <span class=\"variable\">$i</span>;scp ~/work/kubelet.service <span class=\"variable\">$i</span>:/usr/lib/systemd/system;<span class=\"keyword\">done</span></span><br><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> `<span class=\"built_in\">cat</span> ~/WorkNodes.txt`;<span class=\"keyword\">do</span> <span class=\"built_in\">echo</span> <span class=\"variable\">$i</span>;scp /etc/kubernetes/ssl/ca.pem <span class=\"variable\">$i</span>:/etc/kubernetes/ssl/;<span class=\"keyword\">done</span></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"1-5、start-kubelet-services\"><a href=\"#1-5、start-kubelet-services\" class=\"headerlink\" title=\"1.5、start kubelet.services\"></a>1.5、start kubelet.services</h4><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">mkdir</span> -p /var/lib/kubelet</span><br><span class=\"line\">systemctl daemon-reload</span><br><span class=\"line\">systemctl <span class=\"built_in\">enable</span> --now kubelet.service</span><br><span class=\"line\">systemctl status kubelet.service</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"1-6、Approve-Nodes\"><a href=\"#1-6、Approve-Nodes\" class=\"headerlink\" title=\"1.6、Approve Nodes\"></a>1.6、Approve Nodes</h4><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl get csr |grep node |awk <span class=\"string\">&#x27;&#123;print$1,$6&#125;&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">&quot;+---                                                  |     ---+&quot;</span></span><br><span class=\"line\">  node-csr-BV7RZ1Mc1RFkWhH9jzJH8h8on_dRMB3an_7FgBUwWhk   Pending</span><br><span class=\"line\">  node-csr-wZOI__ACKylv7DlEPRK8iMg3_sYyBErjbGjxkMkRyPo   Pending</span><br><span class=\"line\"><span class=\"string\">&quot;+---                                                  |     ---+&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\">kubectl certificate approve node-csr-csr-BV7RZ1Mc1RFkWhH9jzJH8h8on_dRMB3an_7FgBUwWhk node-csr-wZOI__ACKylv7DlEPRK8iMg3_sYyBErjbGjxkMkRyPo</span><br><span class=\"line\"></span><br><span class=\"line\">kubectl get nodes</span><br><span class=\"line\">NAME         STATUS   ROLES    AGE    VERSION</span><br><span class=\"line\">k8s-node01   Ready    &lt;none&gt;   118m   v1.23.5</span><br><span class=\"line\">k8s-node02   Ready    &lt;none&gt;   118m   v1.23.5</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"2、kube-pproxy\"><a href=\"#2、kube-pproxy\" class=\"headerlink\" title=\"2、kube-pproxy\"></a>2、kube-pproxy</h3><h4 id=\"2-1、kube-proxy-certificate\"><a href=\"#2-1、kube-proxy-certificate\" class=\"headerlink\" title=\"2.1、kube-proxy certificate\"></a>2.1、kube-proxy certificate</h4><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">cat</span> &gt; kube-proxy-csr.json &lt;&lt; <span class=\"string\">&quot;EOF&quot;</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;CN&quot;</span>: <span class=\"string\">&quot;system:kube-proxy&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;key&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;algo&quot;</span>: <span class=\"string\">&quot;rsa&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;size&quot;</span>: 2048</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  <span class=\"string\">&quot;names&quot;</span>: [</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;C&quot;</span>: <span class=\"string\">&quot;CN&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;ST&quot;</span>: <span class=\"string\">&quot;Shanghai&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;L&quot;</span>: <span class=\"string\">&quot;Shanghai&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;O&quot;</span>: <span class=\"string\">&quot;k8s&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;OU&quot;</span>: <span class=\"string\">&quot;system&quot;</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  ]</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">EOF</span><br><span class=\"line\">---</span><br><span class=\"line\">cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes kube-proxy-csr.json | cfssljson -bare kube-proxy</span><br><span class=\"line\"><span class=\"built_in\">cp</span> kube-proxy*.pem /etc/kubernetes/ssl/</span><br><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> `<span class=\"built_in\">cat</span> ~/WorkNodes.txt`;<span class=\"keyword\">do</span> <span class=\"built_in\">echo</span> <span class=\"variable\">$i</span>;scp ~/work/kube-proxy*.pem <span class=\"variable\">$i</span>:/etc/kubernetes/ssl/;<span class=\"keyword\">done</span></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"2-2、kube-proxy-kubeconfig\"><a href=\"#2-2、kube-proxy-kubeconfig\" class=\"headerlink\" title=\"2.2、kube-proxy.kubeconfig\"></a>2.2、kube-proxy.kubeconfig</h4><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 1、设置集群参数</span></span><br><span class=\"line\">kubectl config set-cluster kubernetes --certificate-authority=ca.pem --embed-certs=<span class=\"literal\">true</span> --server=https://10.0.0.25:6444 --kubeconfig=/root/work/kube-proxy.kubeconfig</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 2、设置客户端认证参数</span></span><br><span class=\"line\">kubectl config set-credentials kube-proxy --client-certificate=kube-proxy.pem --client-key=kube-proxy-key.pem --embed-certs=<span class=\"literal\">true</span> --kubeconfig=/root/work/kube-proxy.kubeconfig</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 3、设置上下文参数</span></span><br><span class=\"line\">kubectl config set-context default --cluster=kubernetes --user=kube-proxy --kubeconfig=/root/work/kube-proxy.kubeconfig</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 4、设置当前上下文</span></span><br><span class=\"line\">kubectl config use-context default --kubeconfig=/root/work/kube-proxy.kubeconfig</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"2-3、kube-proxy-yaml\"><a href=\"#2-3、kube-proxy-yaml\" class=\"headerlink\" title=\"2.3、kube-proxy.yaml\"></a>2.3、kube-proxy.yaml</h4><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 以下bindAddress均为宿主机ip,clusterCIDR为宿主机网段</span></span><br><span class=\"line\">---</span><br><span class=\"line\"><span class=\"built_in\">cat</span> &gt; ~/work/kube-proxy.yaml &lt;&lt; <span class=\"string\">&quot;EOF&quot;</span></span><br><span class=\"line\">apiVersion: kubeproxy.config.k8s.io/v1alpha1</span><br><span class=\"line\">bindAddress: 10.0.0.23</span><br><span class=\"line\">clientConnection:</span><br><span class=\"line\">  kubeconfig: /etc/kubernetes/kube-proxy.kubeconfig</span><br><span class=\"line\">clusterCIDR: 10.244.0.0/24</span><br><span class=\"line\">healthzBindAddress: 10.0.0.23:10256</span><br><span class=\"line\">kind: KubeProxyConfiguration</span><br><span class=\"line\">metricsBindAddress: 10.0.0.23:10249</span><br><span class=\"line\">mode: <span class=\"string\">&quot;ipvs&quot;</span></span><br><span class=\"line\">EOF</span><br><span class=\"line\">---</span><br><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> `<span class=\"built_in\">cat</span> ~/WorkNodes.txt`;<span class=\"keyword\">do</span> <span class=\"built_in\">echo</span> <span class=\"variable\">$i</span>;scp ~/work/kube-proxy.yaml ~/work/kube-proxy.kubeconfig <span class=\"variable\">$i</span>:/etc/kubernetes/;<span class=\"keyword\">done</span></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"2-4、kube-proxy-service\"><a href=\"#2-4、kube-proxy-service\" class=\"headerlink\" title=\"2.4、kube-proxy.service\"></a>2.4、kube-proxy.service</h4><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">cat</span> &gt; ~/work/kube-proxy.service &lt;&lt; <span class=\"string\">&quot;EOF&quot;</span></span><br><span class=\"line\">[Unit]</span><br><span class=\"line\">Description=Kubernetes Kube-Proxy Server</span><br><span class=\"line\">Documentation=https://github.com/kubernetes/kubernetes</span><br><span class=\"line\">After=network.target</span><br><span class=\"line\"></span><br><span class=\"line\">[Service]</span><br><span class=\"line\">WorkingDirectory=/var/lib/kube-proxy</span><br><span class=\"line\">ExecStart=/usr/local/bin/kube-proxy \\</span><br><span class=\"line\"> --config=/etc/kubernetes/kube-proxy.yaml \\</span><br><span class=\"line\"> --alsologtostderr=<span class=\"literal\">true</span> \\</span><br><span class=\"line\"> --logtostderr=<span class=\"literal\">false</span> \\</span><br><span class=\"line\"> --log-dir=/var/log/kubernetes \\</span><br><span class=\"line\"> --v=2</span><br><span class=\"line\">Restart=on-failure</span><br><span class=\"line\">RestartSec=5</span><br><span class=\"line\">LimitNOFILE=65536</span><br><span class=\"line\"></span><br><span class=\"line\">[Install]</span><br><span class=\"line\">WantedBy=multi-user.target</span><br><span class=\"line\">EOF</span><br><span class=\"line\">---</span><br><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> `<span class=\"built_in\">cat</span> ~/WorkNodes.txt`;<span class=\"keyword\">do</span> <span class=\"built_in\">echo</span> <span class=\"variable\">$i</span>;scp ~/work/kube-proxy.service <span class=\"variable\">$i</span>:/usr/lib/systemd/system;<span class=\"keyword\">done</span></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"2-5、start-kube-proxy-services\"><a href=\"#2-5、start-kube-proxy-services\" class=\"headerlink\" title=\"2.5、start kube-proxy.services\"></a>2.5、start kube-proxy.services</h4><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">mkdir</span> -p /var/lib/kube-proxy</span><br><span class=\"line\">systemctl daemon-reload</span><br><span class=\"line\">systemctl <span class=\"built_in\">enable</span> --now kube-proxy.service</span><br><span class=\"line\">systemctl status kube-proxy.service</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"五、network\"><a href=\"#五、network\" class=\"headerlink\" title=\"五、network\"></a>五、network</h2><h3 id=\"1、calico\"><a href=\"#1、calico\" class=\"headerlink\" title=\"1、calico\"></a>1、calico</h3><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">wget https://docs.projectcalico.org/manifests/calico.yaml</span><br><span class=\"line\">kubectl apply -f calico.yaml</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"2、coredns\"><a href=\"#2、coredns\" class=\"headerlink\" title=\"2、coredns\"></a>2、coredns</h3><h4 id=\"2-1、resolv-conf\"><a href=\"#2-1、resolv-conf\" class=\"headerlink\" title=\"2.1、resolv.conf\"></a>2.1、resolv.conf</h4><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">mv</span> /etc/resolv.conf  /etc/resolv.conf.bak</span><br><span class=\"line\"><span class=\"built_in\">ln</span> -s /run/systemd/resolve/resolv.conf /etc/</span><br><span class=\"line\">systemctl restart systemd-resolved.service &amp;&amp; systemctl <span class=\"built_in\">enable</span> systemd-resolved.service</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"2-2、coredns-yaml\"><a href=\"#2-2、coredns-yaml\" class=\"headerlink\" title=\"2.2、coredns.yaml\"></a>2.2、coredns.yaml</h4><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br><span class=\"line\">185</span><br><span class=\"line\">186</span><br><span class=\"line\">187</span><br><span class=\"line\">188</span><br><span class=\"line\">189</span><br><span class=\"line\">190</span><br><span class=\"line\">191</span><br><span class=\"line\">192</span><br><span class=\"line\">193</span><br><span class=\"line\">194</span><br><span class=\"line\">195</span><br><span class=\"line\">196</span><br><span class=\"line\">197</span><br><span class=\"line\">198</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">kind: ServiceAccount</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: coredns</span><br><span class=\"line\">  namespace: kube-system</span><br><span class=\"line\">---</span><br><span class=\"line\">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class=\"line\">kind: ClusterRole</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    kubernetes.io/bootstrapping: rbac-defaults</span><br><span class=\"line\">  name: system:coredns</span><br><span class=\"line\">rules:</span><br><span class=\"line\">  - apiGroups:</span><br><span class=\"line\">    - <span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\">    resources:</span><br><span class=\"line\">    - endpoints</span><br><span class=\"line\">    - services</span><br><span class=\"line\">    - pods</span><br><span class=\"line\">    - namespaces</span><br><span class=\"line\">    verbs:</span><br><span class=\"line\">    - list</span><br><span class=\"line\">    - watch</span><br><span class=\"line\">  - apiGroups:</span><br><span class=\"line\">    - discovery.k8s.io</span><br><span class=\"line\">    resources:</span><br><span class=\"line\">    - endpointslices</span><br><span class=\"line\">    verbs:</span><br><span class=\"line\">    - list</span><br><span class=\"line\">    - watch</span><br><span class=\"line\">---</span><br><span class=\"line\">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class=\"line\">kind: ClusterRoleBinding</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  annotations:</span><br><span class=\"line\">    rbac.authorization.kubernetes.io/autoupdate: <span class=\"string\">&quot;true&quot;</span></span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    kubernetes.io/bootstrapping: rbac-defaults</span><br><span class=\"line\">  name: system:coredns</span><br><span class=\"line\">roleRef:</span><br><span class=\"line\">  apiGroup: rbac.authorization.k8s.io</span><br><span class=\"line\">  kind: ClusterRole</span><br><span class=\"line\">  name: system:coredns</span><br><span class=\"line\">subjects:</span><br><span class=\"line\">- kind: ServiceAccount</span><br><span class=\"line\">  name: coredns</span><br><span class=\"line\">  namespace: kube-system</span><br><span class=\"line\">---</span><br><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">kind: ConfigMap</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: coredns</span><br><span class=\"line\">  namespace: kube-system</span><br><span class=\"line\">data:</span><br><span class=\"line\">  Corefile: |</span><br><span class=\"line\">    .:53 &#123;</span><br><span class=\"line\">        errors</span><br><span class=\"line\">        health &#123;</span><br><span class=\"line\">          lameduck 5s</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        ready</span><br><span class=\"line\">        kubernetes cluster.local in-addr.arpa ip6.arpa &#123;</span><br><span class=\"line\">          fallthrough in-addr.arpa ip6.arpa</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        prometheus :9153</span><br><span class=\"line\">        forward . /etc/resolv.conf &#123;</span><br><span class=\"line\">          max_concurrent 1000</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        cache 30</span><br><span class=\"line\">        loop</span><br><span class=\"line\">        reload</span><br><span class=\"line\">        loadbalance</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">---</span><br><span class=\"line\">apiVersion: apps/v1</span><br><span class=\"line\">kind: Deployment</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: coredns</span><br><span class=\"line\">  namespace: kube-system</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    k8s-app: kube-dns</span><br><span class=\"line\">    kubernetes.io/name: <span class=\"string\">&quot;CoreDNS&quot;</span></span><br><span class=\"line\">spec:</span><br><span class=\"line\">  <span class=\"comment\"># replicas: not specified here:</span></span><br><span class=\"line\">  <span class=\"comment\"># 1. Default is 1.</span></span><br><span class=\"line\">  <span class=\"comment\"># 2. Will be tuned in real time if DNS horizontal auto-scaling is turned on.</span></span><br><span class=\"line\">  strategy:</span><br><span class=\"line\">    <span class=\"built_in\">type</span>: RollingUpdate</span><br><span class=\"line\">    rollingUpdate:</span><br><span class=\"line\">      maxUnavailable: 1</span><br><span class=\"line\">  selector:</span><br><span class=\"line\">    matchLabels:</span><br><span class=\"line\">      k8s-app: kube-dns</span><br><span class=\"line\">  template:</span><br><span class=\"line\">    metadata:</span><br><span class=\"line\">      labels:</span><br><span class=\"line\">        k8s-app: kube-dns</span><br><span class=\"line\">    spec:</span><br><span class=\"line\">      priorityClassName: system-cluster-critical</span><br><span class=\"line\">      serviceAccountName: coredns</span><br><span class=\"line\">      tolerations:</span><br><span class=\"line\">        - key: <span class=\"string\">&quot;CriticalAddonsOnly&quot;</span></span><br><span class=\"line\">          operator: <span class=\"string\">&quot;Exists&quot;</span></span><br><span class=\"line\">      nodeSelector:</span><br><span class=\"line\">        kubernetes.io/os: linux</span><br><span class=\"line\">      affinity:</span><br><span class=\"line\">         podAntiAffinity:</span><br><span class=\"line\">           preferredDuringSchedulingIgnoredDuringExecution:</span><br><span class=\"line\">           - weight: 100</span><br><span class=\"line\">             podAffinityTerm:</span><br><span class=\"line\">               labelSelector:</span><br><span class=\"line\">                 matchExpressions:</span><br><span class=\"line\">                   - key: k8s-app</span><br><span class=\"line\">                     operator: In</span><br><span class=\"line\">                     values: [<span class=\"string\">&quot;kube-dns&quot;</span>]</span><br><span class=\"line\">               topologyKey: kubernetes.io/hostname</span><br><span class=\"line\">      containers:</span><br><span class=\"line\">      - name: coredns</span><br><span class=\"line\">        image: coredns/coredns:1.8.4</span><br><span class=\"line\">        imagePullPolicy: IfNotPresent</span><br><span class=\"line\">        resources:</span><br><span class=\"line\">          limits:</span><br><span class=\"line\">            memory: 170Mi</span><br><span class=\"line\">          requests:</span><br><span class=\"line\">            cpu: 100m</span><br><span class=\"line\">            memory: 70Mi</span><br><span class=\"line\">        args: [ <span class=\"string\">&quot;-conf&quot;</span>, <span class=\"string\">&quot;/etc/coredns/Corefile&quot;</span> ]</span><br><span class=\"line\">        volumeMounts:</span><br><span class=\"line\">        - name: config-volume</span><br><span class=\"line\">          mountPath: /etc/coredns</span><br><span class=\"line\">          readOnly: <span class=\"literal\">true</span></span><br><span class=\"line\">        ports:</span><br><span class=\"line\">        - containerPort: 53</span><br><span class=\"line\">          name: dns</span><br><span class=\"line\">          protocol: UDP</span><br><span class=\"line\">        - containerPort: 53</span><br><span class=\"line\">          name: dns-tcp</span><br><span class=\"line\">          protocol: TCP</span><br><span class=\"line\">        - containerPort: 9153</span><br><span class=\"line\">          name: metrics</span><br><span class=\"line\">          protocol: TCP</span><br><span class=\"line\">        securityContext:</span><br><span class=\"line\">          allowPrivilegeEscalation: <span class=\"literal\">false</span></span><br><span class=\"line\">          capabilities:</span><br><span class=\"line\">            add:</span><br><span class=\"line\">            - NET_BIND_SERVICE</span><br><span class=\"line\">            drop:</span><br><span class=\"line\">            - all</span><br><span class=\"line\">          readOnlyRootFilesystem: <span class=\"literal\">true</span></span><br><span class=\"line\">        livenessProbe:</span><br><span class=\"line\">          httpGet:</span><br><span class=\"line\">            path: /health</span><br><span class=\"line\">            port: 8080</span><br><span class=\"line\">            scheme: HTTP</span><br><span class=\"line\">          initialDelaySeconds: 60</span><br><span class=\"line\">          timeoutSeconds: 5</span><br><span class=\"line\">          successThreshold: 1</span><br><span class=\"line\">          failureThreshold: 5</span><br><span class=\"line\">        readinessProbe:</span><br><span class=\"line\">          httpGet:</span><br><span class=\"line\">            path: /ready</span><br><span class=\"line\">            port: 8181</span><br><span class=\"line\">            scheme: HTTP</span><br><span class=\"line\">      dnsPolicy: Default</span><br><span class=\"line\">      volumes:</span><br><span class=\"line\">        - name: config-volume</span><br><span class=\"line\">          configMap:</span><br><span class=\"line\">            name: coredns</span><br><span class=\"line\">            items:</span><br><span class=\"line\">            - key: Corefile</span><br><span class=\"line\">              path: Corefile</span><br><span class=\"line\">---</span><br><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">kind: Service</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: kube-dns</span><br><span class=\"line\">  namespace: kube-system</span><br><span class=\"line\">  annotations:</span><br><span class=\"line\">    prometheus.io/port: <span class=\"string\">&quot;9153&quot;</span></span><br><span class=\"line\">    prometheus.io/scrape: <span class=\"string\">&quot;true&quot;</span></span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    k8s-app: kube-dns</span><br><span class=\"line\">    kubernetes.io/cluster-service: <span class=\"string\">&quot;true&quot;</span></span><br><span class=\"line\">    kubernetes.io/name: <span class=\"string\">&quot;CoreDNS&quot;</span></span><br><span class=\"line\">spec:</span><br><span class=\"line\">  selector:</span><br><span class=\"line\">    k8s-app: kube-dns</span><br><span class=\"line\">  clusterIP: 10.96.0.2</span><br><span class=\"line\">  ports:</span><br><span class=\"line\">  - name: dns</span><br><span class=\"line\">    port: 53</span><br><span class=\"line\">    protocol: UDP</span><br><span class=\"line\">  - name: dns-tcp</span><br><span class=\"line\">    port: 53</span><br><span class=\"line\">    protocol: TCP</span><br><span class=\"line\">  - name: metrics</span><br><span class=\"line\">    port: 9153</span><br><span class=\"line\">    protocol: TCP</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"2-3、install\"><a href=\"#2-3、install\" class=\"headerlink\" title=\"2.3、install\"></a>2.3、install</h4><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl apply -f coredns.yaml</span><br></pre></td></tr></table></figure>\n\n","site":{"data":{}},"excerpt":"<p>ubuntu install kubernetes(containerd)</p>","more":"<h2 id=\"一、Prepare\"><a href=\"#一、Prepare\" class=\"headerlink\" title=\"一、Prepare\"></a>一、Prepare</h2><h3 id=\"1、system\"><a href=\"#1、system\" class=\"headerlink\" title=\"1、system\"></a>1、system</h3><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 1、sources.list</span></span><br><span class=\"line\"><span class=\"built_in\">mv</span> /etc/apt/sources.list /etc/apt/sources.list.bak</span><br><span class=\"line\"><span class=\"built_in\">cat</span>  /etc/apt/sources.list.bak |grep -v <span class=\"string\">&quot;#&quot;</span> |grep -v <span class=\"string\">&quot;^$&quot;</span> &gt; sources.list</span><br><span class=\"line\">sed -i s/archive.ubuntu.com/mirrors.ustc.edu.cn/g /etc/apt/sources.list</span><br><span class=\"line\">sed -i s/security.ubuntu.com/mirrors.ustc.edu.cn/g /etc/apt/sources.list</span><br><span class=\"line\">apt -y update &amp;&amp; apt -y upgrade</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 2、timedatectl</span></span><br><span class=\"line\">sed -i s/en_US/C/g /etc/default/locale</span><br><span class=\"line\">timedatectl set-timezone Asia/Shanghai</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 3、bash-completion</span></span><br><span class=\"line\">sed -i 97,99s/<span class=\"comment\">#//g /root/.bashrc</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 4、ssh</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;PermitRootLogin yes&quot;</span> &gt;&gt; /etc/ssh/sshd_config</span><br><span class=\"line\">passwd root &lt;&lt; <span class=\"string\">&quot;EOF&quot;</span></span><br><span class=\"line\">password</span><br><span class=\"line\">password</span><br><span class=\"line\">EOF</span><br><span class=\"line\">systemctl reload ssh</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 5、hosts</span></span><br><span class=\"line\">vim /etc/hosts</span><br><span class=\"line\">10.0.0.20 k8s-master00</span><br><span class=\"line\">10.0.0.21 k8s-master01</span><br><span class=\"line\">10.0.0.22 k8s-master02</span><br><span class=\"line\">10.0.0.23 k8s-node01</span><br><span class=\"line\">10.0.0.24 k8s-node02</span><br><span class=\"line\">10.0.0.25 k8s-bl-master</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 6、ssh-keygen</span></span><br><span class=\"line\">ssh-keygen -t rsa</span><br><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> `<span class=\"built_in\">cat</span> /root/*.txt`;<span class=\"keyword\">do</span> <span class=\"built_in\">echo</span> <span class=\"variable\">$i</span>;ssh-copy-id -i .ssh/id_rsa.pub <span class=\"variable\">$i</span>;<span class=\"keyword\">done</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 7、swap</span></span><br><span class=\"line\">swapoff -a</span><br><span class=\"line\">sed -i <span class=\"string\">&#x27;/swap/s/^\\(.*\\)$/#\\1/g&#x27;</span> /etc/fstab</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 8、network</span></span><br><span class=\"line\">net=`<span class=\"built_in\">cat</span> /etc/netplan/00-installer-config.yaml |awk <span class=\"string\">&#x27;NR==4&#123;print $1&#125;&#x27;</span>`</span><br><span class=\"line\">sed -i <span class=\"string\">&quot;s/<span class=\"variable\">$&#123;net&#125;</span>/eth0:/g&quot;</span> /etc/netplan/00-installer-config.yaml</span><br><span class=\"line\">sed -i <span class=\"string\">&#x27;11s/&quot;&quot;/&quot;net.ifnames=0 biosdevname=0&quot;/g&#x27;</span> /etc/default/grub</span><br><span class=\"line\">update-grub</span><br><span class=\"line\">reboot</span><br></pre></td></tr></table></figure>\n<h3 id=\"2、ipvs\"><a href=\"#2、ipvs\" class=\"headerlink\" title=\"2、ipvs\"></a>2、ipvs</h3><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">apt -y install ipvsadm ipset sysstat conntrack libseccomp2 libseccomp-dev</span><br><span class=\"line\"><span class=\"built_in\">cat</span> &gt; /etc/modules-load.d/ipvs.conf &lt;&lt; <span class=\"string\">EOF</span></span><br><span class=\"line\"><span class=\"string\">ip_vs</span></span><br><span class=\"line\"><span class=\"string\">ip_vs_lc</span></span><br><span class=\"line\"><span class=\"string\">ip_vs_wlc</span></span><br><span class=\"line\"><span class=\"string\">ip_vs_rr</span></span><br><span class=\"line\"><span class=\"string\">ip_vs_wrr</span></span><br><span class=\"line\"><span class=\"string\">ip_vs_lblc</span></span><br><span class=\"line\"><span class=\"string\">ip_vs_lblcr</span></span><br><span class=\"line\"><span class=\"string\">ip_vs_dh</span></span><br><span class=\"line\"><span class=\"string\">ip_vs_sh</span></span><br><span class=\"line\"><span class=\"string\">ip_vs_fo</span></span><br><span class=\"line\"><span class=\"string\">ip_vs_nq</span></span><br><span class=\"line\"><span class=\"string\">ip_vs_sed</span></span><br><span class=\"line\"><span class=\"string\">ip_vs_ftp</span></span><br><span class=\"line\"><span class=\"string\">nf_conntrack</span></span><br><span class=\"line\"><span class=\"string\">ip_tables</span></span><br><span class=\"line\"><span class=\"string\">ip_set</span></span><br><span class=\"line\"><span class=\"string\">xt_set</span></span><br><span class=\"line\"><span class=\"string\">ipt_set</span></span><br><span class=\"line\"><span class=\"string\">ipt_rpfilter</span></span><br><span class=\"line\"><span class=\"string\">ipt_REJECT</span></span><br><span class=\"line\"><span class=\"string\">ipip</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br><span class=\"line\">systemctl restart systemd-modules-load.service</span><br><span class=\"line\">lsmod |grep -e ip_vs -e nf_conntrack_ipv4</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"3、containerd\"><a href=\"#3、containerd\" class=\"headerlink\" title=\"3、containerd\"></a>3、containerd</h3><h4 id=\"3-1、download-containerd\"><a href=\"#3-1、download-containerd\" class=\"headerlink\" title=\"3.1、download containerd\"></a>3.1、download containerd</h4><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">wget https://github.com/containerd/containerd/releases/download/v1.6.1/cri-containerd-cni-1.6.1-linux-amd64.tar.gz</span><br><span class=\"line\">tar --no-overwrite-dir -C / -xzf cri-containerd-cni-1.6.1-linux-amd64.tar.gz</span><br><span class=\"line\">systemctl daemon-reload</span><br><span class=\"line\">systemctl <span class=\"built_in\">enable</span> --now containerd</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"3-2、config-toml\"><a href=\"#3-2、config-toml\" class=\"headerlink\" title=\"3.2、config.toml\"></a>3.2、config.toml</h4><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">containerd config default &gt; /etc/containerd/config.toml</span><br><span class=\"line\">---</span><br><span class=\"line\">sed -i <span class=\"string\">&quot;s#k8s.gcr.io#registry.aliyuncs.com/google_containers#g&quot;</span> /etc/containerd/config.toml</span><br><span class=\"line\">sed -i <span class=\"string\">&quot;s#SystemdCgroup = false#SystemdCgroup = true#g&quot;</span> /etc/containerd/config.toml</span><br><span class=\"line\">sed -i <span class=\"string\">&#x27;153a\\        [plugins.&quot;io.containerd.grpc.v1.cri&quot;.registry.mirrors.&quot;docker.io&quot;]&#x27;</span> /etc/containerd/config.toml  <span class=\"comment\"># 8个空格 # endpoint 10个空格</span></span><br><span class=\"line\">sed -i <span class=\"string\">&#x27;154a\\          endpoint = [&quot;https://registry.aliyuncs.com&quot;]&#x27;</span> /etc/containerd/config.toml</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"3-3、crictl-yaml\"><a href=\"#3-3、crictl-yaml\" class=\"headerlink\" title=\"3.3、crictl.yaml\"></a>3.3、crictl.yaml</h4><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">mv</span> /etc/crictl.yaml /etc/crictl.yaml.bak</span><br><span class=\"line\"><span class=\"built_in\">cat</span> &gt; /etc/crictl.yaml &lt;&lt; <span class=\"string\">&quot;EOF&quot;</span></span><br><span class=\"line\">runtime-endpoint: unix:///run/containerd/containerd.sock</span><br><span class=\"line\">image-endpoint: unix:///run/containerd/containerd.sock</span><br><span class=\"line\"><span class=\"built_in\">timeout</span>: 0</span><br><span class=\"line\">debug: <span class=\"literal\">false</span></span><br><span class=\"line\">pull-image-on-create: <span class=\"literal\">false</span></span><br><span class=\"line\">disable-pull-on-run: <span class=\"literal\">false</span></span><br><span class=\"line\">EOF</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"二、High-availability\"><a href=\"#二、High-availability\" class=\"headerlink\" title=\"二、High availability\"></a>二、High availability</h2><h3 id=\"1、nginx-conf\"><a href=\"#1、nginx-conf\" class=\"headerlink\" title=\"1、nginx.conf\"></a>1、nginx.conf</h3><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">apt -y install nginx</span><br><span class=\"line\"><span class=\"built_in\">cp</span> /etc/nginx/nginx.conf /etc/nginx/nginx.conf.bak</span><br><span class=\"line\">vim /etc/nginx/nginx.conf</span><br><span class=\"line\">---</span><br><span class=\"line\">...</span><br><span class=\"line\">...</span><br><span class=\"line\">stream &#123;</span><br><span class=\"line\">          </span><br><span class=\"line\">        log_format main <span class=\"string\">&#x27;$remote_addr $upstream_addr - [$time_local] $status $upstream_bytes_sent&#x27;</span>;</span><br><span class=\"line\">          </span><br><span class=\"line\">        access_log /var/log/nginx/k8s-access.log main;</span><br><span class=\"line\">        </span><br><span class=\"line\">        upstream k8s-apiserver &#123;</span><br><span class=\"line\">                server 10.0.0.20:6443;</span><br><span class=\"line\">                server 10.0.0.21:6443;</span><br><span class=\"line\">                server 10.0.0.22:6443;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">        server &#123;</span><br><span class=\"line\">                listen 6444; </span><br><span class=\"line\">                proxy_pass k8s-apiserver;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">http &#123;</span><br><span class=\"line\">\t\tlog_format main <span class=\"string\">&#x27;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#x27;</span></span><br><span class=\"line\">                        <span class=\"string\">&#x27;$status $body_bytes_sent &quot;$http_referer&quot; &#x27;</span></span><br><span class=\"line\">                        <span class=\"string\">&#x27;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#x27;</span>;</span><br><span class=\"line\">        ...</span><br><span class=\"line\">        ...</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">---</span><br><span class=\"line\">systemctl <span class=\"built_in\">enable</span> --now nginx.service</span><br><span class=\"line\">systemctl status nginx.service</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"2、keepalived-conf\"><a href=\"#2、keepalived-conf\" class=\"headerlink\" title=\"2、keepalived.conf\"></a>2、keepalived.conf</h3><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">apt -y install keepalived</span><br><span class=\"line\"><span class=\"comment\">#keepalived config</span></span><br><span class=\"line\"><span class=\"built_in\">cat</span> &gt; /etc/keepalived/keepalived.conf &lt;&lt; <span class=\"string\">&quot;EOF&quot;</span></span><br><span class=\"line\">global_defs &#123;</span><br><span class=\"line\">    notification_email &#123;</span><br><span class=\"line\">      acassen@firewall.loc</span><br><span class=\"line\">      failover@firewall.loc</span><br><span class=\"line\">      sysadmin@firewall.loc</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    notification_email_from Alexandre.Cassen@firewall.loc</span><br><span class=\"line\">    smtp_server 127.0.0.1</span><br><span class=\"line\">    smtp_connect_timeout 30 </span><br><span class=\"line\">    router_id NGINX_MASTER</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">vrrp_script check_nginx &#123;</span><br><span class=\"line\">  script <span class=\"string\">&quot;/etc/keepalived/check_nginx.sh&quot;</span></span><br><span class=\"line\">  interval 5</span><br><span class=\"line\">  weight -1</span><br><span class=\"line\">  fall 2</span><br><span class=\"line\">  rise 1</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">vrrp_instance VI_1 &#123;</span><br><span class=\"line\">    state MASTER</span><br><span class=\"line\">    interface eth0 <span class=\"comment\"># 修改为实际网卡名</span></span><br><span class=\"line\">    virtual_router_id 51 <span class=\"comment\"># VRRP 路由 ID 实例，每个实例是唯一的</span></span><br><span class=\"line\">    priority 100 <span class=\"comment\"># 优先级，备服务器设置 90</span></span><br><span class=\"line\">    advert_int 1 <span class=\"comment\"># 指定 VRRP 心跳包通告间隔时间，默认 1 秒</span></span><br><span class=\"line\">    authentication &#123;</span><br><span class=\"line\">        auth_type PASS</span><br><span class=\"line\">        auth_pass K8SHA_KA_AUTH</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"comment\"># 虚拟 IP</span></span><br><span class=\"line\">    virtual_ipaddress &#123;</span><br><span class=\"line\">        10.0.0.25/24</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    track_script &#123;</span><br><span class=\"line\">        check_nginx</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">EOF</span><br><span class=\"line\"><span class=\"comment\">#health config</span></span><br><span class=\"line\"><span class=\"built_in\">cat</span> &gt; /etc/keepalived/check_nginx.sh &lt;&lt; <span class=\"string\">&quot;EOF&quot;</span></span><br><span class=\"line\"><span class=\"comment\">#!/bin/bash </span></span><br><span class=\"line\">count=$(ps -ef |grep nginx | grep sbin | egrep -cv <span class=\"string\">&quot;grep|$$&quot;</span>) </span><br><span class=\"line\"><span class=\"keyword\">if</span> [ <span class=\"string\">&quot;<span class=\"variable\">$count</span>&quot;</span> -eq 0 ];<span class=\"keyword\">then</span> </span><br><span class=\"line\">  systemctl stop keepalived </span><br><span class=\"line\"><span class=\"keyword\">fi</span></span><br><span class=\"line\">EOF</span><br><span class=\"line\">---</span><br><span class=\"line\">systemctl <span class=\"built_in\">enable</span> --now keepalived.service</span><br><span class=\"line\">systemctl status keepalived.service</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"三、Master\"><a href=\"#三、Master\" class=\"headerlink\" title=\"三、Master\"></a>三、Master</h2><h3 id=\"1、cfssl\"><a href=\"#1、cfssl\" class=\"headerlink\" title=\"1、cfssl\"></a>1、cfssl</h3><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">wget https://github.com/cloudflare/cfssl/releases/download/v1.6.1/cfssl_1.6.1_linux_amd64 -O /usr/local/bin/cfssl</span><br><span class=\"line\">wget https://github.com/cloudflare/cfssl/releases/download/v1.6.1/cfssljson_1.6.1_linux_amd64 -O /usr/local/bin/cfssljson</span><br><span class=\"line\">wget https://github.com/cloudflare/cfssl/releases/download/v1.6.1/cfssl-certinfo_1.6.1_linux_amd64 -O /usr/local/bin/cfssl-certinfo</span><br><span class=\"line\"><span class=\"built_in\">chmod</span> +x /usr/local/bin/cfssl*</span><br><span class=\"line\"><span class=\"built_in\">chown</span> -Rf root:root /usr/local/bin/cfssl*</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"2、etcd\"><a href=\"#2、etcd\" class=\"headerlink\" title=\"2、etcd\"></a>2、etcd</h3><h4 id=\"2-1、mkdir-directory\"><a href=\"#2-1、mkdir-directory\" class=\"headerlink\" title=\"2.1、mkdir directory\"></a>2.1、mkdir directory</h4><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># all Master</span></span><br><span class=\"line\"><span class=\"comment\"># 1、etcd-ssl</span></span><br><span class=\"line\"><span class=\"built_in\">mkdir</span> -p /etc/etcd/ssl/</span><br><span class=\"line\"><span class=\"comment\"># 2、etcd-WorkingDirectory</span></span><br><span class=\"line\"><span class=\"built_in\">mkdir</span> -p /var/lib/etcd/default.etcd</span><br><span class=\"line\"><span class=\"comment\"># 3、kubernetes-ssl</span></span><br><span class=\"line\"><span class=\"built_in\">mkdir</span> -p /etc/kubernetes/ssl</span><br><span class=\"line\"><span class=\"comment\"># 4、kubernetes-log</span></span><br><span class=\"line\"><span class=\"built_in\">mkdir</span> -p /var/log/kubernetes</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"2-2、ca-certificate\"><a href=\"#2-2、ca-certificate\" class=\"headerlink\" title=\"2.2、ca certificate\"></a>2.2、ca certificate</h4><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># master00</span></span><br><span class=\"line\"><span class=\"built_in\">mkdir</span> -p ~/work</span><br><span class=\"line\"><span class=\"built_in\">cd</span> ~/work/</span><br><span class=\"line\">---</span><br><span class=\"line\"><span class=\"built_in\">cat</span> &gt; ca-csr.json &lt;&lt; <span class=\"string\">&quot;EOF&quot;</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;CN&quot;</span>: <span class=\"string\">&quot;kubernetes&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;key&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;algo&quot;</span>: <span class=\"string\">&quot;rsa&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;size&quot;</span>: 2048</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  <span class=\"string\">&quot;names&quot;</span>: [</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;C&quot;</span>: <span class=\"string\">&quot;CN&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;ST&quot;</span>: <span class=\"string\">&quot;Shanghai&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;L&quot;</span>: <span class=\"string\">&quot;Shanghai&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;O&quot;</span>: <span class=\"string\">&quot;k8s&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;OU&quot;</span>: <span class=\"string\">&quot;system&quot;</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  ]</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">EOF</span><br><span class=\"line\">---</span><br><span class=\"line\"><span class=\"built_in\">cat</span> &gt; ca-config.json &lt;&lt; <span class=\"string\">&quot;EOF&quot;</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;signing&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;default&quot;</span>: &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;expiry&quot;</span>: <span class=\"string\">&quot;87600h&quot;</span></span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    <span class=\"string\">&quot;profiles&quot;</span>: &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;kubernetes&quot;</span>: &#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;usages&quot;</span>: [</span><br><span class=\"line\">            <span class=\"string\">&quot;signing&quot;</span>,</span><br><span class=\"line\">            <span class=\"string\">&quot;key encipherment&quot;</span>,</span><br><span class=\"line\">            <span class=\"string\">&quot;server auth&quot;</span>,</span><br><span class=\"line\">            <span class=\"string\">&quot;client auth&quot;</span></span><br><span class=\"line\">        ],</span><br><span class=\"line\">        <span class=\"string\">&quot;expiry&quot;</span>: <span class=\"string\">&quot;87600h&quot;</span></span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">EOF</span><br><span class=\"line\">---</span><br><span class=\"line\">cfssl gencert -initca ca-csr.json | cfssljson -bare ca</span><br><span class=\"line\"><span class=\"built_in\">cp</span> ca*.pem /etc/etcd/ssl/</span><br><span class=\"line\">---</span><br><span class=\"line\"><span class=\"comment\"># send to other master</span></span><br><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> `<span class=\"built_in\">cat</span> ~/MasterNodes.txt`;<span class=\"keyword\">do</span> <span class=\"built_in\">echo</span> <span class=\"variable\">$i</span>;scp /etc/etcd/ssl/ca*.pem <span class=\"variable\">$i</span>:/etc/etcd/ssl;<span class=\"keyword\">done</span></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"2-3、etcd-certificate\"><a href=\"#2-3、etcd-certificate\" class=\"headerlink\" title=\"2.3、etcd certificate\"></a>2.3、etcd certificate</h4><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">cat</span> &gt; etcd-csr.json &lt;&lt; <span class=\"string\">&quot;EOF&quot;</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;CN&quot;</span>: <span class=\"string\">&quot;etcd&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;hosts&quot;</span>: [</span><br><span class=\"line\">    <span class=\"string\">&quot;127.0.0.1&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;10.0.0.20&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;10.0.0.21&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;10.0.0.22&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;10.0.0.25&quot;</span></span><br><span class=\"line\">  ],</span><br><span class=\"line\">  <span class=\"string\">&quot;key&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;algo&quot;</span>: <span class=\"string\">&quot;rsa&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;size&quot;</span>: 2048</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  <span class=\"string\">&quot;names&quot;</span>: [</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;C&quot;</span>: <span class=\"string\">&quot;CN&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;ST&quot;</span>: <span class=\"string\">&quot;Shanghai&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;L&quot;</span>: <span class=\"string\">&quot;Shanghai&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;O&quot;</span>: <span class=\"string\">&quot;k8s&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;OU&quot;</span>: <span class=\"string\">&quot;system&quot;</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  ]</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">EOF</span><br><span class=\"line\">---</span><br><span class=\"line\">cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes etcd-csr.json | cfssljson -bare etcd</span><br><span class=\"line\"><span class=\"built_in\">cp</span> etcd*.pem /etc/etcd/ssl/</span><br><span class=\"line\">---</span><br><span class=\"line\"><span class=\"comment\"># send to other</span></span><br><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> `<span class=\"built_in\">cat</span> ~/MasterNodes.txt`;<span class=\"keyword\">do</span> <span class=\"built_in\">echo</span> <span class=\"variable\">$i</span>;scp /etc/etcd/ssl/etcd*.pem <span class=\"variable\">$i</span>:/etc/etcd/ssl;<span class=\"keyword\">done</span></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"2-4、install-etcd-ctl\"><a href=\"#2-4、install-etcd-ctl\" class=\"headerlink\" title=\"2.4、install etcd{,ctl}\"></a>2.4、install etcd{,ctl}</h4><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># download etcd</span></span><br><span class=\"line\">wget https://github.com/etcd-io/etcd/releases/download/v3.5.0/etcd-v3.5.0-linux-amd64.tar.gz</span><br><span class=\"line\"><span class=\"comment\"># tar etcd-*.tar.gz</span></span><br><span class=\"line\">tar -xf etcd-v3.5.0-linux-amd64.tar.gz --strip-components=1 -C ~/work/ etcd-v3.5.0-linux-amd64/etcd&#123;,ctl&#125;</span><br><span class=\"line\"><span class=\"built_in\">chown</span> -Rf root:root etcd*</span><br><span class=\"line\"><span class=\"built_in\">cp</span> -arp etcd* /usr/local/bin/</span><br><span class=\"line\"><span class=\"comment\"># send to other</span></span><br><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> `<span class=\"built_in\">cat</span> ~/MasterNodes.txt`;<span class=\"keyword\">do</span> <span class=\"built_in\">echo</span> <span class=\"variable\">$i</span>;scp /usr/local/bin/etcd&#123;,ctl&#125; <span class=\"variable\">$i</span>:/usr/local/bin/;<span class=\"keyword\">done</span></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"2-5、etcd-conf\"><a href=\"#2-5、etcd-conf\" class=\"headerlink\" title=\"2.5、etcd.conf\"></a>2.5、etcd.conf</h4><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">cat</span> &gt; /etc/etcd/etcd.conf &lt;&lt; <span class=\"string\">&quot;EOF&quot;</span></span><br><span class=\"line\">ETCD_NAME=<span class=\"string\">&#x27;etcd1&#x27;</span></span><br><span class=\"line\">ETCD_DATA_DIR=<span class=\"string\">&quot;/var/lib/etcd/default.etcd&quot;</span></span><br><span class=\"line\">ETCD_LISTEN_PEER_URLS=<span class=\"string\">&quot;https://10.0.0.20:2380&quot;</span> <span class=\"comment\"># change ip</span></span><br><span class=\"line\">ETCD_LISTEN_CLIENT_URLS=<span class=\"string\">&quot;https://10.0.0.20:2379,http://127.0.0.1:2379&quot;</span> <span class=\"comment\"># change ip</span></span><br><span class=\"line\">ETCD_INITIAL_ADVERTISE_PEER_URLS=<span class=\"string\">&quot;https://10.0.0.20:2380&quot;</span> <span class=\"comment\"># change ip</span></span><br><span class=\"line\">ETCD_ADVERTISE_CLIENT_URLS=<span class=\"string\">&quot;https://10.0.0.20:2379&quot;</span> <span class=\"comment\"># change ip</span></span><br><span class=\"line\">ETCD_INITIAL_CLUSTER=<span class=\"string\">&quot;etcd1=https://10.0.0.20:2380,etcd2=https://10.0.0.21:2380,etcd3=https://10.0.0.22:2380&quot;</span></span><br><span class=\"line\">ETCD_INITIAL_CLUSTER_TOKEN=<span class=\"string\">&quot;etcd-cluster&quot;</span></span><br><span class=\"line\">ETCD_INITIAL_CLUSTER_STATE=<span class=\"string\">&quot;new&quot;</span></span><br><span class=\"line\">EOF</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"2-6、etcd-service\"><a href=\"#2-6、etcd-service\" class=\"headerlink\" title=\"2.6、etcd.service\"></a>2.6、etcd.service</h4><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">cat</span> &gt; /usr/lib/systemd/system/etcd.service &lt;&lt; <span class=\"string\">&quot;EOF&quot;</span></span><br><span class=\"line\">[Unit]</span><br><span class=\"line\">Description=Etcd Service</span><br><span class=\"line\">After=network.target</span><br><span class=\"line\">After=network-online.target</span><br><span class=\"line\">Wants=network-online.target</span><br><span class=\"line\"></span><br><span class=\"line\">[Service]</span><br><span class=\"line\">Type=notify</span><br><span class=\"line\">EnvironmentFile=-/etc/etcd/etcd.conf</span><br><span class=\"line\">WorkingDirectory=/var/lib/etcd/</span><br><span class=\"line\">ExecStart=/usr/local/bin/etcd \\</span><br><span class=\"line\"> --cert-file=/etc/etcd/ssl/etcd.pem \\</span><br><span class=\"line\"> --key-file=/etc/etcd/ssl/etcd-key.pem \\</span><br><span class=\"line\"> --trusted-ca-file=/etc/etcd/ssl/ca.pem \\</span><br><span class=\"line\"> --peer-cert-file=/etc/etcd/ssl/etcd.pem \\</span><br><span class=\"line\"> --peer-key-file=/etc/etcd/ssl/etcd-key.pem \\</span><br><span class=\"line\"> --peer-trusted-ca-file=/etc/etcd/ssl/ca.pem \\</span><br><span class=\"line\"> --peer-client-cert-auth \\</span><br><span class=\"line\"> --client-cert-auth</span><br><span class=\"line\">Restart=on-failure</span><br><span class=\"line\">RestartSec=10</span><br><span class=\"line\">LimitNOFILE=65536</span><br><span class=\"line\"></span><br><span class=\"line\">[Install]</span><br><span class=\"line\">WantedBy=multi-user.target</span><br><span class=\"line\">EOF</span><br><span class=\"line\">---</span><br><span class=\"line\"><span class=\"comment\"># send to other</span></span><br><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> `<span class=\"built_in\">cat</span> ~/MasterNodes.txt`;<span class=\"keyword\">do</span> <span class=\"built_in\">echo</span> <span class=\"variable\">$i</span>;scp /usr/lib/systemd/system/etcd.service <span class=\"variable\">$i</span>:/usr/lib/systemd/system/;<span class=\"keyword\">done</span></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"2-7、start-etcd-service\"><a href=\"#2-7、start-etcd-service\" class=\"headerlink\" title=\"2.7、start etcd.service\"></a>2.7、start etcd.service</h4><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 1、start etcd</span></span><br><span class=\"line\">systemctl daemon-reload</span><br><span class=\"line\">systemctl <span class=\"built_in\">enable</span> --now etcd.service</span><br><span class=\"line\">systemctl status etcd.service</span><br><span class=\"line\"><span class=\"comment\"># 2、check etcd</span></span><br><span class=\"line\">ETCDCTL_API=3</span><br><span class=\"line\">etcdctl --endpoints=https://10.0.0.20:2379,https://10.0.0.21:2379,https://10.0.0.22:2379 --write-out=table --cacert=/etc/etcd/ssl/ca.pem --cert=/etc/etcd/ssl/etcd.pem --key=/etc/etcd/ssl/etcd-key.pem endpoint health</span><br><span class=\"line\">+----------------------------+--------+-------------+-------+</span><br><span class=\"line\">|          ENDPOINT          | HEALTH |    TOOK     | ERROR |</span><br><span class=\"line\">+----------------------------+--------+-------------+-------+</span><br><span class=\"line\">| https://10.0.0.20:2379     |   <span class=\"literal\">true</span> | 16.188005ms |       |</span><br><span class=\"line\">| https://10.0.0.21:2379     |   <span class=\"literal\">true</span> | 16.693314ms |       |</span><br><span class=\"line\">| https://10.0.0.22:2379     |   <span class=\"literal\">true</span> | 16.089367ms |       |</span><br><span class=\"line\">+----------------------------+--------+-------------+-------+</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"2-8、kube-…\"><a href=\"#2-8、kube-…\" class=\"headerlink\" title=\"2.8、kube{…}\"></a>2.8、kube{…}</h4><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 1、download</span></span><br><span class=\"line\">wget https://dl.k8s.io/v1.23.5/kubernetes-server-linux-amd64.tar.gz</span><br><span class=\"line\"><span class=\"comment\"># 2、tar</span></span><br><span class=\"line\">tar -xf kubernetes-server-linux-amd64.tar.gz --strip-components=3 -C ~/work kubernetes/server/bin/kube&#123;<span class=\"built_in\">let</span>,ctl,-apiserver,-controller-manager,-scheduler,-proxy&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">scp kube&#123;ctl,-apiserver,-controller-manager,-scheduler&#125; /usr/local/bin/</span><br><span class=\"line\"><span class=\"comment\"># 3、kube&#123;let,ctl,-apiserver,-controller-manager,-scheduler,-proxy&#125;</span></span><br><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> `<span class=\"built_in\">cat</span> ~/MasterNodes.txt`;<span class=\"keyword\">do</span> <span class=\"built_in\">echo</span> <span class=\"variable\">$i</span>;scp ~/work/kube&#123;ctl,-apiserver,-controller-manager,-scheduler&#125; <span class=\"variable\">$i</span>:/usr/local/bin/;<span class=\"keyword\">done</span></span><br><span class=\"line\"><span class=\"comment\"># 4、kube&#123;let,-proxy&#125;</span></span><br><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> `<span class=\"built_in\">cat</span> ~/WorkNodes.txt`;<span class=\"keyword\">do</span> <span class=\"built_in\">echo</span> <span class=\"variable\">$i</span>;scp ~/work/kube&#123;<span class=\"built_in\">let</span>,-proxy&#125; <span class=\"variable\">$i</span>:/usr/local/bin/;<span class=\"keyword\">done</span></span><br><span class=\"line\"><span class=\"comment\"># 5、send pem</span></span><br><span class=\"line\"><span class=\"built_in\">cp</span> /etc/etcd/ssl/ca*.pem /etc/kubernetes/ssl/</span><br><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> `<span class=\"built_in\">cat</span> ~/WorkNodes.txt`;<span class=\"keyword\">do</span> <span class=\"built_in\">echo</span> <span class=\"variable\">$i</span>;scp /etc/etcd/ssl/ca*.pem <span class=\"variable\">$i</span>:/etc/kubernetes/ssl/;<span class=\"keyword\">done</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"3、kube-apiserver\"><a href=\"#3、kube-apiserver\" class=\"headerlink\" title=\"3、kube-apiserver\"></a>3、kube-apiserver</h3><h4 id=\"3-1、token-csv\"><a href=\"#3-1、token-csv\" class=\"headerlink\" title=\"3.1、token.csv\"></a>3.1、token.csv</h4><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">cat</span>  &gt; /etc/kubernetes/token.csv &lt;&lt;<span class=\"string\">EOF</span></span><br><span class=\"line\"><span class=\"string\">$(head -c 16 /dev/urandom | od -An -t x | tr -d &#x27; &#x27;),kubelet-bootstrap,10001,&quot;system:kubelet-bootstrap&quot;</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> `<span class=\"built_in\">cat</span> ~/MasterNodes.txt`;<span class=\"keyword\">do</span> <span class=\"built_in\">echo</span> <span class=\"variable\">$i</span>;scp /etc/kubernetes/token.csv <span class=\"variable\">$i</span>:/etc/kubernetes/;<span class=\"keyword\">done</span></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"3-2、kube-apiserver-certificate\"><a href=\"#3-2、kube-apiserver-certificate\" class=\"headerlink\" title=\"3.2、kube-apiserver certificate\"></a>3.2、kube-apiserver certificate</h4><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">cat</span> &gt; kube-apiserver-csr.json &lt;&lt; <span class=\"string\">&quot;EOF&quot;</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;CN&quot;</span>: <span class=\"string\">&quot;kubernetes&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;hosts&quot;</span>: [</span><br><span class=\"line\">    <span class=\"string\">&quot;127.0.0.1&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;10.0.0.20&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;10.0.0.21&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;10.0.0.22&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;10.0.0.23&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;10.0.0.24&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;10.0.0.25&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;10.96.0.1&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;kubernetes&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;kubernetes.default&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;kubernetes.default.svc&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;kubernetes.default.svc.cluster&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;kubernetes.default.svc.cluster.local&quot;</span></span><br><span class=\"line\">  ],</span><br><span class=\"line\">  <span class=\"string\">&quot;key&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;algo&quot;</span>: <span class=\"string\">&quot;rsa&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;size&quot;</span>: 2048</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  <span class=\"string\">&quot;names&quot;</span>: [</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;C&quot;</span>: <span class=\"string\">&quot;CN&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;ST&quot;</span>: <span class=\"string\">&quot;Shanghai&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;L&quot;</span>: <span class=\"string\">&quot;Shanghai&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;O&quot;</span>: <span class=\"string\">&quot;k8s&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;OU&quot;</span>: <span class=\"string\">&quot;system&quot;</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  ]</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">EOF</span><br><span class=\"line\">---</span><br><span class=\"line\">cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes kube-apiserver-csr.json | cfssljson -bare kube-apiserver</span><br><span class=\"line\"><span class=\"built_in\">cp</span> kube-apiserver*.pem /etc/kubernetes/ssl/</span><br><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> `<span class=\"built_in\">cat</span> ~/MasterNodes.txt`;<span class=\"keyword\">do</span> <span class=\"built_in\">echo</span> <span class=\"variable\">$i</span>;scp ~/work/kube-apiserver*.pem <span class=\"variable\">$i</span>:/etc/kubernetes/ssl/;<span class=\"keyword\">done</span></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"3-3、kube-apiserver-conf\"><a href=\"#3-3、kube-apiserver-conf\" class=\"headerlink\" title=\"3.3、kube-apiserver.conf\"></a>3.3、kube-apiserver.conf</h4><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># change --bind-address= and --advertise-address=</span></span><br><span class=\"line\">---</span><br><span class=\"line\"><span class=\"built_in\">cat</span> &gt; /etc/kubernetes/kube-apiserver.conf &lt;&lt; <span class=\"string\">&quot;EOF&quot;</span></span><br><span class=\"line\">KUBE_APISERVER_OPTS=<span class=\"string\">&quot;--enable-admission-plugins=NamespaceLifecycle,NodeRestriction,LimitRanger,ServiceAccount,DefaultStorageClass,ResourceQuota \\</span></span><br><span class=\"line\"><span class=\"string\"> --anonymous-auth=false \\</span></span><br><span class=\"line\"><span class=\"string\"> --bind-address=10.0.0.20 \\</span></span><br><span class=\"line\"><span class=\"string\"> --secure-port=6443 \\</span></span><br><span class=\"line\"><span class=\"string\"> --advertise-address=10.0.0.20 \\</span></span><br><span class=\"line\"><span class=\"string\"> --insecure-port=0 \\</span></span><br><span class=\"line\"><span class=\"string\"> --authorization-mode=Node,RBAC \\</span></span><br><span class=\"line\"><span class=\"string\"> --runtime-config=api/all=true \\</span></span><br><span class=\"line\"><span class=\"string\"> --enable-bootstrap-token-auth \\</span></span><br><span class=\"line\"><span class=\"string\"> --service-cluster-ip-range=10.96.0.0/16 \\</span></span><br><span class=\"line\"><span class=\"string\"> --token-auth-file=/etc/kubernetes/token.csv \\</span></span><br><span class=\"line\"><span class=\"string\"> --service-node-port-range=30000-50000 \\</span></span><br><span class=\"line\"><span class=\"string\"> --tls-cert-file=/etc/kubernetes/ssl/kube-apiserver.pem \\</span></span><br><span class=\"line\"><span class=\"string\"> --tls-private-key-file=/etc/kubernetes/ssl/kube-apiserver-key.pem \\</span></span><br><span class=\"line\"><span class=\"string\"> --client-ca-file=/etc/kubernetes/ssl/ca.pem \\</span></span><br><span class=\"line\"><span class=\"string\"> --kubelet-client-certificate=/etc/kubernetes/ssl/kube-apiserver.pem \\</span></span><br><span class=\"line\"><span class=\"string\"> --kubelet-client-key=/etc/kubernetes/ssl/kube-apiserver-key.pem \\</span></span><br><span class=\"line\"><span class=\"string\"> --service-account-key-file=/etc/kubernetes/ssl/ca-key.pem \\</span></span><br><span class=\"line\"><span class=\"string\"> --service-account-signing-key-file=/etc/kubernetes/ssl/ca-key.pem \\</span></span><br><span class=\"line\"><span class=\"string\"> --service-account-issuer=https://kubernetes.default.svc.cluster.local \\</span></span><br><span class=\"line\"><span class=\"string\"> --etcd-cafile=/etc/etcd/ssl/ca.pem \\</span></span><br><span class=\"line\"><span class=\"string\"> --etcd-certfile=/etc/etcd/ssl/etcd.pem \\</span></span><br><span class=\"line\"><span class=\"string\"> --etcd-keyfile=/etc/etcd/ssl/etcd-key.pem \\</span></span><br><span class=\"line\"><span class=\"string\"> --etcd-servers=https://10.0.0.20:2379,https://10.0.0.21:2379,https://10.0.0.22:2379 \\</span></span><br><span class=\"line\"><span class=\"string\"> --enable-swagger-ui=true \\</span></span><br><span class=\"line\"><span class=\"string\"> --allow-privileged=true \\</span></span><br><span class=\"line\"><span class=\"string\"> --apiserver-count=3 \\</span></span><br><span class=\"line\"><span class=\"string\"> --audit-log-maxage=30 \\</span></span><br><span class=\"line\"><span class=\"string\"> --audit-log-maxbackup=3 \\</span></span><br><span class=\"line\"><span class=\"string\"> --audit-log-maxsize=100 \\</span></span><br><span class=\"line\"><span class=\"string\"> --audit-log-path=/var/log/kube-apiserver-audit.log \\</span></span><br><span class=\"line\"><span class=\"string\"> --event-ttl=1h \\</span></span><br><span class=\"line\"><span class=\"string\"> --alsologtostderr=true \\</span></span><br><span class=\"line\"><span class=\"string\"> --logtostderr=false \\</span></span><br><span class=\"line\"><span class=\"string\"> --log-dir=/var/log/kubernetes \\</span></span><br><span class=\"line\"><span class=\"string\"> --v=4&quot;</span></span><br><span class=\"line\">EOF</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"3-4、kube-apiserver-service\"><a href=\"#3-4、kube-apiserver-service\" class=\"headerlink\" title=\"3.4、kube-apiserver.service\"></a>3.4、kube-apiserver.service</h4><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">cat</span> &gt; /usr/lib/systemd/system/kube-apiserver.service &lt;&lt; <span class=\"string\">&quot;EOF&quot;</span></span><br><span class=\"line\">[Unit]</span><br><span class=\"line\">Description=Kubernetes API Server</span><br><span class=\"line\">Documentation=https://github.com/kubernetes/kubernetes</span><br><span class=\"line\">After=etcd.service</span><br><span class=\"line\">Wants=etcd.service</span><br><span class=\"line\"></span><br><span class=\"line\">[Service]</span><br><span class=\"line\">EnvironmentFile=-/etc/kubernetes/kube-apiserver.conf</span><br><span class=\"line\">ExecStart=/usr/local/bin/kube-apiserver <span class=\"variable\">$KUBE_APISERVER_OPTS</span></span><br><span class=\"line\">Restart=on-failure</span><br><span class=\"line\">RestartSec=5</span><br><span class=\"line\">Type=notify</span><br><span class=\"line\">LimitNOFILE=65536</span><br><span class=\"line\"></span><br><span class=\"line\">[Install]</span><br><span class=\"line\">WantedBy=multi-user.target</span><br><span class=\"line\">EOF</span><br><span class=\"line\">---</span><br><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> `<span class=\"built_in\">cat</span> ~/MasterNodes.txt`;<span class=\"keyword\">do</span> <span class=\"built_in\">echo</span> <span class=\"variable\">$i</span>;scp /usr/lib/systemd/system/kube-apiserver.service <span class=\"variable\">$i</span>:/usr/lib/systemd/system/;<span class=\"keyword\">done</span></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"3-5、start-kube-apiserver-service\"><a href=\"#3-5、start-kube-apiserver-service\" class=\"headerlink\" title=\"3.5、start kube-apiserver.service\"></a>3.5、start kube-apiserver.service</h4><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">systemctl daemon-reload</span><br><span class=\"line\">systemctl <span class=\"built_in\">enable</span> --now kube-apiserver.service</span><br><span class=\"line\">systemctl status kube-apiserver.service</span><br><span class=\"line\">---</span><br><span class=\"line\"><span class=\"comment\"># check</span></span><br><span class=\"line\">curl --insecure https://10.0.0.20:6443</span><br><span class=\"line\">---</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;kind&quot;</span>: <span class=\"string\">&quot;Status&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;apiVersion&quot;</span>: <span class=\"string\">&quot;v1&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;metadata&quot;</span>: &#123;&#125;,</span><br><span class=\"line\">  <span class=\"string\">&quot;status&quot;</span>: <span class=\"string\">&quot;Failure&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;message&quot;</span>: <span class=\"string\">&quot;Unauthorized&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;reason&quot;</span>: <span class=\"string\">&quot;Unauthorized&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;code&quot;</span>: 401</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"4、kubectl\"><a href=\"#4、kubectl\" class=\"headerlink\" title=\"4、kubectl\"></a>4、kubectl</h3><h4 id=\"4-1、admin-certificate\"><a href=\"#4-1、admin-certificate\" class=\"headerlink\" title=\"4.1、admin certificate\"></a>4.1、admin certificate</h4><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">cat</span> &gt; admin-csr.json &lt;&lt; <span class=\"string\">&quot;EOF&quot;</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;CN&quot;</span>: <span class=\"string\">&quot;admin&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;hosts&quot;</span>: [],</span><br><span class=\"line\">  <span class=\"string\">&quot;key&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;algo&quot;</span>: <span class=\"string\">&quot;rsa&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;size&quot;</span>: 2048</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  <span class=\"string\">&quot;names&quot;</span>: [</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;C&quot;</span>: <span class=\"string\">&quot;CN&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;ST&quot;</span>: <span class=\"string\">&quot;Shanghai&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;L&quot;</span>: <span class=\"string\">&quot;Shanghai&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;O&quot;</span>: <span class=\"string\">&quot;system:masters&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;OU&quot;</span>: <span class=\"string\">&quot;system&quot;</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  ]</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">EOF</span><br><span class=\"line\">---</span><br><span class=\"line\">cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes admin-csr.json | cfssljson -bare admin</span><br><span class=\"line\"><span class=\"built_in\">cp</span> admin*.pem /etc/kubernetes/ssl/</span><br><span class=\"line\">---</span><br><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> `<span class=\"built_in\">cat</span> ~/MasterNodes.txt`;<span class=\"keyword\">do</span> <span class=\"built_in\">echo</span> <span class=\"variable\">$i</span>;scp /etc/kubernetes/ssl/admin*.pem <span class=\"variable\">$i</span>:/etc/kubernetes/ssl/;<span class=\"keyword\">done</span> </span><br></pre></td></tr></table></figure>\n\n<h4 id=\"4-2、admin-config\"><a href=\"#4-2、admin-config\" class=\"headerlink\" title=\"4.2、admin.config\"></a>4.2、admin.config</h4><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 1、设置集群参数</span></span><br><span class=\"line\">kubectl config set-cluster kubernetes --certificate-authority=ca.pem --embed-certs=<span class=\"literal\">true</span> --server=https://10.0.0.25:6444 --kubeconfig=admin.config</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 2、设置客户端认证参数</span></span><br><span class=\"line\">kubectl config set-credentials kubernetes-admin --client-certificate=admin.pem --client-key=admin-key.pem --embed-certs=<span class=\"literal\">true</span> --kubeconfig=admin.config</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 3、设置上下文参数</span></span><br><span class=\"line\">kubectl config set-context kubernetes --cluster=kubernetes --user=kubernetes-admin --kubeconfig=admin.config</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 4、设置当前上下文</span></span><br><span class=\"line\">kubectl config use-context kubernetes --kubeconfig=admin.config</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"4-3、kubernetes-kubelet-api\"><a href=\"#4-3、kubernetes-kubelet-api\" class=\"headerlink\" title=\"4.3、kubernetes-kubelet api\"></a>4.3、kubernetes-kubelet api</h4><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl create clusterrolebinding kube-apiserver:kubelet-apiserver --clusterrole=system.kubelet-api-admin --user kubernetes</span><br><span class=\"line\">kubectl create clusterrolebinding kubernetes --clusterrole=cluster-admin --user=kubernetes</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"4-4、send-to-other\"><a href=\"#4-4、send-to-other\" class=\"headerlink\" title=\"4.4、send to other\"></a>4.4、send to other</h4><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">cp</span> ~/work/admin.config /etc/kubernetes</span><br><span class=\"line\"><span class=\"built_in\">mkdir</span> -p <span class=\"variable\">$HOME</span>/.kube</span><br><span class=\"line\"><span class=\"built_in\">cp</span> -i /etc/kubernetes/admin.config <span class=\"variable\">$HOME</span>/.kube/config</span><br><span class=\"line\"><span class=\"built_in\">chown</span> $(<span class=\"built_in\">id</span> -u):$(<span class=\"built_in\">id</span> -g) <span class=\"variable\">$HOME</span>/.kube/config</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> `<span class=\"built_in\">cat</span> ~/MasterNodes.txt`;<span class=\"keyword\">do</span> <span class=\"built_in\">echo</span> <span class=\"variable\">$i</span>;scp /etc/kubernetes/admin.config <span class=\"variable\">$i</span>:/etc/kubernetes/;<span class=\"keyword\">done</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;export KUBECONFIG=/etc/kubernetes/admin.config&quot;</span> &gt;&gt; /etc/profile</span><br><span class=\"line\"><span class=\"built_in\">source</span> /etc/profile</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"4-5、kubectl-bash-completion\"><a href=\"#4-5、kubectl-bash-completion\" class=\"headerlink\" title=\"4.5、kubectl(bash-completion)\"></a>4.5、kubectl(bash-completion)</h4><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">source</span> &lt;(kubectl completion bash)</span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;source &lt;(kubectl completion bash)&quot;</span> &gt;&gt; /etc/profile</span><br><span class=\"line\"><span class=\"built_in\">source</span> /etc/profile</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"4-6、verify-kubectl\"><a href=\"#4-6、verify-kubectl\" class=\"headerlink\" title=\"4.6、verify kubectl\"></a>4.6、verify kubectl</h4><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl cluster-info</span><br><span class=\"line\">---</span><br><span class=\"line\">&#123;Kubernetes control plane is running at https://10.0.0.20:6443&#125;</span><br><span class=\"line\">---</span><br><span class=\"line\">kubectl get componentstatuses</span><br><span class=\"line\">---</span><br><span class=\"line\">NAME                 STATUS      MESSAGE                                                                                        ERROR</span><br><span class=\"line\">scheduler            Unhealthy   Get <span class=\"string\">&quot;https://127.0.0.1:10259/healthz&quot;</span>: dial tcp 127.0.0.1:10259: connect: connection refused   </span><br><span class=\"line\">controller-manager   Unhealthy   Get <span class=\"string\">&quot;https://127.0.0.1:10257/healthz&quot;</span>: dial tcp 127.0.0.1:10257: connect: connection refused   </span><br><span class=\"line\">etcd-0               Healthy     &#123;<span class=\"string\">&quot;health&quot;</span>:<span class=\"string\">&quot;true&quot;</span>,<span class=\"string\">&quot;reason&quot;</span>:<span class=\"string\">&quot;&quot;</span>&#125;                                           </span><br><span class=\"line\">etcd-1               Healthy     &#123;<span class=\"string\">&quot;health&quot;</span>:<span class=\"string\">&quot;true&quot;</span>,<span class=\"string\">&quot;reason&quot;</span>:<span class=\"string\">&quot;&quot;</span>&#125;                                           </span><br><span class=\"line\">etcd-2               Healthy     &#123;<span class=\"string\">&quot;health&quot;</span>:<span class=\"string\">&quot;true&quot;</span>,<span class=\"string\">&quot;reason&quot;</span>:<span class=\"string\">&quot;&quot;</span>&#125;                                           </span><br><span class=\"line\">---</span><br><span class=\"line\">kubectl get all --all-namespaces</span><br><span class=\"line\">---</span><br><span class=\"line\">NAMESPACE   NAME                 TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE</span><br><span class=\"line\">default     service/kubernetes   ClusterIP   10.96.0.1   &lt;none&gt;        443/TCP   56m</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"5、kube-controller-manager\"><a href=\"#5、kube-controller-manager\" class=\"headerlink\" title=\"5、kube-controller-manager\"></a>5、kube-controller-manager</h3><h4 id=\"5-1、kube-controller-manager-certificate\"><a href=\"#5-1、kube-controller-manager-certificate\" class=\"headerlink\" title=\"5.1、kube-controller-manager certificate\"></a>5.1、kube-controller-manager certificate</h4><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">cat</span> &gt; kube-controller-manager-csr.json &lt;&lt; <span class=\"string\">&quot;EOF&quot;</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;CN&quot;</span>: <span class=\"string\">&quot;system:kube-controller-manager&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;hosts&quot;</span>: [</span><br><span class=\"line\">    <span class=\"string\">&quot;127.0.0.1&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;10.0.0.20&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;10.0.0.21&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;10.0.0.22&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;10.0.0.25&quot;</span></span><br><span class=\"line\">  ],</span><br><span class=\"line\">  <span class=\"string\">&quot;key&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;algo&quot;</span>: <span class=\"string\">&quot;rsa&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;size&quot;</span>: 2048</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  <span class=\"string\">&quot;names&quot;</span>: [</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;C&quot;</span>: <span class=\"string\">&quot;CN&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;ST&quot;</span>: <span class=\"string\">&quot;Shanghai&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;L&quot;</span>: <span class=\"string\">&quot;Shanghai&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;O&quot;</span>: <span class=\"string\">&quot;system:kube-controller-manager&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;OU&quot;</span>: <span class=\"string\">&quot;Kubernetes&quot;</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  ]</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">EOF</span><br><span class=\"line\">---</span><br><span class=\"line\">cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes kube-controller-manager-csr.json | cfssljson -bare kube-controller-manager</span><br><span class=\"line\"><span class=\"built_in\">cp</span> kube-controller-manager*.pem /etc/kubernetes/ssl/</span><br><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> `<span class=\"built_in\">cat</span> ~/MasterNodes.txt`;<span class=\"keyword\">do</span> <span class=\"built_in\">echo</span> <span class=\"variable\">$i</span>;scp /etc/kubernetes/ssl/kube-controller-manager*.pem <span class=\"variable\">$i</span>:/etc/kubernetes/ssl/;<span class=\"keyword\">done</span></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"5-2、kube-controller-manager-kubeconfig\"><a href=\"#5-2、kube-controller-manager-kubeconfig\" class=\"headerlink\" title=\"5.2、kube-controller-manager.kubeconfig\"></a>5.2、kube-controller-manager.kubeconfig</h4><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 1、设置集群参数</span></span><br><span class=\"line\">kubectl config set-cluster kubernetes --certificate-authority=ca.pem --embed-certs=<span class=\"literal\">true</span> --server=https://10.0.0.25:6444 --kubeconfig=/etc/kubernetes/kube-controller-manager.kubeconfig</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 2、设置客户端认证参数</span></span><br><span class=\"line\">kubectl config set-credentials system:kube-controller-manager --client-certificate=kube-controller-manager.pem --client-key=kube-controller-manager-key.pem --embed-certs=<span class=\"literal\">true</span> --kubeconfig=/etc/kubernetes/kube-controller-manager.kubeconfig</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 3、设置上下文参数</span></span><br><span class=\"line\">kubectl config set-context system:kube-controller-manager --cluster=kubernetes --user=system:kube-controller-manager --kubeconfig=/etc/kubernetes/kube-controller-manager.kubeconfig</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 4、设置当前上下文</span></span><br><span class=\"line\">kubectl config use-context system:kube-controller-manager --kubeconfig=/etc/kubernetes/kube-controller-manager.kubeconfig</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"5-3、kube-controller-manager-conf\"><a href=\"#5-3、kube-controller-manager-conf\" class=\"headerlink\" title=\"5.3、kube-controller-manager.conf\"></a>5.3、kube-controller-manager.conf</h4><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">cat</span> &gt; /etc/kubernetes/kube-controller-manager.conf &lt;&lt; <span class=\"string\">&quot;EOF&quot;</span></span><br><span class=\"line\">KUBE_CONTROLLER_MANAGER_OPTS=<span class=\"string\">&quot;--v=2 \\</span></span><br><span class=\"line\"><span class=\"string\">  --secure-port=10257 \\</span></span><br><span class=\"line\"><span class=\"string\">  --bind-address=127.0.0.1 \\</span></span><br><span class=\"line\"><span class=\"string\">  --kubeconfig=/etc/kubernetes/kube-controller-manager.kubeconfig \\</span></span><br><span class=\"line\"><span class=\"string\">  --service-cluster-ip-range=10.96.0.0/16 \\</span></span><br><span class=\"line\"><span class=\"string\">  --cluster-name=kubernetes \\</span></span><br><span class=\"line\"><span class=\"string\">  --cluster-signing-cert-file=/etc/kubernetes/ssl/ca.pem \\</span></span><br><span class=\"line\"><span class=\"string\">  --cluster-signing-key-file=/etc/kubernetes/ssl/ca-key.pem \\</span></span><br><span class=\"line\"><span class=\"string\">  --allocate-node-cidrs=true \\</span></span><br><span class=\"line\"><span class=\"string\">  --cluster-cidr=10.244.0.0/16 \\</span></span><br><span class=\"line\"><span class=\"string\">  --experimental-cluster-signing-duration=87600h \\</span></span><br><span class=\"line\"><span class=\"string\">  --root-ca-file=/etc/kubernetes/ssl/ca.pem \\</span></span><br><span class=\"line\"><span class=\"string\">  --service-account-private-key-file=/etc/kubernetes/ssl/ca-key.pem \\</span></span><br><span class=\"line\"><span class=\"string\">  --leader-elect=true \\</span></span><br><span class=\"line\"><span class=\"string\">  --feature-gates=RotateKubeletServerCertificate=true \\</span></span><br><span class=\"line\"><span class=\"string\">  --controllers=*,bootstrapsigner,tokencleaner \\</span></span><br><span class=\"line\"><span class=\"string\">  --horizontal-pod-autoscaler-sync-period=10s \\</span></span><br><span class=\"line\"><span class=\"string\">  --tls-cert-file=/etc/kubernetes/ssl/kube-controller-manager.pem \\</span></span><br><span class=\"line\"><span class=\"string\">  --tls-private-key-file=/etc/kubernetes/ssl/kube-controller-manager-key.pem \\</span></span><br><span class=\"line\"><span class=\"string\">  --use-service-account-credentials=true&quot;</span></span><br><span class=\"line\">EOF</span><br><span class=\"line\">  ---</span><br><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> `<span class=\"built_in\">cat</span> ~/MasterNodes.txt`;<span class=\"keyword\">do</span> <span class=\"built_in\">echo</span> <span class=\"variable\">$i</span>;scp /etc/kubernetes/kube-controller-manager* <span class=\"variable\">$i</span>:/etc/kubernetes/;<span class=\"keyword\">done</span></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"5-4、kube-controller-manager-service\"><a href=\"#5-4、kube-controller-manager-service\" class=\"headerlink\" title=\"5.4、kube-controller-manager.service\"></a>5.4、kube-controller-manager.service</h4><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">cat</span> &gt; /usr/lib/systemd/system/kube-controller-manager.service &lt;&lt; <span class=\"string\">&quot;EOF&quot;</span></span><br><span class=\"line\">[Unit]</span><br><span class=\"line\">Description=Kubernetes Controller Manager</span><br><span class=\"line\">Documentation=https://github.com/kubernetes/kubernetes</span><br><span class=\"line\"></span><br><span class=\"line\">[Service]</span><br><span class=\"line\">EnvironmentFile=-/etc/kubernetes/kube-controller-manager.conf</span><br><span class=\"line\">ExecStart=/usr/local/bin/kube-controller-manager <span class=\"variable\">$KUBE_CONTROLLER_MANAGER_OPTS</span></span><br><span class=\"line\">Restart=on-failure</span><br><span class=\"line\">RestartSec=5</span><br><span class=\"line\"></span><br><span class=\"line\">[Install]</span><br><span class=\"line\">WantedBy=multi-user.target</span><br><span class=\"line\">EOF</span><br><span class=\"line\">---</span><br><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> `<span class=\"built_in\">cat</span> ~/MasterNodes.txt`;<span class=\"keyword\">do</span> <span class=\"built_in\">echo</span> <span class=\"variable\">$i</span>;scp /usr/lib/systemd/system/kube-controller-manager.service <span class=\"variable\">$i</span>:/usr/lib/systemd/system/;<span class=\"keyword\">done</span></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"5-5、start-kube-controller-manager-service\"><a href=\"#5-5、start-kube-controller-manager-service\" class=\"headerlink\" title=\"5.5、start kube-controller-manager.service\"></a>5.5、start kube-controller-manager.service</h4><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">systemctl daemon-reload</span><br><span class=\"line\">systemctl <span class=\"built_in\">enable</span> --now kube-controller-manager.service</span><br><span class=\"line\">systemctl status kube-controller-manager.service</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"6、kube-scheduler\"><a href=\"#6、kube-scheduler\" class=\"headerlink\" title=\"6、kube-scheduler\"></a>6、kube-scheduler</h3><h4 id=\"6-1、kube-scheduler-certificate\"><a href=\"#6-1、kube-scheduler-certificate\" class=\"headerlink\" title=\"6.1、kube-scheduler certificate\"></a>6.1、kube-scheduler certificate</h4><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">cat</span> &gt; kube-scheduler-csr.json &lt;&lt; <span class=\"string\">&quot;EOF&quot;</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;CN&quot;</span>: <span class=\"string\">&quot;system:kube-scheduler&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;hosts&quot;</span>: [</span><br><span class=\"line\">    <span class=\"string\">&quot;127.0.0.1&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;10.0.0.20&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;10.0.0.21&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;10.0.0.22&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;10.0.0.25&quot;</span></span><br><span class=\"line\">  ],</span><br><span class=\"line\">  <span class=\"string\">&quot;key&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;algo&quot;</span>: <span class=\"string\">&quot;rsa&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;size&quot;</span>: 2048</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  <span class=\"string\">&quot;names&quot;</span>: [</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;C&quot;</span>: <span class=\"string\">&quot;CN&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;ST&quot;</span>: <span class=\"string\">&quot;Shanghai&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;L&quot;</span>: <span class=\"string\">&quot;Shanghai&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;O&quot;</span>: <span class=\"string\">&quot;system:kube-scheduler&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;OU&quot;</span>: <span class=\"string\">&quot;system&quot;</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  ]</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">EOF</span><br><span class=\"line\">---</span><br><span class=\"line\">cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes kube-scheduler-csr.json | cfssljson -bare kube-scheduler</span><br><span class=\"line\"><span class=\"built_in\">cp</span> kube-scheduler*.pem /etc/kubernetes/ssl/</span><br><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> `<span class=\"built_in\">cat</span> ~/MasterNodes.txt`;<span class=\"keyword\">do</span> <span class=\"built_in\">echo</span> <span class=\"variable\">$i</span>;scp /etc/kubernetes/ssl/kube-scheduler*.pem <span class=\"variable\">$i</span>:/etc/kubernetes/ssl/;<span class=\"keyword\">done</span></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"6-2、kube-scheduler-kubeconfig\"><a href=\"#6-2、kube-scheduler-kubeconfig\" class=\"headerlink\" title=\"6.2、kube-scheduler.kubeconfig\"></a>6.2、kube-scheduler.kubeconfig</h4><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 1、设置集群参数</span></span><br><span class=\"line\">kubectl config set-cluster kubernetes --certificate-authority=ca.pem --embed-certs=<span class=\"literal\">true</span> --server=https://10.0.0.25:6444 --kubeconfig=/etc/kubernetes/kube-scheduler.kubeconfig</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 2、设置客户端认证参数</span></span><br><span class=\"line\">kubectl config set-credentials system:kube-scheduler --client-certificate=kube-scheduler.pem --client-key=kube-scheduler-key.pem --embed-certs=<span class=\"literal\">true</span> --kubeconfig=/etc/kubernetes/kube-scheduler.kubeconfig</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 3、设置上下文参数</span></span><br><span class=\"line\">kubectl config set-context system:kube-scheduler --cluster=kubernetes --user=system:kube-scheduler --kubeconfig=/etc/kubernetes/kube-scheduler.kubeconfig</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 4、设置当前上下文</span></span><br><span class=\"line\">kubectl config use-context system:kube-scheduler --kubeconfig=/etc/kubernetes/kube-scheduler.kubeconfig</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"6-3、kube-scheduler-conf\"><a href=\"#6-3、kube-scheduler-conf\" class=\"headerlink\" title=\"6.3、kube-scheduler.conf\"></a>6.3、kube-scheduler.conf</h4><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">cat</span> &gt; /etc/kubernetes/kube-scheduler.conf &lt;&lt; <span class=\"string\">&quot;EOF&quot;</span></span><br><span class=\"line\">KUBE_SCHEDULER_OPTS=<span class=\"string\">&quot;--address=127.0.0.1 \\</span></span><br><span class=\"line\"><span class=\"string\">  --kubeconfig=/etc/kubernetes/kube-scheduler.kubeconfig \\</span></span><br><span class=\"line\"><span class=\"string\">  --leader-elect=true \\</span></span><br><span class=\"line\"><span class=\"string\">  --alsologtostderr=true \\</span></span><br><span class=\"line\"><span class=\"string\">  --logtostderr=false \\</span></span><br><span class=\"line\"><span class=\"string\">  --log-dir=/var/log/kubernetes \\</span></span><br><span class=\"line\"><span class=\"string\">  --v=2&quot;</span></span><br><span class=\"line\">EOF</span><br><span class=\"line\">---</span><br><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> `<span class=\"built_in\">cat</span> ~/MasterNodes.txt`;<span class=\"keyword\">do</span> <span class=\"built_in\">echo</span> <span class=\"variable\">$i</span>;scp /etc/kubernetes/kube-scheduler* <span class=\"variable\">$i</span>:/etc/kubernetes/;<span class=\"keyword\">done</span></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"6-4、kube-scheduler-service\"><a href=\"#6-4、kube-scheduler-service\" class=\"headerlink\" title=\"6.4、kube-scheduler.service\"></a>6.4、kube-scheduler.service</h4><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">cat</span> &gt; /usr/lib/systemd/system/kube-scheduler.service &lt;&lt; <span class=\"string\">&quot;EOF&quot;</span></span><br><span class=\"line\">[Unit]</span><br><span class=\"line\">Description=Kubernetes Scheduler</span><br><span class=\"line\">Documentation=https://github.com/kubernetes/kubernetes</span><br><span class=\"line\"></span><br><span class=\"line\">[Service]</span><br><span class=\"line\">EnvironmentFile=-/etc/kubernetes/kube-scheduler.conf</span><br><span class=\"line\">ExecStart=/usr/local/bin/kube-scheduler <span class=\"variable\">$KUBE_SCHEDULER_OPTS</span></span><br><span class=\"line\">Restart=on-failure</span><br><span class=\"line\">RestartSec=5</span><br><span class=\"line\"></span><br><span class=\"line\">[Install]</span><br><span class=\"line\">WantedBy=multi-user.target</span><br><span class=\"line\">EOF</span><br><span class=\"line\">---</span><br><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> `<span class=\"built_in\">cat</span> ~/MasterNodes.txt`;<span class=\"keyword\">do</span> <span class=\"built_in\">echo</span> <span class=\"variable\">$i</span>;scp /usr/lib/systemd/system/kube-scheduler.service <span class=\"variable\">$i</span>:/usr/lib/systemd/system/;<span class=\"keyword\">done</span></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"6-5、start-kube-scheduler-service\"><a href=\"#6-5、start-kube-scheduler-service\" class=\"headerlink\" title=\"6.5、start kube-scheduler.service\"></a>6.5、start kube-scheduler.service</h4><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">systemctl daemon-reload</span><br><span class=\"line\">systemctl <span class=\"built_in\">enable</span> --now kube-scheduler.service</span><br><span class=\"line\">systemctl status kube-scheduler.service</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"四、Node\"><a href=\"#四、Node\" class=\"headerlink\" title=\"四、Node\"></a>四、Node</h2><h3 id=\"1、kubelet\"><a href=\"#1、kubelet\" class=\"headerlink\" title=\"1、kubelet\"></a>1、kubelet</h3><h4 id=\"1-1、BOOTSTRAP-TOKEN\"><a href=\"#1-1、BOOTSTRAP-TOKEN\" class=\"headerlink\" title=\"1.1、BOOTSTRAP_TOKEN\"></a>1.1、BOOTSTRAP_TOKEN</h4><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">BOOTSTRAP_TOKEN=$(awk -F <span class=\"string\">&quot;,&quot;</span> <span class=\"string\">&#x27;&#123;print $1&#125;&#x27;</span> /etc/kubernetes/token.csv)</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"1-2、kubelet-bootstrap-kubeconfig\"><a href=\"#1-2、kubelet-bootstrap-kubeconfig\" class=\"headerlink\" title=\"1.2、kubelet-bootstrap.kubeconfig\"></a>1.2、kubelet-bootstrap.kubeconfig</h4><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 1、设置集群参数</span></span><br><span class=\"line\">kubectl config set-cluster kubernetes --certificate-authority=ca.pem --embed-certs=<span class=\"literal\">true</span> --server=https://10.0.0.25:6444 --kubeconfig=/root/work/kubelet-bootstrap.kubeconfig</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 2、设置客户端认证参数</span></span><br><span class=\"line\">kubectl config set-credentials kubelet-bootstrap --token=<span class=\"variable\">$&#123;BOOTSTRAP_TOKEN&#125;</span> --kubeconfig=/root/work/kubelet-bootstrap.kubeconfig</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 3、设置上下文参数</span></span><br><span class=\"line\">kubectl config set-context default --cluster=kubernetes --user=kubelet-bootstrap --kubeconfig=/root/work/kubelet-bootstrap.kubeconfig</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 4、设置当前上下文</span></span><br><span class=\"line\">kubectl config use-context default --kubeconfig=/root/work/kubelet-bootstrap.kubeconfig</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 5、创建clusterrolebinding</span></span><br><span class=\"line\">kubectl delete clusterrolebinding kubelet-bootstrap</span><br><span class=\"line\">kubectl create clusterrolebinding kubelet-bootstrap --clusterrole=system:node-bootstrapper --user=kubelet-bootstrap</span><br><span class=\"line\">kubectl create clusterrolebinding cluster-system-anonymous --clusterrole=cluster-admin --user=kubelet-bootstrap</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"1-3、kubelet-json\"><a href=\"#1-3、kubelet-json\" class=\"headerlink\" title=\"1.3、kubelet.json\"></a>1.3、kubelet.json</h4><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">cat</span> &gt; ~/work/kubelet.json &lt;&lt; <span class=\"string\">&quot;EOF&quot;</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\"> <span class=\"string\">&quot;kind&quot;</span>: <span class=\"string\">&quot;KubeletConfiguration&quot;</span>,</span><br><span class=\"line\"> <span class=\"string\">&quot;apiVersion&quot;</span>: <span class=\"string\">&quot;kubelet.config.k8s.io/v1beta1&quot;</span>,</span><br><span class=\"line\"> <span class=\"string\">&quot;authentication&quot;</span>: &#123;</span><br><span class=\"line\">   <span class=\"string\">&quot;x509&quot;</span>: &#123;</span><br><span class=\"line\">     <span class=\"string\">&quot;clientCAFile&quot;</span>: <span class=\"string\">&quot;/etc/kubernetes/ssl/ca.pem&quot;</span></span><br><span class=\"line\">   &#125;,</span><br><span class=\"line\">   <span class=\"string\">&quot;webhook&quot;</span>: &#123;</span><br><span class=\"line\">     <span class=\"string\">&quot;enabled&quot;</span>: <span class=\"literal\">true</span>,</span><br><span class=\"line\">     <span class=\"string\">&quot;cacheTTL&quot;</span>: <span class=\"string\">&quot;2m0s&quot;</span></span><br><span class=\"line\">   &#125;,</span><br><span class=\"line\">   <span class=\"string\">&quot;anonymous&quot;</span>: &#123;</span><br><span class=\"line\">     <span class=\"string\">&quot;enabled&quot;</span>: <span class=\"literal\">false</span></span><br><span class=\"line\">   &#125;</span><br><span class=\"line\"> &#125;,</span><br><span class=\"line\"> <span class=\"string\">&quot;authorization&quot;</span>: &#123;</span><br><span class=\"line\">   <span class=\"string\">&quot;mode&quot;</span>: <span class=\"string\">&quot;Webhook&quot;</span>,</span><br><span class=\"line\">   <span class=\"string\">&quot;webhook&quot;</span>: &#123;</span><br><span class=\"line\">     <span class=\"string\">&quot;cacheAuthorizedTTL&quot;</span>: <span class=\"string\">&quot;5m0s&quot;</span>,</span><br><span class=\"line\">     <span class=\"string\">&quot;cacheUnauthorizedTTL&quot;</span>: <span class=\"string\">&quot;30s&quot;</span></span><br><span class=\"line\">   &#125;</span><br><span class=\"line\"> &#125;,</span><br><span class=\"line\"> <span class=\"string\">&quot;address&quot;</span>: <span class=\"string\">&quot;10.0.0.23&quot;</span>,</span><br><span class=\"line\"> <span class=\"string\">&quot;port&quot;</span>: 10250,</span><br><span class=\"line\"> <span class=\"string\">&quot;readOnlyPort&quot;</span>: 10255,</span><br><span class=\"line\"> <span class=\"string\">&quot;cgroupDriver&quot;</span>: <span class=\"string\">&quot;systemd&quot;</span>,</span><br><span class=\"line\"> <span class=\"string\">&quot;hairpinMode&quot;</span>: <span class=\"string\">&quot;promiscuous-bridge&quot;</span>,</span><br><span class=\"line\"> <span class=\"string\">&quot;serializeImagePulls&quot;</span>: <span class=\"literal\">false</span>,</span><br><span class=\"line\"> <span class=\"string\">&quot;clusterDomain&quot;</span>: <span class=\"string\">&quot;cluster.local.&quot;</span>,</span><br><span class=\"line\"> <span class=\"string\">&quot;clusterDNS&quot;</span>: [<span class=\"string\">&quot;10.96.0.2&quot;</span>]</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">EOF</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"1-4、kubelet-service\"><a href=\"#1-4、kubelet-service\" class=\"headerlink\" title=\"1.4、kubelet.service\"></a>1.4、kubelet.service</h4><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">cat</span> &gt; ~/work/kubelet.service &lt;&lt;<span class=\"string\">&quot;EOF&quot;</span></span><br><span class=\"line\">[Unit]</span><br><span class=\"line\">Description=Kubernetes Kubelet</span><br><span class=\"line\">Documentation=https://github.com/kubernetes/kubernetes</span><br><span class=\"line\">After=containerd.service</span><br><span class=\"line\">Requires=containerd.service</span><br><span class=\"line\"></span><br><span class=\"line\">[Service]</span><br><span class=\"line\">WorkingDirectory=/var/lib/kubelet</span><br><span class=\"line\">ExecStart=/usr/local/bin/kubelet \\</span><br><span class=\"line\"> --container-runtime=remote \\</span><br><span class=\"line\"> --container-runtime-endpoint=unix:///run/containerd/containerd.sock</span><br><span class=\"line\"> --bootstrap-kubeconfig=/etc/kubernetes/kubelet-bootstrap.kubeconfig \\</span><br><span class=\"line\"> --cert-dir=/etc/kubernetes/ssl \\</span><br><span class=\"line\"> --kubeconfig=/etc/kubernetes/kubelet.kubeconfig \\</span><br><span class=\"line\"> --config=/etc/kubernetes/kubelet.json \\</span><br><span class=\"line\"> --pod-infra-container-image=registry.aliyuncs.com/google_containers/pause:3.2 \\</span><br><span class=\"line\"> --v=2</span><br><span class=\"line\">Restart=on-failure</span><br><span class=\"line\">RestartSec=5</span><br><span class=\"line\"></span><br><span class=\"line\">[Install]</span><br><span class=\"line\">WantedBy=multi-user.target</span><br><span class=\"line\">EOF</span><br><span class=\"line\">---</span><br><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> `<span class=\"built_in\">cat</span> ~/WorkNodes.txt`;<span class=\"keyword\">do</span> <span class=\"built_in\">echo</span> <span class=\"variable\">$i</span>;scp ~/work/kubelet.json ~/work/kubelet-bootstrap.kubeconfig <span class=\"variable\">$i</span>:/etc/kubernetes;<span class=\"keyword\">done</span></span><br><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> `<span class=\"built_in\">cat</span> ~/WorkNodes.txt`;<span class=\"keyword\">do</span> <span class=\"built_in\">echo</span> <span class=\"variable\">$i</span>;scp ~/work/kubelet.service <span class=\"variable\">$i</span>:/usr/lib/systemd/system;<span class=\"keyword\">done</span></span><br><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> `<span class=\"built_in\">cat</span> ~/WorkNodes.txt`;<span class=\"keyword\">do</span> <span class=\"built_in\">echo</span> <span class=\"variable\">$i</span>;scp /etc/kubernetes/ssl/ca.pem <span class=\"variable\">$i</span>:/etc/kubernetes/ssl/;<span class=\"keyword\">done</span></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"1-5、start-kubelet-services\"><a href=\"#1-5、start-kubelet-services\" class=\"headerlink\" title=\"1.5、start kubelet.services\"></a>1.5、start kubelet.services</h4><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">mkdir</span> -p /var/lib/kubelet</span><br><span class=\"line\">systemctl daemon-reload</span><br><span class=\"line\">systemctl <span class=\"built_in\">enable</span> --now kubelet.service</span><br><span class=\"line\">systemctl status kubelet.service</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"1-6、Approve-Nodes\"><a href=\"#1-6、Approve-Nodes\" class=\"headerlink\" title=\"1.6、Approve Nodes\"></a>1.6、Approve Nodes</h4><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl get csr |grep node |awk <span class=\"string\">&#x27;&#123;print$1,$6&#125;&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">&quot;+---                                                  |     ---+&quot;</span></span><br><span class=\"line\">  node-csr-BV7RZ1Mc1RFkWhH9jzJH8h8on_dRMB3an_7FgBUwWhk   Pending</span><br><span class=\"line\">  node-csr-wZOI__ACKylv7DlEPRK8iMg3_sYyBErjbGjxkMkRyPo   Pending</span><br><span class=\"line\"><span class=\"string\">&quot;+---                                                  |     ---+&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\">kubectl certificate approve node-csr-csr-BV7RZ1Mc1RFkWhH9jzJH8h8on_dRMB3an_7FgBUwWhk node-csr-wZOI__ACKylv7DlEPRK8iMg3_sYyBErjbGjxkMkRyPo</span><br><span class=\"line\"></span><br><span class=\"line\">kubectl get nodes</span><br><span class=\"line\">NAME         STATUS   ROLES    AGE    VERSION</span><br><span class=\"line\">k8s-node01   Ready    &lt;none&gt;   118m   v1.23.5</span><br><span class=\"line\">k8s-node02   Ready    &lt;none&gt;   118m   v1.23.5</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"2、kube-pproxy\"><a href=\"#2、kube-pproxy\" class=\"headerlink\" title=\"2、kube-pproxy\"></a>2、kube-pproxy</h3><h4 id=\"2-1、kube-proxy-certificate\"><a href=\"#2-1、kube-proxy-certificate\" class=\"headerlink\" title=\"2.1、kube-proxy certificate\"></a>2.1、kube-proxy certificate</h4><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">cat</span> &gt; kube-proxy-csr.json &lt;&lt; <span class=\"string\">&quot;EOF&quot;</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;CN&quot;</span>: <span class=\"string\">&quot;system:kube-proxy&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;key&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;algo&quot;</span>: <span class=\"string\">&quot;rsa&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;size&quot;</span>: 2048</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  <span class=\"string\">&quot;names&quot;</span>: [</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;C&quot;</span>: <span class=\"string\">&quot;CN&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;ST&quot;</span>: <span class=\"string\">&quot;Shanghai&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;L&quot;</span>: <span class=\"string\">&quot;Shanghai&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;O&quot;</span>: <span class=\"string\">&quot;k8s&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;OU&quot;</span>: <span class=\"string\">&quot;system&quot;</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  ]</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">EOF</span><br><span class=\"line\">---</span><br><span class=\"line\">cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes kube-proxy-csr.json | cfssljson -bare kube-proxy</span><br><span class=\"line\"><span class=\"built_in\">cp</span> kube-proxy*.pem /etc/kubernetes/ssl/</span><br><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> `<span class=\"built_in\">cat</span> ~/WorkNodes.txt`;<span class=\"keyword\">do</span> <span class=\"built_in\">echo</span> <span class=\"variable\">$i</span>;scp ~/work/kube-proxy*.pem <span class=\"variable\">$i</span>:/etc/kubernetes/ssl/;<span class=\"keyword\">done</span></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"2-2、kube-proxy-kubeconfig\"><a href=\"#2-2、kube-proxy-kubeconfig\" class=\"headerlink\" title=\"2.2、kube-proxy.kubeconfig\"></a>2.2、kube-proxy.kubeconfig</h4><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 1、设置集群参数</span></span><br><span class=\"line\">kubectl config set-cluster kubernetes --certificate-authority=ca.pem --embed-certs=<span class=\"literal\">true</span> --server=https://10.0.0.25:6444 --kubeconfig=/root/work/kube-proxy.kubeconfig</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 2、设置客户端认证参数</span></span><br><span class=\"line\">kubectl config set-credentials kube-proxy --client-certificate=kube-proxy.pem --client-key=kube-proxy-key.pem --embed-certs=<span class=\"literal\">true</span> --kubeconfig=/root/work/kube-proxy.kubeconfig</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 3、设置上下文参数</span></span><br><span class=\"line\">kubectl config set-context default --cluster=kubernetes --user=kube-proxy --kubeconfig=/root/work/kube-proxy.kubeconfig</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 4、设置当前上下文</span></span><br><span class=\"line\">kubectl config use-context default --kubeconfig=/root/work/kube-proxy.kubeconfig</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"2-3、kube-proxy-yaml\"><a href=\"#2-3、kube-proxy-yaml\" class=\"headerlink\" title=\"2.3、kube-proxy.yaml\"></a>2.3、kube-proxy.yaml</h4><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 以下bindAddress均为宿主机ip,clusterCIDR为宿主机网段</span></span><br><span class=\"line\">---</span><br><span class=\"line\"><span class=\"built_in\">cat</span> &gt; ~/work/kube-proxy.yaml &lt;&lt; <span class=\"string\">&quot;EOF&quot;</span></span><br><span class=\"line\">apiVersion: kubeproxy.config.k8s.io/v1alpha1</span><br><span class=\"line\">bindAddress: 10.0.0.23</span><br><span class=\"line\">clientConnection:</span><br><span class=\"line\">  kubeconfig: /etc/kubernetes/kube-proxy.kubeconfig</span><br><span class=\"line\">clusterCIDR: 10.244.0.0/24</span><br><span class=\"line\">healthzBindAddress: 10.0.0.23:10256</span><br><span class=\"line\">kind: KubeProxyConfiguration</span><br><span class=\"line\">metricsBindAddress: 10.0.0.23:10249</span><br><span class=\"line\">mode: <span class=\"string\">&quot;ipvs&quot;</span></span><br><span class=\"line\">EOF</span><br><span class=\"line\">---</span><br><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> `<span class=\"built_in\">cat</span> ~/WorkNodes.txt`;<span class=\"keyword\">do</span> <span class=\"built_in\">echo</span> <span class=\"variable\">$i</span>;scp ~/work/kube-proxy.yaml ~/work/kube-proxy.kubeconfig <span class=\"variable\">$i</span>:/etc/kubernetes/;<span class=\"keyword\">done</span></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"2-4、kube-proxy-service\"><a href=\"#2-4、kube-proxy-service\" class=\"headerlink\" title=\"2.4、kube-proxy.service\"></a>2.4、kube-proxy.service</h4><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">cat</span> &gt; ~/work/kube-proxy.service &lt;&lt; <span class=\"string\">&quot;EOF&quot;</span></span><br><span class=\"line\">[Unit]</span><br><span class=\"line\">Description=Kubernetes Kube-Proxy Server</span><br><span class=\"line\">Documentation=https://github.com/kubernetes/kubernetes</span><br><span class=\"line\">After=network.target</span><br><span class=\"line\"></span><br><span class=\"line\">[Service]</span><br><span class=\"line\">WorkingDirectory=/var/lib/kube-proxy</span><br><span class=\"line\">ExecStart=/usr/local/bin/kube-proxy \\</span><br><span class=\"line\"> --config=/etc/kubernetes/kube-proxy.yaml \\</span><br><span class=\"line\"> --alsologtostderr=<span class=\"literal\">true</span> \\</span><br><span class=\"line\"> --logtostderr=<span class=\"literal\">false</span> \\</span><br><span class=\"line\"> --log-dir=/var/log/kubernetes \\</span><br><span class=\"line\"> --v=2</span><br><span class=\"line\">Restart=on-failure</span><br><span class=\"line\">RestartSec=5</span><br><span class=\"line\">LimitNOFILE=65536</span><br><span class=\"line\"></span><br><span class=\"line\">[Install]</span><br><span class=\"line\">WantedBy=multi-user.target</span><br><span class=\"line\">EOF</span><br><span class=\"line\">---</span><br><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> `<span class=\"built_in\">cat</span> ~/WorkNodes.txt`;<span class=\"keyword\">do</span> <span class=\"built_in\">echo</span> <span class=\"variable\">$i</span>;scp ~/work/kube-proxy.service <span class=\"variable\">$i</span>:/usr/lib/systemd/system;<span class=\"keyword\">done</span></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"2-5、start-kube-proxy-services\"><a href=\"#2-5、start-kube-proxy-services\" class=\"headerlink\" title=\"2.5、start kube-proxy.services\"></a>2.5、start kube-proxy.services</h4><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">mkdir</span> -p /var/lib/kube-proxy</span><br><span class=\"line\">systemctl daemon-reload</span><br><span class=\"line\">systemctl <span class=\"built_in\">enable</span> --now kube-proxy.service</span><br><span class=\"line\">systemctl status kube-proxy.service</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"五、network\"><a href=\"#五、network\" class=\"headerlink\" title=\"五、network\"></a>五、network</h2><h3 id=\"1、calico\"><a href=\"#1、calico\" class=\"headerlink\" title=\"1、calico\"></a>1、calico</h3><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">wget https://docs.projectcalico.org/manifests/calico.yaml</span><br><span class=\"line\">kubectl apply -f calico.yaml</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"2、coredns\"><a href=\"#2、coredns\" class=\"headerlink\" title=\"2、coredns\"></a>2、coredns</h3><h4 id=\"2-1、resolv-conf\"><a href=\"#2-1、resolv-conf\" class=\"headerlink\" title=\"2.1、resolv.conf\"></a>2.1、resolv.conf</h4><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">mv</span> /etc/resolv.conf  /etc/resolv.conf.bak</span><br><span class=\"line\"><span class=\"built_in\">ln</span> -s /run/systemd/resolve/resolv.conf /etc/</span><br><span class=\"line\">systemctl restart systemd-resolved.service &amp;&amp; systemctl <span class=\"built_in\">enable</span> systemd-resolved.service</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"2-2、coredns-yaml\"><a href=\"#2-2、coredns-yaml\" class=\"headerlink\" title=\"2.2、coredns.yaml\"></a>2.2、coredns.yaml</h4><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br><span class=\"line\">185</span><br><span class=\"line\">186</span><br><span class=\"line\">187</span><br><span class=\"line\">188</span><br><span class=\"line\">189</span><br><span class=\"line\">190</span><br><span class=\"line\">191</span><br><span class=\"line\">192</span><br><span class=\"line\">193</span><br><span class=\"line\">194</span><br><span class=\"line\">195</span><br><span class=\"line\">196</span><br><span class=\"line\">197</span><br><span class=\"line\">198</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">kind: ServiceAccount</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: coredns</span><br><span class=\"line\">  namespace: kube-system</span><br><span class=\"line\">---</span><br><span class=\"line\">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class=\"line\">kind: ClusterRole</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    kubernetes.io/bootstrapping: rbac-defaults</span><br><span class=\"line\">  name: system:coredns</span><br><span class=\"line\">rules:</span><br><span class=\"line\">  - apiGroups:</span><br><span class=\"line\">    - <span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\">    resources:</span><br><span class=\"line\">    - endpoints</span><br><span class=\"line\">    - services</span><br><span class=\"line\">    - pods</span><br><span class=\"line\">    - namespaces</span><br><span class=\"line\">    verbs:</span><br><span class=\"line\">    - list</span><br><span class=\"line\">    - watch</span><br><span class=\"line\">  - apiGroups:</span><br><span class=\"line\">    - discovery.k8s.io</span><br><span class=\"line\">    resources:</span><br><span class=\"line\">    - endpointslices</span><br><span class=\"line\">    verbs:</span><br><span class=\"line\">    - list</span><br><span class=\"line\">    - watch</span><br><span class=\"line\">---</span><br><span class=\"line\">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class=\"line\">kind: ClusterRoleBinding</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  annotations:</span><br><span class=\"line\">    rbac.authorization.kubernetes.io/autoupdate: <span class=\"string\">&quot;true&quot;</span></span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    kubernetes.io/bootstrapping: rbac-defaults</span><br><span class=\"line\">  name: system:coredns</span><br><span class=\"line\">roleRef:</span><br><span class=\"line\">  apiGroup: rbac.authorization.k8s.io</span><br><span class=\"line\">  kind: ClusterRole</span><br><span class=\"line\">  name: system:coredns</span><br><span class=\"line\">subjects:</span><br><span class=\"line\">- kind: ServiceAccount</span><br><span class=\"line\">  name: coredns</span><br><span class=\"line\">  namespace: kube-system</span><br><span class=\"line\">---</span><br><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">kind: ConfigMap</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: coredns</span><br><span class=\"line\">  namespace: kube-system</span><br><span class=\"line\">data:</span><br><span class=\"line\">  Corefile: |</span><br><span class=\"line\">    .:53 &#123;</span><br><span class=\"line\">        errors</span><br><span class=\"line\">        health &#123;</span><br><span class=\"line\">          lameduck 5s</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        ready</span><br><span class=\"line\">        kubernetes cluster.local in-addr.arpa ip6.arpa &#123;</span><br><span class=\"line\">          fallthrough in-addr.arpa ip6.arpa</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        prometheus :9153</span><br><span class=\"line\">        forward . /etc/resolv.conf &#123;</span><br><span class=\"line\">          max_concurrent 1000</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        cache 30</span><br><span class=\"line\">        loop</span><br><span class=\"line\">        reload</span><br><span class=\"line\">        loadbalance</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">---</span><br><span class=\"line\">apiVersion: apps/v1</span><br><span class=\"line\">kind: Deployment</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: coredns</span><br><span class=\"line\">  namespace: kube-system</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    k8s-app: kube-dns</span><br><span class=\"line\">    kubernetes.io/name: <span class=\"string\">&quot;CoreDNS&quot;</span></span><br><span class=\"line\">spec:</span><br><span class=\"line\">  <span class=\"comment\"># replicas: not specified here:</span></span><br><span class=\"line\">  <span class=\"comment\"># 1. Default is 1.</span></span><br><span class=\"line\">  <span class=\"comment\"># 2. Will be tuned in real time if DNS horizontal auto-scaling is turned on.</span></span><br><span class=\"line\">  strategy:</span><br><span class=\"line\">    <span class=\"built_in\">type</span>: RollingUpdate</span><br><span class=\"line\">    rollingUpdate:</span><br><span class=\"line\">      maxUnavailable: 1</span><br><span class=\"line\">  selector:</span><br><span class=\"line\">    matchLabels:</span><br><span class=\"line\">      k8s-app: kube-dns</span><br><span class=\"line\">  template:</span><br><span class=\"line\">    metadata:</span><br><span class=\"line\">      labels:</span><br><span class=\"line\">        k8s-app: kube-dns</span><br><span class=\"line\">    spec:</span><br><span class=\"line\">      priorityClassName: system-cluster-critical</span><br><span class=\"line\">      serviceAccountName: coredns</span><br><span class=\"line\">      tolerations:</span><br><span class=\"line\">        - key: <span class=\"string\">&quot;CriticalAddonsOnly&quot;</span></span><br><span class=\"line\">          operator: <span class=\"string\">&quot;Exists&quot;</span></span><br><span class=\"line\">      nodeSelector:</span><br><span class=\"line\">        kubernetes.io/os: linux</span><br><span class=\"line\">      affinity:</span><br><span class=\"line\">         podAntiAffinity:</span><br><span class=\"line\">           preferredDuringSchedulingIgnoredDuringExecution:</span><br><span class=\"line\">           - weight: 100</span><br><span class=\"line\">             podAffinityTerm:</span><br><span class=\"line\">               labelSelector:</span><br><span class=\"line\">                 matchExpressions:</span><br><span class=\"line\">                   - key: k8s-app</span><br><span class=\"line\">                     operator: In</span><br><span class=\"line\">                     values: [<span class=\"string\">&quot;kube-dns&quot;</span>]</span><br><span class=\"line\">               topologyKey: kubernetes.io/hostname</span><br><span class=\"line\">      containers:</span><br><span class=\"line\">      - name: coredns</span><br><span class=\"line\">        image: coredns/coredns:1.8.4</span><br><span class=\"line\">        imagePullPolicy: IfNotPresent</span><br><span class=\"line\">        resources:</span><br><span class=\"line\">          limits:</span><br><span class=\"line\">            memory: 170Mi</span><br><span class=\"line\">          requests:</span><br><span class=\"line\">            cpu: 100m</span><br><span class=\"line\">            memory: 70Mi</span><br><span class=\"line\">        args: [ <span class=\"string\">&quot;-conf&quot;</span>, <span class=\"string\">&quot;/etc/coredns/Corefile&quot;</span> ]</span><br><span class=\"line\">        volumeMounts:</span><br><span class=\"line\">        - name: config-volume</span><br><span class=\"line\">          mountPath: /etc/coredns</span><br><span class=\"line\">          readOnly: <span class=\"literal\">true</span></span><br><span class=\"line\">        ports:</span><br><span class=\"line\">        - containerPort: 53</span><br><span class=\"line\">          name: dns</span><br><span class=\"line\">          protocol: UDP</span><br><span class=\"line\">        - containerPort: 53</span><br><span class=\"line\">          name: dns-tcp</span><br><span class=\"line\">          protocol: TCP</span><br><span class=\"line\">        - containerPort: 9153</span><br><span class=\"line\">          name: metrics</span><br><span class=\"line\">          protocol: TCP</span><br><span class=\"line\">        securityContext:</span><br><span class=\"line\">          allowPrivilegeEscalation: <span class=\"literal\">false</span></span><br><span class=\"line\">          capabilities:</span><br><span class=\"line\">            add:</span><br><span class=\"line\">            - NET_BIND_SERVICE</span><br><span class=\"line\">            drop:</span><br><span class=\"line\">            - all</span><br><span class=\"line\">          readOnlyRootFilesystem: <span class=\"literal\">true</span></span><br><span class=\"line\">        livenessProbe:</span><br><span class=\"line\">          httpGet:</span><br><span class=\"line\">            path: /health</span><br><span class=\"line\">            port: 8080</span><br><span class=\"line\">            scheme: HTTP</span><br><span class=\"line\">          initialDelaySeconds: 60</span><br><span class=\"line\">          timeoutSeconds: 5</span><br><span class=\"line\">          successThreshold: 1</span><br><span class=\"line\">          failureThreshold: 5</span><br><span class=\"line\">        readinessProbe:</span><br><span class=\"line\">          httpGet:</span><br><span class=\"line\">            path: /ready</span><br><span class=\"line\">            port: 8181</span><br><span class=\"line\">            scheme: HTTP</span><br><span class=\"line\">      dnsPolicy: Default</span><br><span class=\"line\">      volumes:</span><br><span class=\"line\">        - name: config-volume</span><br><span class=\"line\">          configMap:</span><br><span class=\"line\">            name: coredns</span><br><span class=\"line\">            items:</span><br><span class=\"line\">            - key: Corefile</span><br><span class=\"line\">              path: Corefile</span><br><span class=\"line\">---</span><br><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">kind: Service</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: kube-dns</span><br><span class=\"line\">  namespace: kube-system</span><br><span class=\"line\">  annotations:</span><br><span class=\"line\">    prometheus.io/port: <span class=\"string\">&quot;9153&quot;</span></span><br><span class=\"line\">    prometheus.io/scrape: <span class=\"string\">&quot;true&quot;</span></span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    k8s-app: kube-dns</span><br><span class=\"line\">    kubernetes.io/cluster-service: <span class=\"string\">&quot;true&quot;</span></span><br><span class=\"line\">    kubernetes.io/name: <span class=\"string\">&quot;CoreDNS&quot;</span></span><br><span class=\"line\">spec:</span><br><span class=\"line\">  selector:</span><br><span class=\"line\">    k8s-app: kube-dns</span><br><span class=\"line\">  clusterIP: 10.96.0.2</span><br><span class=\"line\">  ports:</span><br><span class=\"line\">  - name: dns</span><br><span class=\"line\">    port: 53</span><br><span class=\"line\">    protocol: UDP</span><br><span class=\"line\">  - name: dns-tcp</span><br><span class=\"line\">    port: 53</span><br><span class=\"line\">    protocol: TCP</span><br><span class=\"line\">  - name: metrics</span><br><span class=\"line\">    port: 9153</span><br><span class=\"line\">    protocol: TCP</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"2-3、install\"><a href=\"#2-3、install\" class=\"headerlink\" title=\"2.3、install\"></a>2.3、install</h4><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl apply -f coredns.yaml</span><br></pre></td></tr></table></figure>"}],"PostAsset":[],"PostCategory":[],"PostTag":[{"post_id":"cl21d0www0001vqjx8tq9306q","tag_id":"cl21d0wx10003vqjxg903ay8h","_id":"cl21d0wx40004vqjxe0vnaqs2"}],"Tag":[{"name":"kubernetes","_id":"cl21d0wx10003vqjxg903ay8h"}]}}